<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>加入主畫面｜孫子兵法背誦系統</title>

  <meta name="theme-color" content="#0f1410" />
  <style>
    :root{
      --bg:#0f1410;
      --panel:#151b16;
      --line:#2b3a2f;
      --ink:#e9efe9;
      --muted:#aab6aa;
      --gold:#d6b25e;
      --ok:#9be79f;
      --warn:#ffd27a;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{ max-width:760px; margin:0 auto; padding:18px 14px 26px; }
    h1{ font-size:20px; margin:8px 0 8px; }
    .muted{ color:var(--muted); line-height:1.7; }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 14px;
      margin:12px 0;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      display:inline-block;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:transparent;
      color:var(--ink);
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
    }
    .btnPrimary{
      border-color: rgba(214,178,94,.7);
      box-shadow: 0 0 14px rgba(214,178,94,.22);
    }
    .tag{
      display:inline-block;
      padding:2px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      margin-left:6px;
      color:var(--muted);
      font-size:12px;
    }
    .steps{ line-height:1.85; }
    .hint{ color:var(--warn); line-height:1.7; font-weight:700; }
    .ok{ color:var(--ok); font-weight:900; }
    .bar{
      height:10px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      margin-top:10px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background:rgba(214,178,94,.55);
      transition: width .1s linear;
    }
    .small{ font-size:13px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>把兵書放到主畫面（像 App 一樣）</h1>
    <div class="muted">
      為了方便每日快速開啟，建議加入主畫面。此頁會在 <b>2 秒</b>後自動進入兵書；若想先完成安裝，請依下方指引操作。
    </div>

    <div class="card">
      <div class="muted">
        自動進入倒數：<b id="countTxt">2</b> 秒 <span class="tag" id="platformTag">偵測中</span>
      </div>
      <div class="bar" aria-hidden="true"><div id="barFill"></div></div>

      <div style="height:12px"></div>
      <div class="row">
        <a class="btn btnPrimary" href="./index.html" id="goNow">我不要安裝，直接進入</a>
        <button class="btn" id="stopBtn">先別自動跳轉</button>
      </div>
      <div style="height:8px"></div>
      <div class="muted small">提醒：若您在 Line/FB 內建瀏覽器開啟，安裝功能可能不顯示，建議改用 Safari（iPhone）或 Chrome（Android）。</div>
    </div>

    <!-- Android -->
    <div class="card" id="androidBox" style="display:none;">
      <div class="muted">偵測到 <b>Android</b><span class="tag">可一鍵安裝</span></div>
      <div style="height:10px"></div>
      <div class="row">
        <button class="btn btnPrimary" id="installBtn" disabled>安裝到主畫面</button>
        <a class="btn" href="./index.html">稍後再說，先進入</a>
      </div>
      <div style="height:10px"></div>
      <div class="hint small" id="androidHint">
        若按鈕尚未可用：請用 <b>Chrome</b> 開啟，或點右上角 <b>⋮</b> 選單 →「安裝應用程式／加入主畫面」。
      </div>
      <div style="height:6px"></div>
      <div class="muted small">安裝完成後：回主畫面點圖示即可快速開啟（<span class="ok">像 App 一樣</span>）。</div>
    </div>

    <!-- iOS -->
    <div class="card" id="iosBox" style="display:none;">
      <div class="muted">偵測到 <b>iPhone / iPad</b><span class="tag">需手動加入</span></div>
      <div style="height:10px"></div>
      <div class="steps">
        (1) 請用 <b>Safari</b> 開啟本頁（很重要）<br>
        (2) 點 <b>分享</b>（方框＋上箭頭）<br>
        (3) 點 <b>加入主畫面</b><br>
        (4) 完成後回主畫面點圖示開啟（<span class="ok">像 App 一樣</span>）
      </div>
      <div style="height:12px"></div>
      <div class="row">
        <a class="btn btnPrimary" href="./index.html">我已看懂，進入兵書</a>
      </div>
      <div style="height:8px"></div>
      <div class="hint small">若您目前不是 Safari（例如 Line 內建瀏覽器），請改用 Safari 開啟才會看到「加入主畫面」。</div>
    </div>

    <!-- Others -->
    <div class="card" id="otherBox" style="display:none;">
      <div class="muted">若非 iOS/Android，請直接進入兵書：</div>
      <div style="height:12px"></div>
      <a class="btn btnPrimary" href="./index.html">進入兵書</a>
    </div>
  </div>

  <script>
    // 平台偵測（務實版）
    const ua = navigator.userAgent || "";
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isAndroid = /Android/i.test(ua);

    const platformTag = document.getElementById("platformTag");
    const iosBox = document.getElementById("iosBox");
    const androidBox = document.getElementById("androidBox");
    const otherBox = document.getElementById("otherBox");

    if (isIOS) {
      platformTag.textContent = "iPhone/iPad";
      iosBox.style.display = "block";
    } else if (isAndroid) {
      platformTag.textContent = "Android";
      androidBox.style.display = "block";
    } else {
      platformTag.textContent = "其他裝置";
      otherBox.style.display = "block";
    }

    // 2 秒導流（但允許中止）
    let seconds = 2;
    const countTxt = document.getElementById("countTxt");
    const barFill = document.getElementById("barFill");
    const stopBtn = document.getElementById("stopBtn");

    let stopped = false;
    stopBtn.addEventListener("click", () => {
      stopped = true;
      stopBtn.textContent = "已停止自動跳轉";
      stopBtn.disabled = true;
    });

    const totalMs = 2000;
    const start = Date.now();
    const timer = setInterval(() => {
      if (stopped) { clearInterval(timer); return; }

      const elapsed = Date.now() - start;
      const progress = Math.min(100, Math.round((elapsed / totalMs) * 100));
      barFill.style.width = progress + "%";

      const remainMs = Math.max(0, totalMs - elapsed);
      seconds = Math.ceil(remainMs / 1000);
      countTxt.textContent = seconds;

      if (elapsed >= totalMs) {
        clearInterval(timer);
        location.href = "./index.html";
      }
    }, 80);

    // Android 一鍵安裝（可用則啟用按鈕）
    let deferredPrompt = null;
    const installBtn = document.getElementById("installBtn");
    const androidHint = document.getElementById("androidHint");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (installBtn) {
        installBtn.disabled = false;
        androidHint.textContent = "請按「安裝到主畫面」即可完成。";
      }
    });

    installBtn?.addEventListener("click", async () => {
      if (!deferredPrompt) {
        androidHint.textContent = "若沒有跳出安裝視窗：請用 Chrome 開啟，或點右上角⋮選單→「安裝應用程式／加入主畫面」。";
        return;
      }
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.disabled = true;
      androidHint.textContent = "若已安裝成功，請回到主畫面點圖示開啟。";
    });
  </script>
</body>
</html>
