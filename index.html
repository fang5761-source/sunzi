<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å­«å­å…µæ³•ãƒ»èƒŒèª¦æ¼”ç·´ v1</title>
  <style>
    :root{
      --bg:#0b0f0c;
      --panel:#121812;
      --panel2:#0f1510;
      --line:#5b4d2a;
      --gold:#d7b65a;
      --gold2:#b8953b;
      --text:#e8e4d6;
      --muted:#9a9484;
      --good:#2e7d32;
      --bad:#b71c1c;
      --shadow: rgba(0,0,0,.45);

      --hintGlow: rgba(255, 214, 102, .85); /* å‘¼å¸ç‡ˆæ›´äº® */
      --hintGlow2: rgba(255, 214, 102, .35);
      --hintPulseScale: 1.06;
      --fontScale: 1; /* å¯èª¿å­—é«”å¤§å° */
    }

    *{box-sizing:border-box;}
    body{
      margin:0; padding:0;
      font-family: "Microsoft JhengHei", "PingFang TC", "Noto Serif CJK TC", serif;
      background: radial-gradient(1200px 700px at 30% -10%, rgba(215,182,90,.18), transparent 55%),
                  radial-gradient(900px 600px at 100% 20%, rgba(80,120,90,.18), transparent 55%),
                  linear-gradient(180deg, #070a08, var(--bg));
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }

    /* å¤–æ¡†ï¼šæ‰‹æ©Ÿä¸æ»¾å‹•ï¼Œå…§å®¹ç”¨å…§éƒ¨å€å¡Šç®¡ç† */
    .app{
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:10px;
      max-width:560px;
      margin:0 auto;
    }

    /* ====== ä¸Šæ–¹ç‹€æ…‹åˆ— ====== */
    .topbar{
      background: linear-gradient(180deg, rgba(18,24,18,.92), rgba(10,14,11,.92));
      border: 1px solid rgba(215,182,90,.35);
      border-radius:18px;
      padding:10px 10px 8px 10px;
      box-shadow: 0 10px 20px var(--shadow);
      position:relative;
    }
    .toprow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .rank{
      background: rgba(215,182,90,.12);
      border:1px solid rgba(215,182,90,.35);
      color:var(--gold);
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:1px;
      font-size:14px;
      white-space:nowrap;
    }
    .stage{
      color:var(--muted);
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1;
      min-width:120px;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px;
      border-radius:50%;
      background:#2ecc71;
      box-shadow:0 0 12px rgba(46,204,113,.7);
      flex:0 0 auto;
    }

    .tools{
      margin-left:auto;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .iconbtn{
      width:44px; height:40px;
      border-radius:14px;
      border:1px solid rgba(215,182,90,.25);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      position:relative;
    }
    .iconbtn:active{ transform:scale(.98); }

    .progress{
      margin-top:8px;
      height:6px;
      background: rgba(255,255,255,.08);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(215,182,90,.9), rgba(215,182,90,.35));
      transition: width .25s ease;
    }

    /* ====== å­«æ­¦å°è©± ====== */
    .npc{
      background: linear-gradient(180deg, rgba(18,24,18,.88), rgba(10,14,11,.88));
      border: 1px solid rgba(215,182,90,.25);
      border-radius:18px;
      padding:10px;
      box-shadow: 0 10px 20px var(--shadow);
      display:flex;
      gap:10px;
      align-items:flex-start;
      position:relative;
    }
    .npc-badge{
      width:52px; height:52px;
      border-radius:16px;
      background: rgba(215,182,90,.12);
      border:1px solid rgba(215,182,90,.35);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; color:var(--gold);
      flex:0 0 auto;
    }
    .npc-text{
      flex:1;
      min-width:0;
      font-size: calc(15px * var(--fontScale));
      line-height: 1.35;
      color: var(--text);
      padding-right:44px; /* ç•™å±•é–‹éˆ•ç©ºé–“ */
    }
    .npc-text.clamp{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .npc-toggle{
      position:absolute;
      top:10px; right:10px;
      width:40px; height:36px;
      border-radius:12px;
      border:1px solid rgba(215,182,90,.25);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
      color:var(--gold);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .npc-toggle:active{ transform:scale(.98); }

    /* ====== ä½ˆä»¤æ¿ ====== */
    .board{
      flex:1;
      min-height:0;
      background: linear-gradient(180deg, rgba(18,24,18,.86), rgba(10,14,11,.86));
      border: 1px solid rgba(215,182,90,.25);
      border-radius:18px;
      padding:10px;
      box-shadow: 0 10px 20px var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .board-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .board-title{
      color:var(--gold);
      font-weight:900;
      letter-spacing:2px;
      font-size:14px;
    }
    .board-line{
      flex:1;
      height:2px;
      background: linear-gradient(90deg, rgba(215,182,90,.4), transparent);
      border-radius:999px;
    }
    .board-body{
      flex:1;
      min-height:0;
      border:1px dashed rgba(215,182,90,.25);
      border-radius:16px;
      padding:10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-content:flex-start;
      justify-content:flex-start;
      background: radial-gradient(700px 300px at 50% 0%, rgba(215,182,90,.06), transparent 60%);
    }
    .board-hint{
      width:100%;
      color:rgba(232,228,214,.35);
      text-align:center;
      margin-top:18px;
      font-weight:800;
      letter-spacing:1px;
      font-size:13px;
    }

    /* ====== åº•éƒ¨æŒ‰éˆ• + ä»¤ç‰Œå€ ====== */
    .actions{
      background: linear-gradient(180deg, rgba(18,24,18,.86), rgba(10,14,11,.86));
      border: 1px solid rgba(215,182,90,.25);
      border-radius:18px;
      padding:10px;
      box-shadow: 0 10px 20px var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .btnrow{
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      border:none;
      border-radius:16px;
      padding:12px 10px;
      font-weight:900;
      letter-spacing:1px;
      font-size:15px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      color:var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .btn:active{ transform:scale(.99); }
    .btn.bad{ border-color: rgba(183,28,28,.35); background: rgba(183,28,28,.10); }
    .btn.good{ border-color: rgba(46,125,50,.35); background: rgba(46,125,50,.12); }
    .btn.gold{ border-color: rgba(215,182,90,.35); background: rgba(215,182,90,.10); color:var(--gold); }

    .tokenzone{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .tokenhead{
      display:flex; align-items:center; justify-content:space-between;
      color:var(--muted);
      font-size:13px;
      font-weight:800;
    }
    .tokens{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-start;
    }

    /* ====== ä»¤ç‰Œï¼ˆè©çµ„ï¼‰ ====== */
    .token{
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(215,182,90,.25);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-weight:900;
      font-size: calc(16px * var(--fontScale));
      letter-spacing:1px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      min-width: 92px;
      text-align:center;
    }
    .token:active{ transform:scale(.98); }

    /* å­¸ç¿’æç¤ºï¼ˆå‘¼å¸ç‡ˆï¼‰æ›´äº® */
    .token.hint{
      border-color: rgba(255,214,102,.9);
      box-shadow:
        0 0 0 2px rgba(255,214,102,.18),
        0 0 18px var(--hintGlow),
        0 0 34px var(--hintGlow2);
      animation: hintPulse 1.1s ease-in-out infinite;
      background: linear-gradient(180deg, rgba(255,214,102,.18), rgba(0,0,0,.12));
      color: #fff5d6;
    }
    @keyframes hintPulse{
      0%{ transform:scale(1); filter:brightness(1); }
      50%{ transform:scale(var(--hintPulseScale)); filter:brightness(1.15); }
      100%{ transform:scale(1); filter:brightness(1); }
    }

    /* é©—ä»¤é€šéå¾Œï¼šå…µæ›¸æŒ‰éˆ•çŸ­æš«å‘¼å¸ */
    .iconbtn.pulse{
      animation: btnPulse 1.2s ease-in-out infinite;
      border-color: rgba(255,214,102,.75);
      box-shadow: 0 0 18px rgba(255,214,102,.35);
    }
    @keyframes btnPulse{
      0%{ transform:scale(1); }
      50%{ transform:scale(1.05); }
      100%{ transform:scale(1); }
    }

    /* ====== Modal ====== */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.82);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:999;
    }
    .card{
      width:min(520px, 100%);
      border-radius:18px;
      border:1px solid rgba(215,182,90,.28);
      background: linear-gradient(180deg, rgba(16,22,16,.98), rgba(8,12,9,.98)); /* ä¸é€æ˜ */
      box-shadow: 0 20px 40px rgba(0,0,0,.6);
      overflow:hidden;
      position:relative;
    }
    .cardhead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .tag.good{ border-color: rgba(46,125,50,.35); color:#cfe9d2; background: rgba(46,125,50,.14); }
    .tag.gold{ border-color: rgba(215,182,90,.35); color:#fff0c4; background: rgba(215,182,90,.12); }

    .close{
      width:42px; height:38px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .close:active{ transform:scale(.98); }

    .cardbody{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      max-height: 72vh;
      overflow:auto;
    }
    .section{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
    }
    .section h3{
      margin:0 0 8px 0;
      color:var(--gold);
      font-size:14px;
      letter-spacing:2px;
    }
    .orig{
      font-size: calc(18px * var(--fontScale));
      line-height:1.6;
      font-weight:900;
      color: var(--text);
      letter-spacing:1px;
    }
    .plain{
      margin-top:8px;
      font-size: calc(14px * var(--fontScale));
      line-height:1.65;
      color: rgba(232,228,214,.88);
    }
    .cardfoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
    }

    /* æ ¡é–±å½ˆçª—ï¼šé¸é … */
    .segGrid{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .choice{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(215,182,90,.22);
      background: rgba(255,255,255,.04);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      color:var(--text);
      min-width: 92px;
      text-align:center;
    }
    .choice:active{ transform:scale(.98); }
    .choice.right{ border-color: rgba(46,125,50,.45); background: rgba(46,125,50,.14); }
    .choice.wrong{ border-color: rgba(183,28,28,.45); background: rgba(183,28,28,.14); }

    .smallmuted{ color:var(--muted); font-size:13px; font-weight:800; line-height:1.35; }

    /* å°è¢å¹•å¾®èª¿ */
    @media (max-width: 390px){
      .token{ min-width: 86px; padding:11px 12px; }
      .rank{ font-size:13px; }
      .btn{ font-size:14px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="toprow">
        <div class="rank" id="rankTag">æ–°å…µ</div>
        <div class="stage" id="stageText">å§‹è¨ˆç¯‡ï½œæ¼”ç·´ 1</div>

        <div class="pill" id="statusPill"><span class="dot"></span><span id="statusText">ç›®å‰ç„¡éŒ¯å­—</span></div>

        <div class="pill" id="hintPill">å­¸ç¿’æç¤ºï¼š<b id="hintState" style="color:var(--gold)">é–‹</b></div>

        <div class="tools">
          <div class="iconbtn" id="settingsBtn" title="è¨­å®š">âš™</div>
          <div class="iconbtn" id="scrollBtn" title="å…µæ›¸">ğŸ“œ</div>
        </div>
      </div>
      <div class="progress"><div id="progressFill"></div></div>
    </div>

    <!-- NPC -->
    <div class="npc">
      <div class="npc-badge">å­«æ­¦</div>
      <div class="npc-text clamp" id="npcText">å…ˆé †å£ï¼Œå†ç©©ä½ï¼›ç©©ä½äº†ï¼Œå°±èƒŒèµ·ä¾†ã€‚</div>
      <div class="npc-toggle" id="npcToggle" title="å±•é–‹/æ”¶èµ·">å±•</div>
    </div>

    <!-- BOARD -->
    <div class="board">
      <div class="board-head">
        <div class="board-title">ä½ˆä»¤æ¿</div>
        <div class="board-line"></div>
        <div class="smallmuted" id="missingText">ç¼ºè©ï¼š0</div>
      </div>
      <div class="board-body" id="boardBody">
        <div class="board-hint" id="boardHint">é»ä¸‹æ–¹ä»¤ç‰Œï¼Œä¾é †åºæ”¾ä¸Šä½ˆä»¤æ¿</div>
      </div>
    </div>

    <!-- ACTIONS + TOKENS -->
    <div class="actions">
      <div class="btnrow">
        <button class="btn bad" id="undoBtn">æ’¤ä»¤</button>
        <button class="btn" id="resetBtn">é‡æ•´</button>
        <button class="btn good" id="checkBtn">é©—ä»¤</button>
      </div>
      <div class="btnrow">
        <button class="btn gold" id="reviewBtn">æ ¡é–±</button>
      </div>

      <div class="tokenzone">
        <div class="tokenhead">
          <div>ä»¤ç‰Œå€</div>
          <div class="smallmuted" id="pageHint"></div>
        </div>
        <div class="tokens" id="tokenArea"></div>
      </div>
    </div>
  </div>

  <!-- MODAL: å…µæ›¸ -->
  <div class="modal" id="modalScroll">
    <div class="card">
      <div class="cardhead">
        <div class="tag gold" id="scrollTag">å…µæ›¸</div>
        <div class="close" data-close="modalScroll">âœ•</div>
      </div>
      <div class="cardbody">
        <div class="section">
          <h3>åŸæ–‡</h3>
          <div class="orig" id="scrollOrig"></div>
        </div>
        <div class="section">
          <h3>ç™½è©±</h3>
          <div class="plain" id="scrollPlain"></div>
        </div>
      </div>
      <div class="cardfoot">
        <button class="btn" data-close="modalScroll">æ”¶èµ·</button>
        <button class="btn good" id="nextBtn">ä¸‹ä¸€æ®µ</button>
      </div>
    </div>
  </div>

  <!-- MODAL: æ ¡é–± -->
  <div class="modal" id="modalReview">
    <div class="card">
      <div class="cardhead">
        <div class="tag" id="reviewTitle">æ ¡é–±</div>
        <div class="close" data-close="modalReview">âœ•</div>
      </div>
      <div class="cardbody">
        <div class="section">
          <h3>æ¨¡å¼</h3>
          <div class="segGrid" style="margin-bottom:8px;">
            <div class="choice" id="modePick">é¸è©ç‰Œ</div>
            <div class="choice" id="modeFill">è£œç©º</div>
          </div>
          <div class="smallmuted">æç¤ºï¼šä»Šå¤©æƒ³è¼•é¬†å°±ã€Œè£œç©ºã€ï¼›æƒ³ç·´ç©©å°±ã€Œé¸è©ç‰Œã€ã€‚</div>
        </div>

        <div class="section">
          <h3>ç¯„åœ</h3>
          <div class="segGrid" style="margin-bottom:8px;">
            <div class="choice" id="scopeThis">æœ¬æ®µ</div>
            <div class="choice right" id="scopeCum">ç´¯ç©åˆ°ç›®å‰ï¼ˆé è¨­ï¼‰</div>
            <div class="choice" id="scopeRand">æŠ½æŸ¥</div>
          </div>
          <div class="smallmuted">ç´¯ç©ï¼šç¬¬2æ®µæœƒé€£åŒç¬¬1æ®µä¸€èµ·æ ¡é–±ï¼›è¶Šç©è¶Šç‰¢ã€‚</div>
        </div>

        <div class="section">
          <h3 id="qTitle">é¡Œç›®</h3>
          <div class="orig" id="qText" style="font-weight:900;"></div>
          <div class="smallmuted" id="qSub" style="margin-top:8px;"></div>
        </div>

        <div class="section">
          <h3>é¸æ“‡</h3>
          <div class="segGrid" id="qChoices"></div>
        </div>
      </div>
      <div class="cardfoot">
        <button class="btn" data-close="modalReview">æ”¶èµ·</button>
        <button class="btn good" id="reviewNext">ä¸‹ä¸€é¡Œ</button>
      </div>
    </div>
  </div>

  <!-- MODAL: è¨­å®š -->
  <div class="modal" id="modalSettings">
    <div class="card">
      <div class="cardhead">
        <div class="tag">è¨­å®š</div>
        <div class="close" data-close="modalSettings">âœ•</div>
      </div>
      <div class="cardbody">
        <div class="section">
          <h3>å­¸ç¿’æç¤ºï¼ˆå‘¼å¸ç‡ˆï¼‰</h3>
          <div class="segGrid">
            <div class="choice right" id="setHintOn">é–‹</div>
            <div class="choice" id="setHintOff">é—œ</div>
          </div>
        </div>
        <div class="section">
          <h3>éŸ³æ•ˆ</h3>
          <div class="segGrid">
            <div class="choice right" id="setSfxOn">é–‹</div>
            <div class="choice" id="setSfxOff">é—œ</div>
          </div>
          <div class="smallmuted">æç¤ºï¼šè‹¥åœ¨å¯¢å®¤æˆ–å®¤å…§ä¸Šèª²ï¼Œé—œæ‰ä¹Ÿæ›´è‡ªåœ¨ã€‚</div>
        </div>
        <div class="section">
          <h3>å­—é«”å¤§å°</h3>
          <div class="segGrid">
            <div class="choice" data-font="0.92">å°</div>
            <div class="choice right" data-font="1">ä¸­</div>
            <div class="choice" data-font="1.12">å¤§</div>
          </div>
        </div>
      </div>
      <div class="cardfoot">
        <button class="btn good" data-close="modalSettings">å®Œæˆ</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== è³‡æ–™ï¼šv1 åªåšå§‹è¨ˆç¯‡ä¸€æ®µï¼ˆå¯æ“´å……ï¼‰ ===== */
    const levels = [
      {
        chapter:"å§‹è¨ˆç¯‡",
        title:"æ¼”ç·´ 1",
        segments:["å…µè€…","åœ‹ä¹‹å¤§äº‹","æ­»ç”Ÿä¹‹åœ°","å­˜äº¡ä¹‹é“","ä¸å¯ä¸å¯Ÿä¹Ÿ"],
        punctuation:"ï¼Œ", // é¡¯ç¤ºç”¨çš„åˆ†éš”
        fullText:"å…µè€…ï¼Œåœ‹ä¹‹å¤§äº‹ï¼Œæ­»ç”Ÿä¹‹åœ°ï¼Œå­˜äº¡ä¹‹é“ï¼Œä¸å¯ä¸å¯Ÿä¹Ÿã€‚",
        plain:"ã€ç™½è©±ã€‘æˆ°çˆ­æ˜¯åœ‹å®¶çš„å¤§äº‹ï¼Œé—œä¿‚åˆ°è»æ°‘çš„ç”Ÿæ­»ã€åœ‹å®¶çš„å­˜äº¡ï¼Œå› æ­¤çµ•å°ä¸å¯ä¸ä»”ç´°å¯©å¯Ÿã€‚",
        sunwin:[
          "å¯ä»¥ã€‚ä½ ä¸æ˜¯ç¡¬èƒŒï¼Œæ˜¯èƒŒå¾—æœ‰ç¯€å¥ã€‚",
          "ç©©ä½å°±å¥½ï¼Œä¸‹ä¸€å¥è‡ªç„¶æœƒæ¥ä¸Šã€‚",
          "é€™å¥å·²ç¶“è®Šæˆä½ çš„è©±äº†ã€‚"
        ]
      }
    ];

    /* ===== ç‹€æ…‹ ===== */
    let idx = 0;
    let selection = [];      // ä½ˆä»¤æ¿å·²æ”¾ä¸Šçš„è©ç‰Œ
    let pool = [];           // ä»¤ç‰Œå€å‰©é¤˜
    let hintOn = true;
    let sfxOn = true;

    // æ ¡é–±è¨­å®šï¼šé è¨­ç´¯ç©é–‹å•Ÿ
    let reviewMode = "pick";     // pick / fill
    let reviewScope = "cum";     // this / cum / rand
    let reviewQueue = [];        // é¡Œç›®åºåˆ—
    let reviewCursor = 0;

    /* ===== å…ƒä»¶ ===== */
    const rankTag = document.getElementById('rankTag');
    const stageText = document.getElementById('stageText');
    const statusText = document.getElementById('statusText');
    const hintState = document.getElementById('hintState');
    const progressFill = document.getElementById('progressFill');

    const npcText = document.getElementById('npcText');
    const npcToggle = document.getElementById('npcToggle');

    const boardBody = document.getElementById('boardBody');
    const boardHint = document.getElementById('boardHint');
    const tokenArea = document.getElementById('tokenArea');
    const missingText = document.getElementById('missingText');

    const undoBtn = document.getElementById('undoBtn');
    const resetBtn = document.getElementById('resetBtn');
    const checkBtn = document.getElementById('checkBtn');
    const reviewBtn = document.getElementById('reviewBtn');

    const scrollBtn = document.getElementById('scrollBtn');
    const settingsBtn = document.getElementById('settingsBtn');

    const modalScroll = document.getElementById('modalScroll');
    const scrollOrig = document.getElementById('scrollOrig');
    const scrollPlain = document.getElementById('scrollPlain');
    const nextBtn = document.getElementById('nextBtn');

    const modalReview = document.getElementById('modalReview');
    const modePick = document.getElementById('modePick');
    const modeFill = document.getElementById('modeFill');
    const scopeThis = document.getElementById('scopeThis');
    const scopeCum = document.getElementById('scopeCum');
    const scopeRand = document.getElementById('scopeRand');
    const qTitle = document.getElementById('qTitle');
    const qText = document.getElementById('qText');
    const qSub = document.getElementById('qSub');
    const qChoices = document.getElementById('qChoices');
    const reviewNext = document.getElementById('reviewNext');

    const modalSettings = document.getElementById('modalSettings');
    const setHintOn = document.getElementById('setHintOn');
    const setHintOff = document.getElementById('setHintOff');
    const setSfxOn = document.getElementById('setSfxOn');
    const setSfxOff = document.getElementById('setSfxOff');

    /* ===== å·¥å…· ===== */
    function vibrate(ms=12){ if(navigator.vibrate) navigator.vibrate(ms); }
    function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    // ç°¡å–®éŸ³æ•ˆï¼ˆWebAudioï¼‰â€” å¯é—œ
    const AudioKit = (() => {
      let ctx = null;
      function beep(freq=520, dur=0.06, gain=0.05){
        if(!sfxOn) return;
        try{
          ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine';
          o.frequency.value = freq;
          g.gain.value = gain;
          o.connect(g); g.connect(ctx.destination);
          o.start();
          o.stop(ctx.currentTime + dur);
        }catch(e){}
      }
      return {
        tap(){ beep(480,0.05,0.05); },
        ok(){ beep(660,0.07,0.06); setTimeout(()=>beep(880,0.06,0.05),80); },
        bad(){ beep(240,0.07,0.06); },
        pop(){ beep(540,0.05,0.04); }
      };
    })();

    function openModal(el){ el.style.display="flex"; }
    function closeModal(el){ el.style.display="none"; }

    // å…¨ç«™é—œé–‰æŒ‰éˆ•
    document.querySelectorAll('[data-close]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-close');
        closeModal(document.getElementById(id));
        AudioKit.pop();
        vibrate(10);
      });
    });

    /* ===== æ ¸å¿ƒï¼šè¼‰å…¥é—œå¡ ===== */
    function init(){
      load(idx);
      wire();
    }

    function load(i){
      const L = levels[i];
      stageText.textContent = `${L.chapter}ï½œ${L.title}`;
      progressFill.style.width = `${(i/levels.length)*100}%`;

      selection = [];
      pool = [...L.segments].sort(()=>Math.random()-0.5);

      statusText.textContent = "ç›®å‰ç„¡éŒ¯å­—";
      hintState.textContent = hintOn ? "é–‹" : "é—œ";

      npcText.textContent = "å…ˆé †å£ï¼Œå†ç©©ä½ï¼›ç©©ä½äº†ï¼Œå°±èƒŒèµ·ä¾†ã€‚";
      npcText.classList.add('clamp');
      npcToggle.textContent = "å±•";

      render();
      updateHintGlow();
      updateMissing();
      scrollBtn.classList.remove('pulse');
    }

    function render(){
      // ä½ˆä»¤æ¿
      boardBody.innerHTML = "";
      if(selection.length===0){
        boardBody.appendChild(boardHint);
      }else{
        selection.forEach((t, pos)=>{
          boardBody.appendChild(makeToken(t, "board", pos));
        });
      }

      // ä»¤ç‰Œå€
      tokenArea.innerHTML = "";
      pool.forEach((t, k)=>{
        tokenArea.appendChild(makeToken(t, "pool", k));
      });
    }

    function makeToken(text, where, index){
      const el = document.createElement('div');
      el.className = "token";
      el.textContent = text;
      el.addEventListener('click', ()=>{
        AudioKit.tap();
        vibrate(10);
        if(where==="pool"){
          // æ”¾ä¸Šä½ˆä»¤æ¿
          selection.push(text);
          pool.splice(pool.indexOf(text), 1);
        }else{
          // å¾ä½ˆä»¤æ¿æ’¤å›
          pool.push(text);
          selection.splice(selection.indexOf(text), 1);
        }
        render();
        updateMissing();
        updateHintGlow();
      });
      return el;
    }

    function updateMissing(){
      const L = levels[idx];
      const missing = Math.max(0, L.segments.length - selection.length);
      missingText.textContent = `ç¼ºè©ï¼š${missing}`;
    }

    function updateHintGlow(){
      const tokens = tokenArea.querySelectorAll('.token');
      tokens.forEach(t=>t.classList.remove('hint'));

      if(!hintOn) return;
      const L = levels[idx];
      if(selection.length >= L.segments.length) return;

      const next = L.segments[selection.length];
      for(const t of tokens){
        if(t.textContent === next){
          t.classList.add('hint');
          break;
        }
      }
    }

    /* ===== é©—ä»¤ ===== */
    function check(){
      const L = levels[idx];
      if(selection.length !== L.segments.length){
        AudioKit.bad();
        npcText.textContent = "å…ˆæŠŠé€™ä¸€æ®µæ’å®Œæ•´ï¼Œå†ä¾†é©—ä»¤ã€‚";
        return;
      }
      const ok = selection.every((v, i)=> v===L.segments[i]);
      if(ok){
        AudioKit.ok();
        statusText.textContent = "é©—ä»¤é€šéï¼ˆç©©ï¼‰";
        npcText.textContent = rand(L.sunwin);
        // æç¤ºå…µæ›¸å¯ä»¥çœ‹
        if(hintOn){
          scrollBtn.classList.add('pulse');
          setTimeout(()=>scrollBtn.classList.remove('pulse'), 2400);
        }
        // é¡¯ç¤ºå…µæ›¸å½ˆçª—
        showScroll();
      }else{
        AudioKit.bad();
        statusText.textContent = "ç›®å‰éŒ¯å­—/éŒ¯åºï¼šè«‹èª¿æ•´";
        npcText.textContent = "é †åºäº‚äº†ã€‚åˆ¥æ€¥ï¼Œæ…¢æ…¢èª¿å›ä¾†å°±å¥½ã€‚";
      }
    }

    function showScroll(){
      const L = levels[idx];
      scrollOrig.textContent = L.fullText;
      scrollPlain.textContent = L.plain;
      openModal(modalScroll);
    }

    function next(){
      idx++;
      if(idx>=levels.length){
        alert("v1 æ¸¬è©¦æ®µè½çµæŸï¼ˆä¹‹å¾Œå¯æ“´å……å…¨æ›¸ï¼‰");
        idx = 0;
      }
      load(idx);
    }

    /* ===== æ ¡é–±ï¼ˆå½ˆçª—ï¼Œå¯åˆ‡æ›æ¨¡å¼ï¼Œé è¨­ç´¯ç©ï¼‰ ===== */
    function buildReviewQueue(){
      // v1 åªæœ‰ä¸€æ®µï¼›ä»æŠŠçµæ§‹å¯«å®Œæ•´ï¼Œä¹‹å¾Œæ“´å……æ•´ç¯‡å¯ç›´æ¥ç”¨
      // ç´¯ç©ï¼šå– 0..idxï¼›æœ¬æ®µï¼šåªå– idxï¼›æŠ½æŸ¥ï¼šéš¨æ©ŸæŠ½ä¸€æ®µ
      let range = [];
      if(reviewScope==="this") range = [idx];
      else if(reviewScope==="cum") range = Array.from({length: idx+1}, (_,k)=>k);
      else { range = [Math.floor(Math.random()*(idx+1))]; }

      // ç”Ÿæˆé¡Œç›®ï¼šæ¯æ®µå‡º 1 é¡Œï¼ˆå¯æ“´å……æˆå¤šé¡Œï¼‰
      reviewQueue = range.map(i=>{
        const L = levels[i];
        if(reviewMode==="pick"){
          // é¡Œå‹ï¼šæŠŠæ•´æ®µè©çµ„æ‰“äº‚ï¼Œè¦æ±‚é¸å‡ºã€Œä¸‹ä¸€å€‹æ­£ç¢ºè©ç‰Œã€
          return {type:"pick-next", level:i, cursor:0};
        }else{
          // è£œç©ºï¼šæ•´å¥é® 1~2 å€‹è©ç‰Œï¼ˆv1 å›ºå®šé® 2 å€‹ï¼Œä¹‹å¾Œå¯éš¨æ©Ÿï¼‰
          const blanks = [1,3]; // é®ã€Œåœ‹ä¹‹å¤§äº‹ã€ã€Œå­˜äº¡ä¹‹é“ã€
          return {type:"fill-blanks", level:i, blanks, cursor:0};
        }
      });

      reviewCursor = 0;
    }

    function openReview(){
      buildReviewQueue();
      renderReviewQuestion();
      openModal(modalReview);
    }

    function setModeUI(){
      // mode
      modePick.classList.toggle('right', reviewMode==="pick");
      modeFill.classList.toggle('right', reviewMode==="fill");
      // scope
      scopeThis.classList.toggle('right', reviewScope==="this");
      scopeCum.classList.toggle('right', reviewScope==="cum");
      scopeRand.classList.toggle('right', reviewScope==="rand");
    }

    function renderReviewQuestion(){
      setModeUI();
      if(reviewCursor >= reviewQueue.length){
        qTitle.textContent = "æ ¡é–±å®Œæˆ";
        qText.textContent = "ä»Šå¤©å°±åˆ°é€™è£¡ã€‚ä½ æœ‰åœ¨è®Šç©©ã€‚";
        qSub.textContent = "æç¤ºï¼šæƒ³å†ç·´ï¼ŒæŒ‰ã€Œä¸‹ä¸€é¡Œã€æœƒé‡æ–°å‡ºé¡Œã€‚";
        qChoices.innerHTML = "";
        reviewNext.textContent = "å†æ ¡é–±ä¸€æ¬¡";
        return;
      }

      reviewNext.textContent = "ä¸‹ä¸€é¡Œ";
      const Q = reviewQueue[reviewCursor];
      const L = levels[Q.level];

      if(Q.type==="pick-next"){
        qTitle.textContent = `æ ¡é–±ï¼ˆé¸è©ç‰Œï¼‰ï½œ${reviewScope==="cum" ? "ç´¯ç©" : (reviewScope==="this"?"æœ¬æ®µ":"æŠ½æŸ¥")}`;
        qText.textContent = `è«‹é¸å‡ºä¸‹ä¸€å€‹è©ç‰Œï¼ˆç¬¬ ${Q.cursor+1}/${L.segments.length}ï¼‰`;
        qSub.textContent = "é¸å°å°±å¾€ä¸‹èµ°ï¼›é¸éŒ¯ä¹Ÿæ²’é—œä¿‚ï¼Œèª¿å›ä¾†å°±å¥½ã€‚";

        const correct = L.segments[Q.cursor];
        let options = [correct];
        // åŠ  3 å€‹å¹²æ“¾
        const candidates = L.segments.filter(x=>x!==correct);
        while(options.length<4 && candidates.length){
          const pick = candidates.splice(Math.floor(Math.random()*candidates.length),1)[0];
          options.push(pick);
        }
        options = options.sort(()=>Math.random()-0.5);

        qChoices.innerHTML = "";
        options.forEach(opt=>{
          const c = document.createElement('div');
          c.className = "choice";
          c.textContent = opt;
          c.addEventListener('click', ()=>{
            AudioKit.tap();
            vibrate(10);
            if(opt===correct){
              c.classList.add('right');
              AudioKit.ok();
              Q.cursor++;
              setTimeout(()=>{
                if(Q.cursor>=L.segments.length){
                  reviewCursor++;
                }
                renderReviewQuestion();
              }, 260);
            }else{
              c.classList.add('wrong');
              AudioKit.bad();
              // æº«æŸ”ï¼šä¸æ‰£åˆ†ã€ä¸è·³èµ°
              qSub.textContent = "æ²’äº‹ï¼Œå›åˆ°ç¯€å¥ï¼šæƒ³æƒ³ä¸‹ä¸€å€‹æ‡‰è©²æ¥å“ªå€‹è©ç‰Œã€‚";
            }
          });
          qChoices.appendChild(c);
        });

      }else{
        qTitle.textContent = `æ ¡é–±ï¼ˆè£œç©ºï¼‰ï½œ${reviewScope==="cum" ? "ç´¯ç©" : (reviewScope==="this"?"æœ¬æ®µ":"æŠ½æŸ¥")}`;
        // ç”Ÿæˆå¸¶ç©ºæ ¼çš„å¥å­
        const parts = L.segments.map((s, i)=> Q.blanks.includes(i) ? "ï¼¿ï¼¿ï¼¿" : s);
        const punct = "ï¼Œ";
        qText.textContent = parts.join(punct) + "ã€‚";
        qSub.textContent = "ä¾ç©ºæ ¼é¸è©ç‰Œè£œä¸Šï¼Œè£œå°å°±å®Œæˆã€‚";

        // ç›®å‰è¦å¡«ç¬¬å¹¾å€‹ç©º
        const blankIndex = Q.blanks[Q.cursor];
        const correct = L.segments[blankIndex];

        let options = [correct];
        const candidates = L.segments.filter(x=>x!==correct);
        while(options.length<4 && candidates.length){
          options.push(candidates.splice(Math.floor(Math.random()*candidates.length),1)[0]);
        }
        options = options.sort(()=>Math.random()-0.5);

        qChoices.innerHTML = "";
        options.forEach(opt=>{
          const c = document.createElement('div');
          c.className = "choice";
          c.textContent = opt;
          c.addEventListener('click', ()=>{
            AudioKit.tap();
            vibrate(10);
            if(opt===correct){
              c.classList.add('right');
              AudioKit.ok();
              Q.cursor++;
              setTimeout(()=>{
                if(Q.cursor>=Q.blanks.length){
                  reviewCursor++;
                }
                renderReviewQuestion();
              }, 260);
            }else{
              c.classList.add('wrong');
              AudioKit.bad();
              qSub.textContent = "ä¸æ€¥ã€‚çœ‹ç©ºæ ¼å‰å¾Œçš„ç¯€å¥ï¼Œå†è£œä¸€æ¬¡å°±å¥½ã€‚";
            }
          });
          qChoices.appendChild(c);
        });
      }
    }

    /* ===== è¨­å®š ===== */
    function setFont(scale){
      document.documentElement.style.setProperty('--fontScale', scale);
      // æ›´æ–°æŒ‰éˆ•å¤–è§€
      document.querySelectorAll('[data-font]').forEach(el=>{
        el.classList.toggle('right', el.getAttribute('data-font')===String(scale));
      });
    }

    function wire(){
      npcToggle.addEventListener('click', ()=>{
        AudioKit.pop();
        vibrate(8);
        const clamped = npcText.classList.toggle('clamp');
        npcToggle.textContent = clamped ? "å±•" : "æ”¶";
      });

      undoBtn.addEventListener('click', ()=>{
        AudioKit.pop(); vibrate(10);
        if(selection.length===0) return;
        const last = selection.pop();
        pool.push(last);
        render();
        updateMissing();
        updateHintGlow();
      });

      resetBtn.addEventListener('click', ()=>{
        AudioKit.pop(); vibrate(10);
        load(idx);
      });

      checkBtn.addEventListener('click', ()=>{ AudioKit.pop(); vibrate(10); check(); });

      scrollBtn.addEventListener('click', ()=>{ AudioKit.pop(); vibrate(10); showScroll(); });

      nextBtn.addEventListener('click', ()=>{ AudioKit.pop(); vibrate(10); closeModal(modalScroll); next(); });

      reviewBtn.addEventListener('click', ()=>{ AudioKit.pop(); vibrate(10); openReview(); });

      reviewNext.addEventListener('click', ()=>{
        AudioKit.pop(); vibrate(10);
        if(reviewCursor >= reviewQueue.length){
          openReview(); // é‡æ–°å‡ºé¡Œ
        }else{
          // ç›´æ¥ä¸‹ä¸€é¡Œ
          reviewCursor++;
          renderReviewQuestion();
        }
      });

      // è¨­å®šé¢æ¿
      settingsBtn.addEventListener('click', ()=>{ AudioKit.pop(); vibrate(10); openModal(modalSettings); });

      setHintOn.addEventListener('click', ()=>{
        hintOn = true;
        hintState.textContent = "é–‹";
        setHintOn.classList.add('right'); setHintOff.classList.remove('right');
        updateHintGlow();
      });
      setHintOff.addEventListener('click', ()=>{
        hintOn = false;
        hintState.textContent = "é—œ";
        setHintOff.classList.add('right'); setHintOn.classList.remove('right');
        updateHintGlow();
        scrollBtn.classList.remove('pulse');
      });

      setSfxOn.addEventListener('click', ()=>{
        sfxOn = true;
        setSfxOn.classList.add('right'); setSfxOff.classList.remove('right');
      });
      setSfxOff.addEventListener('click', ()=>{
        sfxOn = false;
        setSfxOff.classList.add('right'); setSfxOn.classList.remove('right');
      });

      document.querySelectorAll('[data-font]').forEach(el=>{
        el.addEventListener('click', ()=>{
          AudioKit.pop(); vibrate(8);
          setFont(el.getAttribute('data-font'));
        });
      });

      // æ ¡é–±æ¨¡å¼/ç¯„åœåˆ‡æ›
      modePick.addEventListener('click', ()=>{ reviewMode="pick"; setModeUI(); buildReviewQueue(); renderReviewQuestion(); });
      modeFill.addEventListener('click', ()=>{ reviewMode="fill"; setModeUI(); buildReviewQueue(); renderReviewQuestion(); });

      scopeThis.addEventListener('click', ()=>{ reviewScope="this"; setModeUI(); buildReviewQueue(); renderReviewQuestion(); });
      scopeCum.addEventListener('click', ()=>{ reviewScope="cum"; setModeUI(); buildReviewQueue(); renderReviewQuestion(); });
      scopeRand.addEventListener('click', ()=>{ reviewScope="rand"; setModeUI(); buildReviewQueue(); renderReviewQuestion(); });

      // åˆå§‹å­—é«”æŒ‰éˆ•
      setFont("1");
      setHintOn.classList.add('right');
      setSfxOn.classList.add('right');
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
