<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>孫子兵法：大將軍之路 (全本背誦版)</title>
    <style>
        :root {
            /* 軍營沈浸配色 */
            --bg-canvas: #e0d6c4; /* 帳篷帆布 */
            --wood-frame: #4e342e; /* 深紅木 */
            --wood-light: #795548;
            --ink-black: #212121;
            --rank-gold: #ffb300;
            --army-red: #b71c1c;
            --paper-texture: #f5f5dc;
        }

        body {
            font-family: "Kaiti TC", "楷體", "STKaiti", serif; /* 強制使用楷體，增加古風 */
            margin: 0;
            padding: 0;
            background-color: #5d4037;
            background-image: repeating-linear-gradient(45deg, #4e342e 0, #4e342e 10px, #3e2723 10px, #3e2723 20px);
            color: var(--wood-frame);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* === 頂部軍情條 === */
        header {
            width: 100%;
            background: var(--wood-frame);
            color: #d7ccc8;
            padding: 8px 15px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #8d6e63;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .rank-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--rank-gold);
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        .rank-icon {
            width: 30px;
            height: 30px;
            background: var(--army-red);
            border-radius: 5px;
            border: 2px solid var(--rank-gold);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }

        .progress-info {
            font-size: 0.9rem;
            color: #bcaaa4;
        }

        /* === 主戰場 (沙盤) === */
        #battlefield {
            flex: 1;
            width: 100%;
            max-width: 600px;
            background: var(--bg-canvas);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        /* 燭光特效 */
        #battlefield::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 50% 30%, transparent 40%, rgba(0,0,0,0.2) 90%);
            pointer-events: none;
            z-index: 5;
        }

        /* NPC 帥印區 */
        .npc-container {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-start;
            z-index: 10;
        }

        .npc-portrait {
            width: 60px;
            height: 60px;
            background: var(--wood-frame);
            border: 3px solid #8d6e63;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            flex-shrink: 0;
        }

        .npc-dialogue {
            background: #fff;
            padding: 12px 18px;
            border-radius: 4px 15px 15px 15px;
            border: 2px solid var(--wood-frame);
            font-size: 1.1rem;
            line-height: 1.5;
            position: relative;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
        }
        .npc-dialogue::before {
            content: '';
            position: absolute;
            top: 15px; left: -10px;
            border-width: 6px 10px 6px 0;
            border-style: solid;
            border-color: transparent var(--wood-frame) transparent transparent;
        }

        /* 題示區 (竹簡放置處) */
        .scroll-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.5);
            border: 2px dashed var(--wood-light);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            z-index: 10;
            transition: all 0.3s;
        }

        .scroll-area.correct-flash {
            background-color: rgba(46, 125, 50, 0.2);
            border-color: #2e7d32;
        }
        .scroll-area.wrong-flash {
            background-color: rgba(183, 28, 28, 0.2);
            border-color: var(--army-red);
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* 候選區 (下方) */
        .deck-area {
            min-height: 120px;
            background: rgba(62, 39, 35, 0.1);
            border-top: 3px solid var(--wood-frame);
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            z-index: 10;
        }

        /* 竹簡樣式 */
        .bamboo-tile {
            background: linear-gradient(to bottom, #ffecb3, #ffca28);
            border: 1px solid #8d6e63;
            border-top: 3px solid #6d4c41;
            border-bottom: 3px solid #6d4c41;
            padding: 10px 18px;
            border-radius: 3px;
            font-size: 1.25rem;
            color: #3e2723;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            user-select: none;
            position: relative;
        }
        .bamboo-tile:active { transform: scale(0.95); }
        
        /* 繩結裝飾 */
        .bamboo-tile::before {
            content: ''; position: absolute; top: 50%; left: 4px; right: 4px; height: 1px;
            background: rgba(0,0,0,0.1); pointer-events: none;
        }

        /* 按鈕群 */
        .btn-group {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
            z-index: 20;
            margin-bottom: 5px;
        }
        
        .army-btn {
            background: var(--wood-frame);
            color: #fff;
            border: 2px solid #8d6e63;
            padding: 10px 25px;
            font-size: 1.1rem;
            font-family: inherit;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 3px 0 #3e2723;
        }
        .army-btn:active { transform: translateY(3px); box-shadow: none; }
        .army-btn.primary { background: var(--army-red); border-color: #d32f2f; }

        /* 晉升視窗 */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .rank-up-scroll {
            background: #fff8e1;
            width: 80%; max-width: 400px;
            padding: 30px;
            text-align: center;
            border-top: 20px solid var(--wood-frame);
            border-bottom: 20px solid var(--wood-frame);
            box-shadow: 0 0 30px #000;
            position: relative;
        }
        .rank-stamp {
            position: absolute; top: 10px; right: 20px;
            width: 80px; height: 80px;
            border: 4px solid var(--army-red);
            color: var(--army-red);
            border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: bold;
            transform: rotate(15deg);
            opacity: 0; animation: stampDown 0.5s forwards 0.5s;
        }

        @keyframes stampDown {
            0% { transform: scale(2) rotate(15deg); opacity: 0; }
            100% { transform: scale(1) rotate(15deg); opacity: 1; }
        }

        .chapter-title {
            position: absolute;
            top: 5px; right: 10px;
            font-size: 0.8rem;
            color: rgba(62, 39, 35, 0.4);
            font-weight: bold;
        }

    </style>
</head>
<body>

<header>
    <div class="rank-badge">
        <div class="rank-icon" id="rank-icon">卒</div>
        <span id="rank-name">步卒</span>
    </div>
    <div class="progress-info" id="level-display">關卡 1</div>
</header>

<div id="battlefield">
    <div class="chapter-title" id="chapter-name">第一篇：始計</div>
    
    <div class="npc-container">
        <div class="npc-portrait">孫</div>
        <div class="npc-dialogue" id="npc-text">新兵，聽我號令！將竹簡依序排好！</div>
    </div>

    <div class="scroll-area" id="target-zone">
        <div style="color:#8d6e63; margin-top:30px;">(點擊下方竹簡進行排列)</div>
    </div>

    <div class="btn-group">
        <button class="army-btn" onclick="resetLevel()">重整</button>
        <button class="army-btn primary" id="check-btn" style="display:none;" onclick="nextLevel()">領命 (下一關)</button>
    </div>

    <div class="deck-area" id="source-zone">
        </div>
</div>

<div class="modal" id="rank-modal">
    <div class="rank-up-scroll">
        <div class="rank-stamp">晉升</div>
        <h2 style="color:var(--army-red); font-size:2rem; margin:10px 0;">官階晉升</h2>
        <p>戰功彪炳，特此拔擢為</p>
        <h1 id="new-rank-title" style="font-size:2.5rem; margin:10px 0; color:var(--wood-frame)">伍長</h1>
        <button class="army-btn primary" onclick="closeRankModal()">謝主隆恩</button>
    </div>
</div>

<script>
    // === 1. 大數據庫 (這裡未來可以無限擴充) ===
    const chapters = {
        "始計篇": [
            "兵者，國之大事",
            "死生之地，存亡之道，不可不察也",
            "故經之以五事，校之以計，而索其情",
            "一曰道，二曰天，三曰地，四曰將，五曰法",
            "道者，令民與上同意也",
            "故可與之死，可與之生，而不畏危",
            "天者，陰陽、寒暑、時制也",
            "地者，遠近、險易、廣狹、死生也",
            "將者，智、信、仁、勇、嚴也",
            "法者，曲制、官道、主用也",
            "凡此五者，將莫不聞，知之者勝，不知者不勝",
            "故校之以計，而索其情",
            "曰：主孰有道？將孰有能？",
            "天地孰得？法令孰行？",
            "兵眾孰強？士卒孰練？賞罰孰明？",
            "吾以此知勝負矣",
            "將聽吾計，用之必勝，留之",
            "將不聽吾計，用之必敗，去之",
            "計利以聽，乃為之勢，以佐其外",
            "勢者，因利而制權也",
            "兵者，詭道也",
            "故能而示之不能，用而示之不用",
            "近而示之遠，遠而示之近",
            "利而誘之，亂而取之",
            "實而備之，強而避之",
            "怒而撓之，卑而驕之",
            "佚而勞之，親而離之",
            "攻其無備，出其不意",
            "此兵家之勝，不可先傳也",
            "夫未戰而廟算勝者，得算多也",
            "未戰而廟算不勝者，得算少也",
            "多算勝，少算不勝，而況於無算乎",
            "吾以此觀之，勝負見矣"
        ],
        // 之後可以在這裡加 "作戰篇": [ ... ],
    };

    // 將所有關卡扁平化處理
    let allLevels = [];
    let chapterNames = Object.keys(chapters);
    
    chapterNames.forEach(name => {
        chapters[name].forEach(line => {
            // 自動切分句子成為竹簡 (以逗號、句號為分隔，但這裡我們手動定義了比較好)
            // 這裡簡單處理：如果句子很長，可以再切，目前預設一行就是一關的重組素材
            // 為了遊戲性，我們將句子拆解成詞組
            let segments = splitSentence(line);
            allLevels.push({
                chapter: name,
                fullText: line,
                segments: segments
            });
        });
    });

    // 簡單的中文分詞算法 (模擬)
    function splitSentence(str) {
        // 先移除標點符號，再隨機切分? 
        // 不，最好的方式是保留標點，讓使用者重組完整的句子
        // 這裡我們用正則表達式把句子切成 2-4 個字的碎片
        // 為了展示效果，這裡做一個簡單的切分邏輯：以標點符號切分，如果沒有標點，就對半切
        let parts = str.split(/[，、？：；]/);
        // 過濾空字串並修剪
        parts = parts.map(p => p.trim()).filter(p => p);
        
        // 如果切出來太少(例如只有一句)，就強制切字
        if (parts.length === 1 && str.length > 4) {
            let mid = Math.floor(str.length / 2);
            return [str.substring(0, mid), str.substring(mid)];
        }
        return parts;
    }

    // === 2. 軍階系統定義 ===
    const ranks = [
        { title: "步卒", icon: "卒", min: 0 },
        { title: "伍長", icon: "伍", min: 5 },
        { title: "百夫長", icon: "百", min: 10 },
        { title: "千夫長", icon: "千", min: 20 },
        { title: "偏將軍", icon: "將", min: 30 }, // 背完第一篇左右
        { title: "大將軍", icon: "帥", min: 60 },
        { title: "大都督", icon: "督", min: 100 },
        { title: "兵聖", icon: "聖", min: 200 }
    ];

    // === 3. 遊戲狀態 ===
    let currentLevelIndex = 0;
    let currentSelection = [];
    let currentPool = [];
    
    // 讀取進度
    if (localStorage.getItem('sunTzuProgress')) {
        currentLevelIndex = parseInt(localStorage.getItem('sunTzuProgress'));
        // 保護機制：如果存檔超過題庫
        if (currentLevelIndex >= allLevels.length) currentLevelIndex = 0;
    }

    // === 4. 核心功能 ===
    function initGame() {
        loadLevel(currentLevelIndex);
        updateRankDisplay();
    }

    function loadLevel(idx) {
        const levelData = allLevels[idx];
        document.getElementById('level-display').innerText = `關卡 ${idx + 1} / ${allLevels.length}`;
        document.getElementById('chapter-name').innerText = levelData.chapter;
        
        // NPC 對話
        const npcText = document.getElementById('npc-text');
        npcText.innerText = getNPCDialogue(idx);
        npcText.style.color = "#000";

        // 準備竹簡
        currentSelection = [];
        // 複製並打亂
        currentPool = [...levelData.segments].sort(() => Math.random() - 0.5);

        renderBoard();
        document.getElementById('check-btn').style.display = 'none';
        
        // 重置區域樣式
        document.getElementById('target-zone').className = 'scroll-area';
    }

    function renderBoard() {
        const targetZone = document.getElementById('target-zone');
        const sourceZone = document.getElementById('source-zone');
        
        targetZone.innerHTML = '';
        sourceZone.innerHTML = '';

        // 渲染已選區
        if (currentSelection.length === 0) {
            targetZone.innerHTML = '<div style="color:#8d6e63; margin-top:30px;">(點擊下方竹簡進行排列)</div>';
        } else {
            currentSelection.forEach((text, i) => {
                targetZone.appendChild(createTile(text, 'target', i));
            });
        }

        // 渲染候選區
        currentPool.forEach((text, i) => {
            sourceZone.appendChild(createTile(text, 'source', i));
        });
    }

    function createTile(text, type, index) {
        const div = document.createElement('div');
        div.className = 'bamboo-tile';
        div.innerText = text;
        div.onclick = () => moveTile(text, type);
        return div;
    }

    function moveTile(text, type) {
        playClickSound();
        if (type === 'source') {
            currentPool = currentPool.filter(t => t !== text);
            currentSelection.push(text);
        } else {
            currentSelection = currentSelection.filter(t => t !== text);
            currentPool.push(text);
        }
        renderBoard();
        checkAnswer();
    }

    function checkAnswer() {
        const correctSegments = allLevels[currentLevelIndex].segments;
        
        // 如果長度還不夠，不檢查
        if (currentSelection.length !== correctSegments.length) return;

        // 檢查順序 (將陣列轉字串比對)
        const userStr = currentSelection.join('');
        // 移除原句標點來寬鬆比對 (這裡簡化處理，嚴格比對 segments)
        const correctStr = correctSegments.join('');

        // 這裡我們的 segments 切分邏輯比較簡單，直接比對內容順序
        // 為了讓判斷準確，我們比較 "還原後的句子" 是否包含原句的關鍵字
        // 但最簡單的是直接比對 segments 是否一致
        // 由於我們是打亂 segments，所以使用者只要還原順序即可
        
        // 但要注意，splitSentence 產生的 segments 順序就是正確順序
        // 所以我們直接比對陣列
        let isCorrect = true;
        for(let i=0; i<correctSegments.length; i++) {
            if (currentSelection[i] !== correctSegments[i]) {
                isCorrect = false;
                break;
            }
        }

        if (isCorrect) {
            levelPassed();
        } else {
            // 錯誤回饋
            playErrorSound();
            const area = document.getElementById('target-zone');
            area.classList.add('wrong-flash');
            document.getElementById('npc-text').innerText = "孫武：「陣形大亂！請重新調度！」";
            setTimeout(() => area.classList.remove('wrong-flash'), 400);
        }
    }

    function levelPassed() {
        playWinSound();
        const area = document.getElementById('target-zone');
        area.classList.add('correct-flash');
        
        const fullText = allLevels[currentLevelIndex].fullText;
        document.getElementById('npc-text').innerHTML = `<span style="color:#b71c1c; font-weight:bold;">正確！</span><br>${fullText}`;
        
        document.getElementById('check-btn').style.display = 'block';
    }

    function nextLevel() {
        currentLevelIndex++;
        // 存檔
        localStorage.setItem('sunTzuProgress', currentLevelIndex);
        
        // 檢查晉升
        checkRankUp();
        
        if (currentLevelIndex < allLevels.length) {
            loadLevel(currentLevelIndex);
        } else {
            alert("恭喜將軍！始計篇已全數背誦完畢！請等待後續篇章更新！");
            currentLevelIndex = 0; // 暫時循環
            loadLevel(0);
        }
    }

    function resetLevel() {
        loadLevel(currentLevelIndex);
    }

    // === 5. 晉升邏輯 ===
    function checkRankUp() {
        // 找出目前積分對應的最高階級
        let newRank = ranks[0];
        for (let r of ranks) {
            if (currentLevelIndex >= r.min) newRank = r;
        }

        // 讀取舊階級 (顯示用)
        let currentRankTitle = document.getElementById('rank-name').innerText;
        
        if (newRank.title !== currentRankTitle) {
            // 觸發晉升
            showRankModal(newRank);
        }
        updateRankDisplay();
    }

    function updateRankDisplay() {
        let currentRank = ranks[0];
        for (let r of ranks) {
            if (currentLevelIndex >= r.min) currentRank = r;
        }
        document.getElementById('rank-icon').innerText = currentRank.icon;
        document.getElementById('rank-name').innerText = currentRank.title;
    }

    function showRankModal(rank) {
        document.getElementById('new-rank-title').innerText = rank.title;
        document.getElementById('rank-modal').style.display = 'flex';
        playWinSound(); // 這裡可以換成更隆重的音效
    }

    function closeRankModal() {
        document.getElementById('rank-modal').style.display = 'none';
    }

    function getNPCDialogue(idx) {
        // 根據進度給予不同鼓勵
        if (idx === 0) return "兵者，國之大事。第一句該如何起頭？";
        if (idx < 5) return "很好，繼續保持這股氣勢！";
        if (idx < 10) return "熟讀兵法，方能百戰不殆。";
        return "將軍英明！請繼續推演！";
    }

    // === 6. 音效系統 (使用瀏覽器原生 AudioContext) ===
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playClickSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        // 模擬木頭敲擊聲 (短促低頻)
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(300, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }

    function playErrorSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.2);
    }

    function playWinSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime;
        // 簡單的和弦
        [440, 554, 659].forEach((freq, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'square';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, now + i*0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.5);
            osc.start(now + i*0.1);
            osc.stop(now + i*0.1 + 0.5);
        });
    }

    // 啟動
    window.onload = initGame;

</script>
</body>
</html>
