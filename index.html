<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>å­«å­å…µæ³•ï½œè¬€ç•¥ä¹‹æˆ° v1.1</title>
  <style>
    :root{
      --bg0:#0b0f0c;
      --bg1:#0f1712;
      --panel:rgba(22,30,24,.82);
      --panel2:rgba(28,38,30,.88);
      --line:rgba(230,200,120,.35);
      --line2:rgba(230,200,120,.22);
      --gold:#d8b96b;
      --gold2:#b89442;
      --ink:#e9e6db;
      --muted:rgba(233,230,219,.75);
      --danger:#c95151;
      --ok:#4fbf84;
      --hint:#f6d56b;
      --shadow:rgba(0,0,0,.35);
      --radius:18px;
      --fs:18px; /* å¯ç”±è¨­å®šèª¿æ•´ï¼š16/18/20/22 */
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Microsoft JhengHei", "Noto Serif CJK TC", serif;
      background:
        radial-gradient(1200px 600px at 30% 10%, rgba(70,90,60,.35), transparent 60%),
        radial-gradient(900px 500px at 90% 30%, rgba(120,90,40,.25), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
      height:100vh;
      overflow:hidden;
    }

    /* iPhone safe area */
    .app{
      height:100vh;
      padding: calc(env(safe-area-inset-top) + 10px) 12px calc(env(safe-area-inset-bottom) + 10px) 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-width: 720px;
      margin:0 auto;
    }

    .topbar{
      background: var(--panel);
      border: 1px solid var(--line2);
      border-radius: var(--radius);
      box-shadow: 0 10px 25px var(--shadow);
      padding:12px;
      display:flex;
      align-items:center;
      gap:10px;
      min-height: 74px;
    }

    .rank{
      flex:0 0 auto;
      padding:8px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--gold);
      font-weight:700;
      letter-spacing:.08em;
      font-size: 14px;
    }

    .meta{
      flex: 1 1 auto;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 0;
    }
    .meta .row1{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .meta .title{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--muted);
      font-weight:700;
      letter-spacing:.04em;
      font-size: 14px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
      min-width: 0;
      font-size: 13px;
      color: var(--muted);
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(79,191,132,.18);
      flex:0 0 auto;
    }
    .spacer{flex:1 1 auto;}

    .icon-btn{
      flex:0 0 auto;
      width:48px;height:48px;
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.25);
      color: var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 8px 16px var(--shadow);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      user-select:none;
    }
    .icon-btn:active{ transform: scale(.98); }
    .icon{
      font-size: 20px;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.4));
    }

    /* æ›¸å·æŒ‰éˆ•å‘¼å¸ç‡ˆï¼ˆæ›´äº®ã€æ›´æ…¢ï¼‰ */
    .breath{
      animation: breath 4.6s ease-in-out infinite;
      box-shadow:
        0 0 0 1px rgba(246,213,107,.22),
        0 0 18px rgba(246,213,107,.34),
        0 0 36px rgba(246,213,107,.18);
      border-color: rgba(246,213,107,.45) !important;
    }
    @keyframes breath{
      0%{ filter: brightness(1); transform: translateZ(0); }
      50%{ filter: brightness(1.18); }
      100%{ filter: brightness(1); }
    }

    /* å­«æ­¦å°è©± */
    .npc{
      background: var(--panel2);
      border: 1px solid var(--line2);
      border-radius: var(--radius);
      box-shadow: 0 10px 25px var(--shadow);
      padding:12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-height: 70px;
    }
    .npc-badge{
      flex:0 0 auto;
      width:52px;height:52px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.28);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--gold);
      font-weight:900;
      letter-spacing:.08em;
    }
    .npc-text{
      flex:1 1 auto;
      min-width:0;
      font-size: var(--fs);
      line-height: 1.35;
      color: var(--ink);
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
    }
    .npc-text .more{
      color: rgba(246,213,107,.9);
      font-weight:700;
      margin-left:6px;
    }

    /* ä½ˆä»¤æ¿ */
    .board{
      background: rgba(10,14,11,.55);
      border: 1px solid var(--line2);
      border-radius: var(--radius);
      box-shadow: 0 10px 25px var(--shadow);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex: 0 0 auto;
    }
    .board-head{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .board-title{
      color: var(--gold);
      font-weight:900;
      letter-spacing:.08em;
      font-size: 16px;
    }
    .board-stat{
      margin-left:auto;
      color: var(--muted);
      font-weight:700;
      font-size: 14px;
    }

    .slots{
      border: 1px dashed rgba(216,185,107,.35);
      border-radius: 16px;
      padding:10px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      background: rgba(0,0,0,.18);
      min-height: 88px; /* å›ºå®šé«˜åº¦ï¼Œé¿å…æ‰å‡º */
    }
    .slot{
      height:48px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(233,230,219,.35);
      font-weight:800;
      letter-spacing:.06em;
      font-size: 14px;
      overflow:hidden;
      padding:0 10px;
    }
    .slot.filled{
      color: var(--ink);
      border-color: rgba(246,213,107,.22);
      background: rgba(20,26,21,.55);
    }
    .slot.flash{
      animation: flash .22s ease-in-out;
    }
    @keyframes flash{
      0%{ filter: brightness(1); }
      50%{ filter: brightness(1.25); }
      100%{ filter: brightness(1); }
    }

    /* æ“ä½œåˆ— */
    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      flex:0 0 auto;
    }
    .btn{
      height:50px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.25);
      color: var(--ink);
      font-weight:900;
      letter-spacing:.08em;
      cursor:pointer;
      box-shadow: 0 8px 16px var(--shadow);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn.danger{ border-color: rgba(201,81,81,.35); }
    .btn.ok{ border-color: rgba(79,191,132,.35); }
    .btn.gold{ border-color: rgba(216,185,107,.45); background: rgba(40,34,18,.35); }

    /* ä»¤ç‰Œå€ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼Œä¸æ»¾å‹•ï¼‰ */
    .cards{
      background: rgba(10,14,11,.38);
      border: 1px solid var(--line2);
      border-radius: var(--radius);
      box-shadow: 0 10px 25px var(--shadow);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex: 1 1 auto; /* åƒæ‰å‰©é¤˜é«˜åº¦ */
      min-height: 0;
    }
    .cards-head{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .cards-title{
      color: rgba(233,230,219,.7);
      font-weight:900;
      letter-spacing:.08em;
      font-size: 14px;
    }
    .cards-pages{
      margin-left:auto;
      color: rgba(233,230,219,.55);
      font-weight:800;
      font-size: 13px;
    }
    .card-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-content:start;
      flex:1 1 auto;
      min-height:0;
    }

    .card{
      height:56px;
      border-radius: 18px;
      border: 1px solid rgba(216,185,107,.22);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      font-weight:900;
      letter-spacing:.06em;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 0 10px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
      font-size: calc(var(--fs) + 2px);
      line-height: 1.15;
    }
    .card:active{ transform: scale(.99); }
    .card.hint{
      border-color: rgba(246,213,107,.55);
      box-shadow:
        0 0 0 1px rgba(246,213,107,.25),
        0 0 18px rgba(246,213,107,.30),
        0 0 44px rgba(246,213,107,.12);
      animation: breath 4.6s ease-in-out infinite;
    }
    .card.disabled{
      opacity:.45;
      pointer-events:none;
      filter: grayscale(.35);
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal.show{ display:flex; }
    .modal-box{
      width: min(560px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(216,185,107,.25);
      background: rgba(14,18,15,.96); /* ä¸é€æ˜ä¸€äº›ï¼Œé¿å…èƒŒå¾Œå­—å¹²æ“¾ */
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      padding: 14px 14px 10px 14px;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(216,185,107,.16);
    }
    .modal-title{
      font-weight:1000;
      letter-spacing:.08em;
      color: var(--gold);
      font-size: 14px;
    }
    .modal-close{
      margin-left:auto;
      width:40px;height:40px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.25);
      color: var(--ink);
      font-weight:900;
      cursor:pointer;
    }
    .modal-body{
      padding: 14px;
      color: var(--ink);
      font-size: var(--fs);
      line-height: 1.5;
    }
    .modal-body .quote{
      font-weight:900;
      font-size: calc(var(--fs) + 4px);
      line-height: 1.35;
      margin: 6px 0 10px 0;
    }
    .modal-body .explain{
      color: rgba(233,230,219,.78);
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .modal-actions{
      padding: 12px 14px 14px 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .modal-actions .btn{
      height:52px;
    }

    /* æ•™å­¸å°å­— */
    .tiny{
      color: rgba(233,230,219,.65);
      font-weight:700;
      font-size: 13px;
      line-height: 1.45;
    }

    /* è¨­å®šé¸å–® */
    .settings-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 8px;
    }
    .set-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
    }
    .set-row b{ color: var(--ink); letter-spacing:.04em; }
    .toggle{
      width:56px;height:32px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      position:relative;
      cursor:pointer;
      flex:0 0 auto;
    }
    .knob{
      width:26px;height:26px;border-radius:50%;
      background: rgba(233,230,219,.9);
      position:absolute;top:2px;left:2px;
      transition: .18s ease;
      box-shadow: 0 6px 14px rgba(0,0,0,.35);
    }
    .toggle.on{ border-color: rgba(246,213,107,.35); }
    .toggle.on .knob{ left:28px; background: rgba(246,213,107,.95); }

    .seg{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(216,185,107,.25);
      background: rgba(0,0,0,.18);
      margin-right: 6px;
      margin-bottom: 6px;
      font-weight:900;
      color: var(--ink);
    }
  </style>
</head>
<body>
  <div class="app">

    <div class="topbar">
      <div class="rank" id="rankTag">æ–°å…µ</div>

      <div class="meta">
        <div class="row1">
          <div class="title" id="chapterTitle">å§‹è¨ˆç¯‡ï½œæ¼”ç·´ 1</div>
          <div class="spacer"></div>
        </div>
        <div class="row1">
          <div class="pill"><span class="dot" id="statusDot"></span><span id="statusText">ç›®å‰ç„¡éŒ¯å­—</span></div>
          <div class="pill" id="hintPill">å­¸ç¿’æç¤ºï¼š<b style="color:var(--gold);">é–‹</b></div>
        </div>
      </div>

      <button class="icon-btn" id="btnSettings" aria-label="è¨­å®š"><span class="icon">âš™ï¸</span></button>
      <button class="icon-btn" id="btnBook" aria-label="å…µæ›¸"><span class="icon">ğŸ“œ</span></button>
    </div>

    <div class="npc" id="npcBox" title="é»æˆ‘çœ‹å®Œæ•´ç‰ˆ">
      <div class="npc-badge">å­«æ­¦</div>
      <div class="npc-text" id="npcText">å…ˆé †å£ï¼Œå†ç©©ä½ï¼›ç©©ä½äº†ï¼Œå°±èƒŒèµ·ä¾†ã€‚<span class="more" id="npcMore" style="display:none;">â‹¯</span></div>
    </div>

    <div class="board">
      <div class="board-head">
        <div class="board-title">ä½ˆä»¤æ¿</div>
        <div class="board-stat" id="missText">ç¼ºè©ï¼š5</div>
      </div>

      <div class="slots" id="slots"></div>

      <div class="actions">
        <button class="btn danger" id="btnUndo">æ’¤ä»¤</button>
        <button class="btn" id="btnReset">é‡æ•´</button>
        <button class="btn ok" id="btnCheck">é©—ä»¤</button>
      </div>

      <button class="btn gold" id="btnDrill" style="display:none;">åŠ ç·´ï¼ˆå¯é¸ï¼‰</button>
    </div>

    <div class="cards">
      <div class="cards-head">
        <div class="cards-title">ä»¤ç‰Œå€</div>
        <div class="cards-pages" id="pageText">1/1</div>
      </div>
      <div class="card-grid" id="cardGrid"></div>
    </div>

  </div>

  <!-- Modalï¼šé€šç”¨ -->
  <div class="modal" id="modal">
    <div class="modal-box">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">å…µæ›¸</div>
        <button class="modal-close" id="modalClose">âœ•</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions" id="modalActions"></div>
    </div>
  </div>

<script>
(() => {
  // ===== è³‡æ–™ï¼šå…ˆåšå§‹è¨ˆç¯‡ä¸€å°æ®µï¼ˆv1æ¸¬æ¶æ§‹ï¼‰ =====
  // æ¨™é»ï¼šç›®å‰æ¡ã€Œå¸¶æ¨™é»åŸæ–‡ã€é¡¯ç¤ºæ–¼å…µæ›¸ï¼›å­¸ç¿’æ‹¼å¥ä»¥è©ç‰Œç‚ºä¸»ï¼ˆä¸åš´è‹›è€ƒè©¦ï¼‰
  const levels = [
    {
      chapter: "å§‹è¨ˆç¯‡",
      title: "æ¼”ç·´ 1",
      segments: ["å…µè€…", "åœ‹ä¹‹å¤§äº‹", "æ­»ç”Ÿä¹‹åœ°", "å­˜äº¡ä¹‹é“", "ä¸å¯ä¸å¯Ÿä¹Ÿ"],
      original: "å…µè€…ï¼Œåœ‹ä¹‹å¤§äº‹ï¼Œæ­»ç”Ÿä¹‹åœ°ï¼Œå­˜äº¡ä¹‹é“ï¼Œä¸å¯ä¸å¯Ÿä¹Ÿã€‚",
      translation: "ã€ç™½è©±ã€‘æˆ°çˆ­æ˜¯åœ‹å®¶çš„å¤§äº‹ï¼Œé—œä¿‚åˆ°è»æ°‘çš„ç”Ÿæ­»ã€åœ‹å®¶çš„å­˜äº¡ï¼Œå› æ­¤çµ•å°ä¸å¯ä¸ä»”ç´°å¯©å¯Ÿã€‚",
    },
    {
      chapter: "å§‹è¨ˆç¯‡",
      title: "æ¼”ç·´ 2",
      segments: ["ä¸€æ›°é“", "äºŒæ›°å¤©", "ä¸‰æ›°åœ°", "å››æ›°å°‡", "äº”æ›°æ³•"],
      original: "ä¸€æ›°é“ï¼ŒäºŒæ›°å¤©ï¼Œä¸‰æ›°åœ°ï¼Œå››æ›°å°‡ï¼Œäº”æ›°æ³•ã€‚",
      translation: "ã€ç™½è©±ã€‘ç”¨å…µè¦çœ‹äº”ä»¶äº‹ï¼šé“ï¼ˆä¸Šä¸‹åŒå¿ƒï¼‰ã€å¤©ï¼ˆå¤–åœ¨ç¯€å¥ï¼‰ã€åœ°ï¼ˆåœ°å½¢é è¿‘ï¼‰ã€å°‡ï¼ˆå°‡é ˜ç´ è³ªï¼‰ã€æ³•ï¼ˆåˆ¶åº¦ç·¨åˆ¶ï¼‰ã€‚",
    }
  ];

  // ===== ç‹€æ…‹ =====
  const state = {
    idx: 0,
    selected: [],
    pool: [],
    hintOn: true,          // å­¸ç¿’æç¤ºï¼šé è¨­é–‹
    soundOn: false,        // æœ‰è²æœ—è®€ï¼šå…ˆä¸åšï¼ˆä¿ç•™é–‹é—œï¼‰
    fontStep: 18,          // 16/18/20/22
    bookArmed: false,      // é©—ä»¤é€šéå¾Œï¼Œå…µæ›¸æŒ‰éˆ•æç¤ºå‘¼å¸ç‡ˆ
    firstTime: true,       // æ•™å­¸åªé¡¯ç¤ºä¸€æ¬¡
  };

  // ===== DOM =====
  const rankTag = document.getElementById("rankTag");
  const chapterTitle = document.getElementById("chapterTitle");
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const hintPill = document.getElementById("hintPill");
  const btnSettings = document.getElementById("btnSettings");
  const btnBook = document.getElementById("btnBook");
  const npcBox = document.getElementById("npcBox");
  const npcText = document.getElementById("npcText");
  const npcMore = document.getElementById("npcMore");
  const slots = document.getElementById("slots");
  const missText = document.getElementById("missText");
  const cardGrid = document.getElementById("cardGrid");
  const pageText = document.getElementById("pageText");

  const btnUndo = document.getElementById("btnUndo");
  const btnReset = document.getElementById("btnReset");
  const btnCheck = document.getElementById("btnCheck");
  const btnDrill = document.getElementById("btnDrill");

  const modal = document.getElementById("modal");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const modalActions = document.getElementById("modalActions");
  const modalClose = document.getElementById("modalClose");

  // ===== å·¥å…· =====
  const shuffle = (arr) => arr.slice().sort(() => Math.random() - 0.5);

  function setFont(step){
    state.fontStep = step;
    document.documentElement.style.setProperty("--fs", step + "px");
  }

  function setHint(on){
    state.hintOn = on;
    hintPill.innerHTML = `å­¸ç¿’æç¤ºï¼š<b style="color:var(--gold);">${on ? "é–‹" : "é—œ"}</b>`;
    renderCards();
    updateNpc();
  }

  function setBookBreath(on){
    state.bookArmed = on;
    if(on) btnBook.classList.add("breath");
    else btnBook.classList.remove("breath");
  }

  function setRank(){
    // å…ˆç°¡å–®åšï¼šä¾å®Œæˆæ®µè½æ•¸å‡éšï¼ˆå¾ŒçºŒå¯æ“´å……æ•´æœ¬ï¼‰
    // æ–°å…µ -> ä¼é•· -> ä»€é•· -> ç™¾å¤«é•· -> æ ¡å°‰ -> å°‡è»
    const tiers = ["æ–°å…µ","ä¼é•·","ä»€é•·","ç™¾å¤«é•·","æ ¡å°‰","å°‡è»"];
    const cleared = parseInt(localStorage.getItem("sunzi_cleared") || "0", 10);
    const t = Math.min(tiers.length - 1, Math.floor(cleared / 3));
    rankTag.textContent = tiers[t];
  }

  function speakLikeSunWu(kind="neutral"){
    // ã€Œä¸å…‡ã€ç™½è©±ã€éç½é ­ã€ï¼šä¾ç•¶ä¸‹ç‹€æ…‹éš¨æ©Ÿ
    const pools = {
      start: [
        "å…ˆé †å£ï¼Œå†ç©©ä½ï¼›ç©©ä½äº†ï¼Œå°±èƒŒèµ·ä¾†ã€‚",
        "ä¸ç”¨æ€¥ã€‚ä½ åªè¦æ¯”å‰›å‰›æ›´é †ä¸€é»ï¼Œå°±å¤ äº†ã€‚",
        "ä»Šå¤©åªæ±‚ä¸€ä»¶äº‹ï¼šæŠŠé€™å¥å¿µå¾—é †ã€‚"
      ],
      hintOn: [
        "çœ‹äº®çš„é‚£å¼µï¼Œå…ˆè·Ÿè‘—èµ°ä¸€è¼ªã€‚",
        "å…ˆé æç¤ºèµ°é †ï¼Œé †äº†å†é—œæ‰ã€‚",
        "å…ˆæŠŠè·¯èµ°é€šï¼Œå†è«‡é€Ÿåº¦ã€‚"
      ],
      hintOff: [
        "å¥½ï¼Œç¾åœ¨å°±é ä½ è‡ªå·±åˆ¤æ–·ã€‚",
        "æç¤ºé—œæ‰äº†ï¼Œåè€Œæ›´å®¹æ˜“è¨˜ç‰¢ã€‚",
        "é€™è¼ªä½ è‡ªå·±å¸¶éšŠï¼Œæˆ‘åœ¨æ—é‚Šçœ‹ã€‚"
      ],
      win: [
        "ç©©ã€‚ä½ ä¸æ˜¯é çŒœï¼Œæ˜¯é é †å£æ¥èµ·ä¾†çš„ã€‚",
        "é€™å¥ä½ å·²ç¶“èƒ½ä¸€å£æ°£æ¥ä½äº†ï¼Œä¸éŒ¯ã€‚",
        "åšå¾—å¥½ã€‚ä¸‹ä¸€å¥ï¼Œç…§é€™ç¯€å¥èµ°å°±è¡Œã€‚"
      ],
      miss: [
        "æ²’é—œä¿‚ï¼Œå‰›å‰›åªæ˜¯é †åºäº‚äº†ã€‚é‡æ•´ä¸€ä¸‹å°±å›ä¾†ã€‚",
        "ä½ ä¸æ˜¯å¿˜ï¼Œæ˜¯é‚„æ²’æ¥é †ã€‚å†èµ°ä¸€è¼ªå°±å¥½ã€‚",
        "å…ˆæŠŠå‰å…©å¼µæ¥ç·Šï¼Œå¾Œé¢è‡ªç„¶è·Ÿä¸Šã€‚"
      ],
      drill: [
        "åŠ ç·´ä¸é•·ï¼Œ20ç§’å°±å¥½ã€‚ä½ æœƒæ›´ç©©ã€‚",
        "é€™æ¬¡åªæŠ½ä¸€å°æ®µï¼Œè®“ä½ æ„Ÿè¦ºè‡ªå·±æ›´ç†Ÿã€‚",
        "åŠ ç·´ä¸€ä¸‹å°±æ”¶å·¥ï¼Œåˆ¥æŠŠè‡ªå·±é€¼æ€¥ã€‚"
      ]
    };

    const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];
    if(kind === "start") return pick(pools.start);
    if(kind === "win") return pick(pools.win);
    if(kind === "miss") return pick(pools.miss);
    if(kind === "drill") return pick(pools.drill);
    return state.hintOn ? pick(pools.hintOn) : pick(pools.hintOff);
  }

  function updateNpc(kind="neutral"){
    const msg = speakLikeSunWu(kind);
    npcText.textContent = msg;
    // è¶…éä¸‰è¡Œæœƒè¢« clampï¼Œé¡¯ç¤ºâ‹¯æç¤ºï¼ˆä¿å®ˆåšæ³•ï¼šç”¨é•·åº¦åˆ¤æ–·ï¼‰
    npcMore.style.display = (msg.length > 26) ? "inline" : "none";
  }

  function flashSlot(i){
    const el = document.querySelector(`[data-slot="${i}"]`);
    if(!el) return;
    el.classList.remove("flash");
    void el.offsetWidth;
    el.classList.add("flash");
  }

  // ===== æ¸²æŸ“ =====
  function loadLevel(i){
    state.idx = i;
    const lv = levels[state.idx];

    chapterTitle.textContent = `${lv.chapter}ï½œ${lv.title}`;
    state.selected = [];
    state.pool = shuffle(lv.segments);

    setBookBreath(false);
    btnDrill.style.display = "none";

    statusDot.style.background = "var(--ok)";
    statusText.textContent = "ç›®å‰ç„¡éŒ¯å­—";
    missText.textContent = `ç¼ºè©ï¼š${lv.segments.length}`;

    updateNpc("start");

    renderSlots();
    renderCards();

    // æ•™å­¸ï¼šåªé¡¯ç¤ºä¸€æ¬¡
    const taught = localStorage.getItem("sunzi_taught") === "1";
    if(!taught){
      showTutorial();
      localStorage.setItem("sunzi_taught", "1");
    }

    setRank();
  }

  function renderSlots(){
    const lv = levels[state.idx];
    slots.innerHTML = "";
    for(let i=0;i<lv.segments.length;i++){
      const s = document.createElement("div");
      s.className = "slot";
      s.dataset.slot = i;
      s.textContent = "ã€€";
      slots.appendChild(s);
    }
  }

  function renderSlotsFilled(){
    const lv = levels[state.idx];
    for(let i=0;i<lv.segments.length;i++){
      const el = document.querySelector(`[data-slot="${i}"]`);
      if(!el) continue;
      if(state.selected[i]){
        el.classList.add("filled");
        el.textContent = state.selected[i];
      }else{
        el.classList.remove("filled");
        el.textContent = "ã€€";
      }
    }
    const miss = lv.segments.length - state.selected.length;
    missText.textContent = `ç¼ºè©ï¼š${miss}`;
  }

  function renderCards(){
    cardGrid.innerHTML = "";
    pageText.textContent = "1/1"; // v1å…ˆä¸åšç¿»é ï¼Œé¿å…æ‰‹æ©Ÿæµç¨‹è®Šè¤‡é›œ

    const lv = levels[state.idx];
    const nextNeed = lv.segments[state.selected.length];

    state.pool.forEach((seg) => {
      const c = document.createElement("div");
      c.className = "card";
      c.textContent = seg;

      if(state.hintOn && seg === nextNeed){
        c.classList.add("hint"); // æ›´äº®æ›´æ…¢
      }

      c.addEventListener("click", () => {
        // é»ä»¤ç‰Œï¼šç›´æ¥å¡«å…¥ä¸‹ä¸€æ ¼ï¼ˆæ›´ç›´è¦ºï¼‰
        state.selected.push(seg);
        const pos = state.pool.indexOf(seg);
        if(pos >= 0) state.pool.splice(pos,1);

        renderSlotsFilled();
        flashSlot(state.selected.length-1);
        renderCards();
      });

      cardGrid.appendChild(c);
    });

    // è‹¥å·²å¡«æ»¿ï¼šä»¤ç‰Œå€é¡¯ç¤ºç©ºç™½ï¼ˆé¿å…èª¤é»ï¼‰
    if(state.selected.length === lv.segments.length){
      cardGrid.innerHTML = "";
      const p = document.createElement("div");
      p.className = "tiny";
      p.style.padding = "6px 2px";
      p.textContent = "ä»¤ç‰Œå·²ç”¨ç›¡ã€‚æŒ‰ã€Œé©—ä»¤ã€ç¢ºèªï¼Œæˆ–ã€Œæ’¤ä»¤ï¼é‡æ•´ã€èª¿æ•´ã€‚";
      cardGrid.appendChild(p);
    }
  }

  // ===== æ“ä½œ =====
  btnUndo.addEventListener("click", () => {
    if(state.selected.length === 0) return;
    const last = state.selected.pop();
    state.pool = shuffle([last, ...state.pool]); // é€€å›ä»¤ç‰Œï¼šæ··å›æ± ï¼Œé¿å…å›ºå®šä½ç½®
    renderSlotsFilled();
    renderCards();
  });

  btnReset.addEventListener("click", () => {
    loadLevel(state.idx);
  });

  btnCheck.addEventListener("click", () => {
    const lv = levels[state.idx];
    if(state.selected.length !== lv.segments.length){
      updateNpc("neutral");
      statusDot.style.background = "var(--danger)";
      statusText.textContent = "é‚„æ²’å®Œæˆä½ˆä»¤";
      return;
    }

    // é©—ä»¤ï¼šé †åºéœ€ä¸€è‡´ï¼ˆèƒŒèª¦æ ¸å¿ƒï¼‰
    const ok = lv.segments.every((s,i)=> state.selected[i] === s);

    if(ok){
      statusDot.style.background = "var(--ok)";
      statusText.textContent = "é©—ä»¤é€šéï¼ˆç©©ï¼‰";
      updateNpc("win");

      // å…µæ›¸æŒ‰éˆ•å‘¼å¸ç‡ˆæç¤º
      setBookBreath(true);

      // é¡¯ç¤ºã€ŒåŠ ç·´ï¼ˆå¯é¸ï¼‰ã€
      btnDrill.style.display = "block";

      // è¨˜éŒ„é€²åº¦ï¼ˆç”¨æ–¼å‡éšï¼‰
      const cleared = parseInt(localStorage.getItem("sunzi_cleared") || "0", 10);
      localStorage.setItem("sunzi_cleared", String(Math.max(cleared, state.idx + 1)));
      setRank();

      // ç›´æ¥å½ˆå‡ºå…µæ›¸ï¼ˆä½ å¸Œæœ›é è¨­é–‹å•Ÿï¼‰
      openBookModal(true);

    }else{
      statusDot.style.background = "var(--danger)";
      statusText.textContent = "é©—ä»¤æœªéï¼ˆé †åºäº‚ï¼‰";
      updateNpc("miss");
    }
  });

  // ===== å…µæ›¸ =====
  function openBookModal(fromWin=false){
    const lv = levels[state.idx];
    modalTitle.textContent = fromWin ? "é©—ä»¤é€šéï½œå…µæ›¸" : "å…µæ›¸";
    modalBody.innerHTML = `
      <div class="quote">${lv.original}</div>
      <div class="explain">${lv.translation}</div>
    `;

    modalActions.innerHTML = "";
    const btnReplay = document.createElement("button");
    btnReplay.className = "btn";
    btnReplay.textContent = "å†æ¼”ç·´";
    btnReplay.onclick = () => { closeModal(); loadLevel(state.idx); };

    const btnNext = document.createElement("button");
    btnNext.className = "btn gold";
    btnNext.textContent = "ä¸‹ä¸€æ®µ";
    btnNext.onclick = () => {
      closeModal();
      const next = (state.idx + 1) % levels.length;
      loadLevel(next);
    };

    modalActions.appendChild(btnReplay);
    modalActions.appendChild(btnNext);

    setBookBreath(false); // é»é–‹å°±ä¸å†æç¤º
    showModal();
  }

  btnBook.addEventListener("click", () => openBookModal(false));

  // ===== åŠ ç·´ï¼ˆå¯é¸ï¼‰ï¼šçŸ­æ¸¬ï¼Œä¸è€ƒå€’ =====
  btnDrill.addEventListener("click", () => {
    const lv = levels[state.idx];
    updateNpc("drill");

    // é¡Œå‹ï¼šæŠ½ä¸€å€‹ä½ç½®ï¼Œå•ã€Œä¸‹ä¸€è©æ‡‰è©²æ˜¯ï¼Ÿã€ï¼ˆå››é¸ä¸€ï¼‰
    const pos = Math.floor(Math.random() * lv.segments.length);
    const answer = lv.segments[pos];

    const distract = shuffle(lv.segments.filter(s => s !== answer)).slice(0, 3);
    const options = shuffle([answer, ...distract]);

    modalTitle.textContent = "åŠ ç·´ï¼ˆ20ç§’ï¼‰";
    modalBody.innerHTML = `
      <div class="tiny">ä¸è€ƒå€’ä½ ï¼Œåªè®“ä½ æ›´ç©©ã€‚</div>
      <div style="margin-top:10px;">
        <b style="color:var(--gold); letter-spacing:.06em;">é¡Œç›®ï¼š</b>
        <div style="margin-top:6px;">
          è«‹é¸å‡ºç¬¬ <b style="color:var(--gold)">${pos+1}</b> å€‹è©ç‰Œ
        </div>
      </div>
      <div style="margin-top:10px;">
        ${lv.segments.map((s,i)=> `<span class="seg" style="opacity:${i===pos?1:0.25}">${i===pos?"ï¼Ÿ":s}</span>`).join("")}
      </div>
    `;

    modalActions.innerHTML = "";
    options.forEach(opt => {
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = opt;
      b.onclick = () => {
        if(opt === answer){
          modalTitle.textContent = "åŠ ç·´é€šéï¼ˆæ›´ç©©ï¼‰";
          modalBody.innerHTML = `
            <div class="quote">${lv.original}</div>
            <div class="explain">ä½ å‰›å‰›æŠŠã€Œä½ç½®æ„Ÿã€æŠ“åˆ°äº†ï¼ŒèƒŒèµ·ä¾†æœƒæ›´çœåŠ›ã€‚</div>
          `;
          modalActions.innerHTML = "";
          const okBtn = document.createElement("button");
          okBtn.className = "btn gold";
          okBtn.textContent = "å›æˆ°å ´";
          okBtn.onclick = () => closeModal();
          modalActions.appendChild(okBtn);
        }else{
          modalTitle.textContent = "å·®ä¸€é»é»";
          modalBody.innerHTML = `
            <div class="explain">æ²’é—œä¿‚ï¼Œç­”æ¡ˆæ˜¯ï¼š<b style="color:var(--gold)">${answer}</b>ã€‚å†çœ‹ä¸€çœ¼é †åºï¼Œä½ æœƒæ›´å¿«æ¥èµ·ä¾†ã€‚</div>
          `;
          modalActions.innerHTML = "";
          const back = document.createElement("button");
          back.className = "btn";
          back.textContent = "å›æˆ°å ´";
          back.onclick = () => closeModal();
          modalActions.appendChild(back);
        }
      };
      modalActions.appendChild(b);
    });

    showModal();
  });

  // ===== è¨­å®š =====
  btnSettings.addEventListener("click", () => {
    modalTitle.textContent = "è¨­å®š";
    modalBody.innerHTML = `
      <div class="tiny">v1.1 å…ˆæŠŠã€Œå¥½èƒŒã€å¥½ç©ã€ä¸ç”¨æ»‘ã€ç«™ç©©ã€‚æœ—è®€æœ‰è²ç‰ˆå…ˆä¿ç•™åˆ°å¾ŒçºŒé©šå–œã€‚</div>
      <div class="settings-grid">
        <div class="set-row">
          <b>å­¸ç¿’æç¤º</b>
          <div class="toggle ${state.hintOn ? "on":""}" id="togHint"><div class="knob"></div></div>
        </div>
        <div class="set-row">
          <b>æœ—è®€éŸ³æ•ˆï¼ˆä¿ç•™ï¼‰</b>
          <div class="toggle ${state.soundOn ? "on":""}" id="togSound"><div class="knob"></div></div>
        </div>
        <div class="set-row">
          <b>å­—é«”å¤§å°</b>
          <div style="display:flex; gap:8px;">
            <button class="btn" style="height:40px; width:70px;" id="fsDown">å°</button>
            <button class="btn gold" style="height:40px; width:70px;" id="fsUp">å¤§</button>
          </div>
        </div>
      </div>
    `;
    modalActions.innerHTML = "";
    const done = document.createElement("button");
    done.className = "btn gold";
    done.textContent = "å®Œæˆ";
    done.onclick = () => closeModal();
    modalActions.appendChild(done);

    showModal();

    // ç¶å®š
    setTimeout(() => {
      const th = document.getElementById("togHint");
      const ts = document.getElementById("togSound");
      const up = document.getElementById("fsUp");
      const dn = document.getElementById("fsDown");

      if(th) th.onclick = () => setHint(!state.hintOn);
      if(ts) ts.onclick = () => {
        state.soundOn = !state.soundOn;
        ts.classList.toggle("on", state.soundOn);
      };

      const steps = [16,18,20,22];
      if(up) up.onclick = () => {
        const i = steps.indexOf(state.fontStep);
        setFont(steps[Math.min(steps.length-1, i+1)]);
      };
      if(dn) dn.onclick = () => {
        const i = steps.indexOf(state.fontStep);
        setFont(steps[Math.max(0, i-1)]);
      };
    }, 0);
  });

  // ===== å­«æ­¦å°è©±å±•é–‹ï¼ˆé»å°è©±æ¡†ï¼‰ =====
  npcBox.addEventListener("click", () => {
    modalTitle.textContent = "å­«æ­¦ï¼ˆå®Œæ•´ç‰ˆï¼‰";
    modalBody.innerHTML = `
      <div class="quote">${npcText.textContent}</div>
      <div class="explain">æç¤ºï¼šä½ ä¸ç”¨ä¸€æ¬¡èƒŒå®Œã€‚åªè¦æ¯è¼ªæ¯”ä¸Šä¸€è¼ªé †ä¸€é»ï¼Œå°±æœƒè¶Šä¾†è¶Šç©©ã€‚</div>
    `;
    modalActions.innerHTML = "";
    const back = document.createElement("button");
    back.className = "btn gold";
    back.textContent = "å›æˆ°å ´";
    back.onclick = () => closeModal();
    modalActions.appendChild(back);
    showModal();
  });

  // ===== Modal æ§åˆ¶ =====
  modalClose.addEventListener("click", closeModal);
  modal.addEventListener("click", (e) => { if(e.target === modal) closeModal(); });

  function showModal(){ modal.classList.add("show"); }
  function closeModal(){ modal.classList.remove("show"); }

  // ===== æ•™å­¸ï¼ˆä¸€æ¬¡æ€§ï¼‰ =====
  function showTutorial(){
    modalTitle.textContent = "æ–°å…µç°¡å ±ï¼ˆä¸€æ¬¡ï¼‰";
    modalBody.innerHTML = `
      <div class="tiny">
        1) é»ä¸‹æ–¹ã€Œä»¤ç‰Œã€â†’ æœƒè‡ªå‹•å¡«å…¥ä½ˆä»¤æ¿ä¸‹ä¸€æ ¼ã€‚<br>
        2) æŒ‰ã€Œé©—ä»¤ã€â†’ ä½ æœƒçŸ¥é“é †åºæ˜¯å¦ç©©ã€‚<br>
        3) é©—ä»¤é€šéå¾Œï¼Œå³ä¸Šè§’ã€Œå…µæ›¸ã€æœƒäº®ï¼Œé»é–‹çœ‹ç™½è©±è§£é‡‹ã€‚<br><br>
        <b style="color:var(--gold);">é€™ä¸æ˜¯è€ƒè©¦ã€‚</b> ä½ çš„ç›®æ¨™åªæœ‰ä¸€ä»¶äº‹ï¼šè¶ŠèƒŒè¶Šé †ã€‚
      </div>
    `;
    modalActions.innerHTML = "";
    const okBtn = document.createElement("button");
    okBtn.className = "btn gold";
    okBtn.textContent = "æ‡‚äº†ï¼Œé–‹ç·´";
    okBtn.onclick = () => closeModal();
    modalActions.appendChild(okBtn);
    showModal();
  }

  // ===== åˆå§‹åŒ– =====
  setFont(state.fontStep);
  setHint(true);
  loadLevel(0);

})();
</script>
</body>
</html>
