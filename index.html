<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>孫子兵法｜沉浸式佈令（Demo）</title>
  <style>
    :root{
      --bg:#07110d;
      --panel:#0d1b14;
      --panel2:#0a1510;
      --ink:#e8f1ea;
      --muted:#a6b7ad;
      --gold:#c7a56a;
      --gold2:#8c7449;
      --line:rgba(199,165,106,.22);
      --good:#2c7a55;
      --bad:#7a2c2c;
      --shadow:rgba(0,0,0,.45);
      --radius:18px;
      --fs: 18px; /* 由設定滑桿控制 */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 50% -150px, rgba(199,165,106,.22), transparent 60%),
                  linear-gradient(180deg, #04100b, var(--bg));
      color:var(--ink);
      font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      font-size: var(--fs);
      letter-spacing:.2px;
    }
    a,button{font:inherit}
    .app{
      max-width: 480px;
      margin: 0 auto;
      min-height: 100svh;
      padding: 14px 14px 22px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(8,18,13,.65);
      box-shadow: 0 10px 30px var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 30;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      flex-direction:column;
      line-height:1.15;
      padding-left:4px;
    }
    .brand .t{
      font-weight:700;
      font-size: 1.02em;
      letter-spacing:.6px;
    }
    .brand .s{
      color:var(--muted);
      font-size: .86em;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 250px;
    }
    .top-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(10,21,16,.72);
      color:var(--ink);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .pill:hover{border-color: rgba(199,165,106,.45)}
    .pill.primary{
      background: linear-gradient(180deg, rgba(199,165,106,.25), rgba(199,165,106,.08));
      border-color: rgba(199,165,106,.55);
    }
    .card{
      margin-top: 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(10,21,16,.55);
      box-shadow: 0 18px 40px var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd .left{min-width:0}
    .h1{
      font-size: 1.15em;
      font-weight:800;
      letter-spacing:.6px;
      margin:0;
    }
    .sub{
      color:var(--muted);
      font-size:.9em;
      margin-top:6px;
      line-height:1.35;
    }
    .stars{
      display:flex;
      gap:4px;
      align-items:center;
      justify-content:flex-end;
      min-width: 120px;
    }
    .star{
      width: 16px;
      height: 16px;
      display:inline-block;
      filter: drop-shadow(0 1px 4px rgba(0,0,0,.45));
      opacity:.9;
    }
    .star svg{width:100%;height:100%}
    .star.on svg path{fill: rgba(199,165,106,.95)}
    .star.off svg path{fill: rgba(199,165,106,.18)}
    .list{
      padding: 10px 10px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: calc(100svh - 170px);
      overflow:auto; /* ✅ 總覽可滑 */
    }
    .row{
      border:1px solid rgba(199,165,106,.18);
      background: rgba(7,15,11,.35);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
    }
    .row:hover{border-color: rgba(199,165,106,.35)}
    .row .name{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .row .name .t{
      font-weight:800;
      font-size: 1.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 260px;
    }
    .row .name .s{
      color:var(--muted);
      font-size:.85em;
    }
    .row .right{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(10,21,16,.72);
      color:var(--ink);
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      min-width: 92px;
      text-align:center;
    }
    .btn:hover{border-color: rgba(199,165,106,.45)}
    .btn.good{
      background: linear-gradient(180deg, rgba(44,122,85,.35), rgba(44,122,85,.12));
      border-color: rgba(44,122,85,.55);
    }
    .btn.bad{
      background: linear-gradient(180deg, rgba(122,44,44,.35), rgba(122,44,44,.12));
      border-color: rgba(122,44,44,.55);
    }

    /* 章首頁 */
    .chapter-hero{
      padding: 14px;
      border-top:1px solid rgba(199,165,106,.12);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .hero-quote{
      border:1px solid rgba(199,165,106,.18);
      background: rgba(7,15,11,.35);
      border-radius: 16px;
      padding: 12px;
      line-height:1.45;
      color: rgba(232,241,234,.95);
    }
    .hero-actions{
      display:flex;
      gap:10px;
    }
    .hero-actions .btn{flex:1}

    /* 段落頁 */
    .segment-wrap{padding: 14px}
    .seg-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .seg-title{
      font-weight:900;
      font-size:1.05em;
      margin:0;
    }
    .seg-badges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .badge{
      border:1px solid rgba(199,165,106,.18);
      background: rgba(7,15,11,.35);
      padding: 8px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size:.85em;
      cursor:pointer;
      user-select:none;
    }
    .badge.on{
      border-color: rgba(199,165,106,.55);
      color: rgba(232,241,234,.95);
      background: linear-gradient(180deg, rgba(199,165,106,.18), rgba(199,165,106,.08));
    }
    .mentor{
      margin-top: 12px;
      border:1px solid rgba(199,165,106,.18);
      background: rgba(7,15,11,.35);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .avatar{
      width:54px;height:54px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(199,165,106,.25), rgba(199,165,106,.08));
      border:1px solid rgba(199,165,106,.35);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      color: rgba(232,241,234,.95);
      flex:0 0 auto;
    }
    .mentor .txt{min-width:0}
    .mentor .txt .who{font-weight:900; margin-bottom:4px}
    .mentor .txt .line{
      color: rgba(232,241,234,.92);
      line-height:1.45;
      word-break:break-word;
    }
    .morelink{
      color: var(--gold);
      font-weight:800;
      cursor:pointer;
      margin-left: 6px;
      white-space:nowrap;
    }
    .board{
      margin-top: 12px;
      border:1px dashed rgba(199,165,106,.25);
      background: rgba(7,15,11,.25);
      border-radius: 16px;
      padding: 12px;
      position: relative;
    }
    .board-hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .board-hd .t{
      font-weight:900;
      color: rgba(232,241,234,.95);
    }
    .hint-dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(199,165,106,.25);
      box-shadow: 0 0 0 rgba(199,165,106,0);
    }
    .hint-dot.breathe{
      animation: pulseStrong 1.2s ease-in-out 1;
    }
    .hint-dot.breathe2{animation: pulseMid 1.2s ease-in-out 1;}
    .hint-dot.breathe3{animation: pulseSoft 1.2s ease-in-out 1;}
    @keyframes pulseStrong{
      0%{box-shadow: 0 0 0 0 rgba(199,165,106,.0)}
      40%{box-shadow: 0 0 26px 10px rgba(199,165,106,.55)}
      100%{box-shadow: 0 0 0 0 rgba(199,165,106,.0)}
    }
    @keyframes pulseMid{
      0%{box-shadow: 0 0 0 0 rgba(199,165,106,.0)}
      40%{box-shadow: 0 0 22px 8px rgba(199,165,106,.40)}
      100%{box-shadow: 0 0 0 0 rgba(199,165,106,.0)}
    }
    @keyframes pulseSoft{
      0%{box-shadow: 0 0 0 0 rgba(199,165,106,.0)}
      40%{box-shadow: 0 0 18px 6px rgba(199,165,106,.28)}
      100%{box-shadow: 0 0 0 0 rgba(199,165,106,.0)}
    }

    .slots{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .slot{
      border:1px solid rgba(199,165,106,.18);
      background: rgba(10,21,16,.55);
      border-radius: 14px;
      padding: 12px 10px;
      min-height: 52px;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(232,241,234,.92);
      font-weight:900;
      text-align:center;
      line-height:1.15;
      cursor:pointer;
      user-select:none;
      position: relative;
    }
    .slot.empty{
      color: rgba(166,183,173,.65);
      font-weight:700;
    }

    .tokens{
      margin-top: 12px;
      border-top:1px solid rgba(199,165,106,.12);
      padding-top: 12px;
    }
    .tokens-hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
      color: var(--muted);
      font-size:.9em;
    }
    .token-grid{
      display:grid;
      grid-template-columns: 1fr 1fr; /* ✅ 不分頁，固定兩欄 */
      gap:10px;
    }
    .token{
      border:1px solid rgba(199,165,106,.18);
      background: rgba(7,15,11,.35);
      border-radius: 14px;
      padding: 14px 10px;
      font-weight:900;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .token:hover{border-color: rgba(199,165,106,.40)}
    .token.used{
      opacity:.35;
      cursor:not-allowed;
    }

    .actions{
      margin-top: 12px;
      display:flex;
      gap:10px;
    }
    .actions .btn{flex:1}
    .actions .btn.small{min-width:0}

    /* 設定 Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 80;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(480px, 100%);
      border:1px solid rgba(199,165,106,.25);
      border-radius: 18px;
      background: rgba(10,21,16,.92);
      box-shadow: 0 20px 60px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modal .mh{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(199,165,106,.12);
    }
    .modal .mh .t{font-weight:900}
    .modal .mc{padding: 14px}
    .field{
      border:1px solid rgba(199,165,106,.18);
      background: rgba(7,15,11,.35);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .field .label{
      color: var(--muted);
      font-size:.9em;
      margin-bottom: 8px;
    }
    .switch{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    input[type="range"]{width:100%}
    .danger{
      border-color: rgba(122,44,44,.45);
    }

    /* 小工具 */
    .hidden{display:none !important}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="t" id="topTitle">孫子兵法　篇章總覽</div>
        <div class="s" id="topSub">依原書順序｜可自由進入練習</div>
      </div>
      <div class="top-actions">
        <button class="pill primary" id="btnOverview">總覽</button>
        <button class="pill" id="btnSettings">設定</button>
      </div>
    </div>

    <!-- VIEW: Overview -->
    <div class="card" id="viewOverview">
      <div class="hd">
        <div class="left">
          <h2 class="h1">篇章總覽</h2>
          <div class="sub">星星＝段落數；亮星＝已完成段落。</div>
        </div>
      </div>
      <div class="list" id="chapterList"></div>
    </div>

    <!-- VIEW: Chapter Home -->
    <div class="card hidden" id="viewChapter">
      <div class="hd">
        <div class="left">
          <h2 class="h1" id="chTitle">第一篇 始計篇</h2>
          <div class="sub" id="chDesc">先把一小段背順，整本就會慢慢變得可親。</div>
        </div>
        <div class="stars" id="chStars"></div>
      </div>
      <div class="chapter-hero">
        <div class="hero-quote" id="chPreview">
          「兵者，國之大事也；死生之地，存亡之道，不可不察也。」
          <div class="muted" style="margin-top:6px;font-size:.9em;">（Demo 先放一段示意，之後可換成完整原文＋朗讀）</div>
        </div>
        <div class="hero-actions">
          <button class="btn good" id="btnStartChapter">開始佈令</button>
          <button class="btn" id="btnRestartChapter">從頭重練</button>
        </div>
        <div class="mentor">
          <div class="avatar">孫武</div>
          <div class="txt">
            <div class="who">孫武</div>
            <div class="line" id="chCoach">今天只要記住一段，就很夠了。</div>
          </div>
          <button class="btn" id="btnReadChapter" style="min-width:92px">朗讀</button>
        </div>
      </div>
    </div>

    <!-- VIEW: Segment -->
    <div class="card hidden" id="viewSegment">
      <div class="segment-wrap">
        <div class="seg-top">
          <div>
            <div class="muted" id="segPath">第一篇 始計篇</div>
            <h2 class="seg-title" id="segTitle">第1段</h2>
          </div>
          <div class="seg-badges">
            <div class="badge on" id="badgeHints">學習提示：開</div>
            <div class="badge" id="badgeMode">模式：學習</div>
            <div class="badge" id="badgeTestRange">測驗範圍</div>
          </div>
        </div>

        <div class="mentor">
          <div class="avatar">孫武</div>
          <div class="txt">
            <div class="who">孫武</div>
            <div class="line" id="coachLine"></div>
          </div>
          <button class="btn" id="btnCoachShuffle" title="換一句">↻</button>
        </div>

        <div class="board">
          <div class="board-hd">
            <div class="t">佈令板</div>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="muted" id="missingTxt">缺詞：0</div>
              <div class="hint-dot" id="hintDot"></div>
            </div>
          </div>

          <div class="slots" id="slots"></div>

          <div class="actions">
            <button class="btn bad small" id="btnUndo">退令</button>
            <button class="btn small" id="btnReset">重整</button>
            <button class="btn good small" id="btnCheck">驗令</button>
          </div>

          <div class="tokens">
            <div class="tokens-hd">
              <div>令牌區（點選令牌 → 放入佈令板）</div>
              <div id="remainTxt">剩餘：0</div>
            </div>
            <div class="token-grid" id="tokenGrid"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- SETTINGS MODAL -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="mh">
        <div class="t">設定</div>
        <button class="pill" id="btnCloseSettings">關閉</button>
      </div>
      <div class="mc">
        <div class="field">
          <div class="label">字體大小</div>
          <input type="range" id="fontRange" min="16" max="24" step="1" />
          <div class="muted" style="margin-top:6px;font-size:.9em" id="fontNow">目前：18</div>
        </div>

        <div class="field">
          <div class="label">學習提示</div>
          <div class="switch">
            <div class="muted">在段落頁顯示提示與呼吸燈。</div>
            <button class="pill primary" id="toggleHints">開</button>
          </div>
        </div>

        <div class="field danger">
          <div class="label">清空足跡</div>
          <div class="muted" style="line-height:1.4">
            會將所有篇章進度歸零（不保留）。
          </div>
          <div style="margin-top:10px;display:flex;gap:10px">
            <button class="btn bad" id="btnClearAll" style="flex:1">清空</button>
            <button class="btn" id="btnCancelClear" style="flex:1">取消</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   DATA（Demo：先放第1篇4段）
   ========================= */
const CHAPTERS = [
  { id: 1, title: "第一篇 始計篇", segments: [
    {
      id: 1,
      coachShort: "不用急。你只要比剛剛更順一點，就夠了。",
      coachFull: "不用急。你只要比剛剛更順一點，就夠了。先把順口感練出來，後面的記憶會自己跟上。",
      tokens: ["兵者", "國之大事", "死生之地", "存亡之道", "不可不察也"],
      answer: ["兵者","國之大事","死生之地","存亡之道","不可不察也"]
    },
    {
      id: 2,
      coachShort: "先順口，再穩住；穩住了，就背起來。",
      coachFull: "先順口，再穩住；穩住了，就背起來。別追完美，追「更順」。",
      tokens: ["道", "天", "地", "將", "法"],
      answer: ["道","天","地","將","法"]
    },
    {
      id: 3,
      coachShort: "你不是在硬背，你是在把它放進隊形。",
      coachFull: "你不是在硬背，你是在把它放進隊形。隊形一成，順序就會自己站好。",
      tokens: ["智", "信", "仁", "勇", "嚴"],
      answer: ["智","信","仁","勇","嚴"]
    },
    {
      id: 4,
      coachShort: "慢慢來。能回到正確順序，就算你贏。",
      coachFull: "慢慢來。能回到正確順序，就算你贏。你每一次願意重來，都是在練「定心」。",
      tokens: ["校之以計", "而索其情"],
      answer: ["校之以計","而索其情"]
    },
  ]},
  // 先放幾篇「未收錄」示意：讓總覽可滑
  { id: 2, title: "第二篇 作戰篇", segments: [] },
  { id: 3, title: "第三篇 謀攻篇", segments: [] },
  { id: 4, title: "第四篇 形篇", segments: [] },
  { id: 5, title: "第五篇 勢篇", segments: [] },
  { id: 6, title: "第六篇 虛實篇", segments: [] },
  { id: 7, title: "第七篇 軍爭篇", segments: [] },
  { id: 8, title: "第八篇 九變篇", segments: [] },
  { id: 9, title: "第九篇 行軍篇", segments: [] },
  { id:10, title: "第十篇 地形篇", segments: [] },
  { id:11, title: "第十一篇 九地篇", segments: [] },
  { id:12, title: "第十二篇 火攻篇", segments: [] },
  { id:13, title: "第十三篇 用間篇", segments: [] },
];

const KEY = "sunzi_demo_progress_v1";

/* progress 結構：
{
  hintsOn: true/false,
  fontSize: number,
  chapters: {
    "1": { doneSegments: 2 } // 完成到第幾段（0..n）
  }
}
*/
function loadProgress(){
  const raw = localStorage.getItem(KEY);
  if(!raw){
    return { hintsOn:true, fontSize:18, chapters:{} };
  }
  try{
    const p = JSON.parse(raw);
    return {
      hintsOn: p.hintsOn ?? true,
      fontSize: p.fontSize ?? 18,
      chapters: p.chapters ?? {}
    };
  }catch{
    return { hintsOn:true, fontSize:18, chapters:{} };
  }
}
function saveProgress(p){ localStorage.setItem(KEY, JSON.stringify(p)); }

/* =========================
   UI Helpers
   ========================= */
function starSVG(){
  return `
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 2.5l2.97 6.02 6.64.97-4.8 4.68 1.13 6.61L12 17.9 6.06 20.78l1.13-6.61-4.8-4.68 6.64-.97L12 2.5z"></path>
  </svg>`;
}
function renderStars(container, total, done){
  container.innerHTML = "";
  for(let i=1;i<=total;i++){
    const s = document.createElement("span");
    s.className = "star " + (i<=done ? "on":"off");
    s.innerHTML = starSVG();
    container.appendChild(s);
  }
}
function setFontSize(px){
  document.documentElement.style.setProperty("--fs", px+"px");
}

/* =========================
   State
   ========================= */
const state = {
  view: "overview", // overview | chapter | segment
  chapterId: 1,
  segId: 1,
  mode: "learn", // learn | test
  testRange: null, // {start,end} optional
  expandedCoach: false,
  placed: [], // placed tokens in order
  available: [], // tokens left
  progress: loadProgress()
};

/* =========================
   DOM
   ========================= */
const viewOverview = document.getElementById("viewOverview");
const viewChapter  = document.getElementById("viewChapter");
const viewSegment  = document.getElementById("viewSegment");

const topTitle = document.getElementById("topTitle");
const topSub   = document.getElementById("topSub");

const btnOverview = document.getElementById("btnOverview");
const btnSettings = document.getElementById("btnSettings");

const chapterList = document.getElementById("chapterList");

const chTitle = document.getElementById("chTitle");
const chDesc  = document.getElementById("chDesc");
const chStars = document.getElementById("chStars");
const chPreview = document.getElementById("chPreview");
const chCoach = document.getElementById("chCoach");
const btnStartChapter = document.getElementById("btnStartChapter");
const btnRestartChapter = document.getElementById("btnRestartChapter");
const btnReadChapter = document.getElementById("btnReadChapter");

const segPath  = document.getElementById("segPath");
const segTitle = document.getElementById("segTitle");
const badgeHints = document.getElementById("badgeHints");
const badgeMode  = document.getElementById("badgeMode");
const badgeTestRange = document.getElementById("badgeTestRange");
const coachLine = document.getElementById("coachLine");
const btnCoachShuffle = document.getElementById("btnCoachShuffle");

const slots = document.getElementById("slots");
const tokenGrid = document.getElementById("tokenGrid");
const missingTxt = document.getElementById("missingTxt");
const remainTxt  = document.getElementById("remainTxt");
const hintDot = document.getElementById("hintDot");

const btnUndo = document.getElementById("btnUndo");
const btnReset = document.getElementById("btnReset");
const btnCheck = document.getElementById("btnCheck");

/* Settings modal */
const overlay = document.getElementById("overlay");
const btnCloseSettings = document.getElementById("btnCloseSettings");
const fontRange = document.getElementById("fontRange");
const fontNow = document.getElementById("fontNow");
const toggleHints = document.getElementById("toggleHints");
const btnClearAll = document.getElementById("btnClearAll");
const btnCancelClear = document.getElementById("btnCancelClear");

/* =========================
   Navigation
   ========================= */
function show(view){
  state.view = view;
  viewOverview.classList.toggle("hidden", view!=="overview");
  viewChapter.classList.toggle("hidden", view!=="chapter");
  viewSegment.classList.toggle("hidden", view!=="segment");

  if(view==="overview"){
    topTitle.textContent = "孫子兵法　篇章總覽";
    topSub.textContent   = "依原書順序｜可自由進入練習";
  }
  if(view==="chapter"){
    const ch = CHAPTERS.find(c=>c.id===state.chapterId);
    topTitle.textContent = "孫子兵法　" + ch.title;
    topSub.textContent   = "篇章首頁";
  }
  if(view==="segment"){
    const ch = CHAPTERS.find(c=>c.id===state.chapterId);
    topTitle.textContent = "孫子兵法　" + ch.title;
    topSub.textContent   = "佈令 → 驗令 → 兵書";
  }
}

/* =========================
   Overview render
   ========================= */
function getChapterDone(chId){
  return state.progress.chapters[String(chId)]?.doneSegments ?? 0;
}
function setChapterDone(chId, done){
  state.progress.chapters[String(chId)] = { doneSegments: done };
  saveProgress(state.progress);
}

function renderOverview(){
  chapterList.innerHTML = "";
  CHAPTERS.forEach(ch=>{
    const row = document.createElement("div");
    row.className = "row";

    const left = document.createElement("div");
    left.className = "name";
    const t = document.createElement("div");
    t.className = "t";
    t.textContent = ch.title;
    const s = document.createElement("div");
    s.className = "s";
    s.textContent = ch.segments.length ? "可練習" : "（Demo 未收錄）";
    left.appendChild(t); left.appendChild(s);

    const right = document.createElement("div");
    right.className = "right";

    // ✅ 右側對齊星星，總數＝段落數
    const starWrap = document.createElement("div");
    starWrap.className = "stars";
    const total = ch.segments.length || 0;
    const done  = Math.min(getChapterDone(ch.id), total);
    renderStars(starWrap, total, done);

    const btn = document.createElement("div");
    btn.className = "btn";
    btn.textContent = ch.segments.length ? "進入" : "未收錄";
    if(!ch.segments.length){
      btn.style.opacity = ".45";
      btn.style.cursor = "not-allowed";
    }

    right.appendChild(starWrap);
    right.appendChild(btn);

    row.appendChild(left);
    row.appendChild(right);

    if(ch.segments.length){
      row.addEventListener("click", ()=>{
        state.chapterId = ch.id;
        renderChapterHome();
        show("chapter");
      });
    }
    chapterList.appendChild(row);
  });
}

/* =========================
   Chapter Home render
   ========================= */
function renderChapterHome(){
  const ch = CHAPTERS.find(c=>c.id===state.chapterId);
  chTitle.textContent = ch.title;
  chDesc.textContent = "先把一小段背順，整本就會慢慢變得可親。";

  const total = ch.segments.length;
  const done  = Math.min(getChapterDone(ch.id), total);
  renderStars(chStars, total, done);

  // Demo 預覽 & 孫武
  chPreview.innerHTML = `「兵者，國之大事也；死生之地，存亡之道，不可不察也。」<div class="muted" style="margin-top:6px;font-size:.9em;">（Demo 先放一段示意，之後可換成完整原文＋朗讀）</div>`;
  chCoach.textContent = "今天只要記住一段，就很夠了。";
}

function startChapter(fromBeginning=false){
  const ch = CHAPTERS.find(c=>c.id===state.chapterId);
  if(!ch.segments.length) return;

  if(fromBeginning){
    setChapterDone(ch.id, 0);
  }

  const done = getChapterDone(ch.id);
  // 規則：進入下一個未完成段落；若都完成則進最後一段（可重練但不加星）
  const targetSeg = Math.min(done + 1, ch.segments.length);

  state.segId = targetSeg;
  state.mode = "learn";
  state.expandedCoach = false;
  initSegment();
  show("segment");
}

btnStartChapter.addEventListener("click", ()=>startChapter(false));
btnRestartChapter.addEventListener("click", ()=>startChapter(true));
btnReadChapter.addEventListener("click", ()=>{
  alert("Demo：朗讀功能可接 Web Speech API（下一輪我可幫你接『可暫停/繼續』版）。");
});

/* =========================
   Segment init / render
   ========================= */
function initSegment(){
  const ch = CHAPTERS.find(c=>c.id===state.chapterId);
  const seg = ch.segments.find(s=>s.id===state.segId);

  segPath.textContent  = ch.title;
  segTitle.textContent = `第${seg.id}段`;

  // badges
  syncBadges();

  // init tokens
  state.placed = [];
  state.available = [...seg.tokens].sort(()=>Math.random()-0.5);

  // coach
  state.expandedCoach = false;
  renderCoach(seg);

  renderBoard(seg);
  renderTokens();
  updateCounts(seg);
  updateHintDot(); // 初次提示
}

function syncBadges(){
  badgeHints.classList.toggle("on", state.progress.hintsOn);
  badgeHints.textContent = state.progress.hintsOn ? "學習提示：開" : "學習提示：關";

  badgeMode.classList.toggle("on", state.mode==="test");
  badgeMode.textContent = state.mode==="test" ? "模式：測驗" : "模式：學習";

  badgeTestRange.textContent = "測驗範圍";
  badgeTestRange.classList.toggle("on", !!state.testRange);
}

function renderCoach(seg){
  const short = seg.coachShort;
  const full  = seg.coachFull;

  if(state.expandedCoach){
    coachLine.innerHTML = `${full} <span class="morelink" id="moreToggle">（收合）</span>`;
  }else{
    coachLine.innerHTML = `${short}<span class="morelink" id="moreToggle">…（更多）</span>`;
  }
  const moreToggle = document.getElementById("moreToggle");
  moreToggle.addEventListener("click", ()=>{
    state.expandedCoach = !state.expandedCoach;
    renderCoach(seg);
  });
}

btnCoachShuffle.addEventListener("click", ()=>{
  const ch = CHAPTERS.find(c=>c.id===state.chapterId);
  const seg = ch.segments.find(s=>s.id===state.segId);
  // Demo：換短句（簡單不文言）
  const pool = [
    seg.coachShort,
    "慢慢來。順口比速度重要。",
    "你只要比剛剛更穩一點，就算進步。",
    "先把順序站好，記憶就會自己長出來。"
  ];
  const pick = pool[Math.floor(Math.random()*pool.length)];
  // 暫時只換短句，全文仍用 seg.coachFull
  seg.coachShort = pick;
  state.expandedCoach = false;
  renderCoach(seg);
});

badgeHints.addEventListener("click", ()=>{
  state.progress.hintsOn = !state.progress.hintsOn;
  saveProgress(state.progress);
  syncBadges();
  updateHintDot(true);
});

badgeMode.addEventListener("click", ()=>{
  state.mode = (state.mode==="learn") ? "test" : "learn";
  syncBadges();
});

badgeTestRange.addEventListener("click", ()=>{
  alert("Demo：測驗範圍可做『開始/結束』下拉，不遮令牌區（下一輪我直接幫你接上）。");
});

function renderBoard(seg){
  slots.innerHTML = "";
  // ✅ 佈令板固定顯示全部槽位（讓你總能看到「缺多少」）
  seg.answer.forEach((_, idx)=>{
    const cell = document.createElement("div");
    const token = state.placed[idx];
    cell.className = "slot " + (token ? "" : "empty");
    cell.textContent = token ? token : "—";
    cell.addEventListener("click", ()=>{
      // 點槽位可退回該位置
      if(!token) return;
      state.available.push(token);
      state.placed[idx] = undefined;
      compactPlaced();
      renderBoard(seg);
      renderTokens();
      updateCounts(seg);
      updateHintDot();
    });
    slots.appendChild(cell);
  });
}

function compactPlaced(){
  // 把 undefined 位置往後挪，維持「前面連續」
  const compact = state.placed.filter(Boolean);
  state.placed = compact;
}

function renderTokens(){
  tokenGrid.innerHTML = "";
  // ✅ 令牌固定兩欄，不分頁；用完就灰掉（仍保留位置感）
  state.available.forEach((tkn, i)=>{
    const b = document.createElement("div");
    b.className = "token";
    b.textContent = tkn;
    b.addEventListener("click", ()=>{
      placeToken(tkn);
    });
    tokenGrid.appendChild(b);
  });
}

function placeToken(tkn){
  const ch = CHAPTERS.find(c=>c.id===state.chapterId);
  const seg = ch.segments.find(s=>s.id===state.segId);

  // 找第一個空槽
  const idx = state.placed.length;
  if(idx >= seg.answer.length) return;

  // remove from available
  const pos = state.available.indexOf(tkn);
  if(pos>=0) state.available.splice(pos,1);
  state.placed.push(tkn);

  renderBoard(seg);
  renderTokens();
  updateCounts(seg);
  updateHintDot();
}

function updateCounts(seg){
  const missing = seg.answer.length - state.placed.length;
  missingTxt.textContent = "缺詞：" + missing;
  remainTxt.textContent  = "剩餘：" + state.available.length;
}

function updateHintDot(force=false){
  if(!state.progress.hintsOn){
    hintDot.className = "hint-dot";
    return;
  }
  // 只有在需要提示時閃：缺詞 > 0
  const ch = CHAPTERS.find(c=>c.id===state.chapterId);
  const seg = ch.segments.find(s=>s.id===state.segId);
  const missing = seg.answer.length - state.placed.length;
  if(missing<=0 && !force){
    hintDot.className = "hint-dot";
    return;
  }
  // ✅ 強→弱閃 4 次（更明顯）
  hintDot.className = "hint-dot breathe";
  setTimeout(()=> hintDot.className = "hint-dot breathe2", 300);
  setTimeout(()=> hintDot.className = "hint-dot breathe2", 650);
  setTimeout(()=> hintDot.className = "hint-dot breathe3", 980);
  setTimeout(()=> hintDot.className = "hint-dot", 1350);
}

/* Buttons */
btnUndo.addEventListener("click", ()=>{
  const ch = CHAPTERS.find(c=>c.id===state.chapterId);
  const seg = ch.segments.find(s=>s.id===state.segId);
  if(!state.placed.length) return;
  const last = state.placed.pop();
  state.available.push(last);
  renderBoard(seg);
  renderTokens();
  updateCounts(seg);
  updateHintDot();
});

btnReset.addEventListener("click", ()=>{
  const ch = CHAPTERS.find(c=>c.id===state.chapterId);
  const seg = ch.segments.find(s=>s.id===state.segId);
  // 全退回
  state.available = state.available.concat(state.placed.filter(Boolean));
  state.placed = [];
  state.available.sort(()=>Math.random()-0.5);
  renderBoard(seg);
  renderTokens();
  updateCounts(seg);
  updateHintDot(true);
});

btnCheck.addEventListener("click", ()=>{
  const ch = CHAPTERS.find(c=>c.id===state.chapterId);
  const seg = ch.segments.find(s=>s.id===state.segId);

  // 未完成不驗
  if(state.placed.length !== seg.answer.length){
    gentleFail("還差一點。把缺的補齊，再驗一次。", seg);
    return;
  }
  // 正確性
  const ok = seg.answer.every((v,i)=>state.placed[i]===v);
  if(ok){
    // ✅ 完成後加星：doneSegments 至少到這一段
    const curDone = getChapterDone(ch.id);
    if(seg.id > curDone){
      setChapterDone(ch.id, seg.id);
    }

    // 通過後給呼吸燈提示更明顯
    updateHintDot(true);

    alert("驗令通過 ✅\n\n很好。你已把這段順序站穩了。");
    // 自動回篇章首頁（你如果要留在段落頁也可以改）
    renderChapterHome();
    show("chapter");
  }else{
    gentleFail("沒關係，剛好卡在最常卡的地方。", seg, true);
  }
});

function gentleFail(opening, seg, offerRestart=false){
  // ✅ 失敗：先溫柔評語 → 鼓勵 → 讓學員自己按「重來」
  const msg =
    opening + "\n\n" +
    "你不是不會，你只是還沒把順序『排回隊形』。\n" +
    "要不要再來一次？（按下去，就是你自己決定『我要重來』）";
  const go = confirm(msg);
  if(go){
    // 回到佈令（重整）
    btnReset.click();
  }else{
    // 放棄也OK：留在原畫面，不強迫
    alert("好。先到這裡也可以。\n你願意回來的那天，再練就行。");
  }
}

/* =========================
   Settings
   ========================= */
function openSettings(){
  overlay.classList.add("show");
}
function closeSettings(){
  overlay.classList.remove("show");
}
btnSettings.addEventListener("click", openSettings);
btnCloseSettings.addEventListener("click", closeSettings);
overlay.addEventListener("click", (e)=>{
  if(e.target===overlay) closeSettings();
});

fontRange.value = state.progress.fontSize;
setFontSize(state.progress.fontSize);
fontNow.textContent = "目前：" + state.progress.fontSize;

fontRange.addEventListener("input", ()=>{
  const v = Number(fontRange.value);
  state.progress.fontSize = v;
  saveProgress(state.progress);
  setFontSize(v);
  fontNow.textContent = "目前：" + v;
});

function syncHintsButton(){
  toggleHints.textContent = state.progress.hintsOn ? "開" : "關";
  toggleHints.classList.toggle("primary", state.progress.hintsOn);
}
syncHintsButton();

toggleHints.addEventListener("click", ()=>{
  state.progress.hintsOn = !state.progress.hintsOn;
  saveProgress(state.progress);
  syncHintsButton();
  syncBadges();
  updateHintDot(true);
});

btnClearAll.addEventListener("click", ()=>{
  const ok = confirm("確定要清空足跡？\n這會把所有篇章星星歸零。");
  if(!ok) return;
  state.progress.chapters = {};
  saveProgress(state.progress);
  renderOverview();
  renderChapterHome();
  if(state.view==="segment"){
    initSegment();
  }
  alert("已清空。");
});

btnCancelClear.addEventListener("click", ()=>closeSettings());

/* =========================
   Top nav
   ========================= */
btnOverview.addEventListener("click", ()=>{
  renderOverview();
  show("overview");
});

/* =========================
   Boot
   ========================= */
renderOverview();
renderChapterHome();
show("overview");
</script>
</body>
</html>
