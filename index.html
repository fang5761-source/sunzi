<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>å­«å­å…µæ³•ãƒ»æ ¡ä»¤æ¼”ç·´ v1ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰</title>
  <style>
    :root{
      --bg: #0f1214;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.10);
      --text: #e9edf1;
      --muted: rgba(233,237,241,0.70);
      --gold: #d7b56a;
      --gold2:#8a6a2b;
      --red:#e65a5a;
      --green:#48c774;
      --line: rgba(215,181,106,0.35);
      --chip: rgba(215,181,106,0.14);
      --shadow: 0 10px 30px rgba(0,0,0,0.45);
      --radius: 16px;
      --fontScale: 1; /* JSæœƒæ”¹ */
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% -20%, rgba(215,181,106,0.18), transparent 55%),
        radial-gradient(900px 600px at 110% 30%, rgba(230,90,90,0.10), transparent 55%),
        radial-gradient(900px 600px at -10% 80%, rgba(72,199,116,0.10), transparent 55%),
        linear-gradient(180deg, #0b0d0f 0%, #101418 100%);
      color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", system-ui, sans-serif;
      overflow:hidden;
    }

    /* ====== Layout ====== */
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: calc(10px + var(--safeTop)) 12px calc(10px + var(--safeBottom)) 12px;
      gap:10px;
    }

    /* ====== Top Bar ====== */
    .topbar{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius: var(--radius);
      padding:10px 12px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height: 56px;
    }

    .leftStack{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }

    .rankRow{
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 0;
    }

    .rankBadge{
      flex:0 0 auto;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(215,181,106,0.55);
      background: rgba(215,181,106,0.12);
      color: var(--gold);
      font-weight:700;
      font-size: calc(12px * var(--fontScale));
      letter-spacing: .08em;
      white-space: nowrap;
    }

    .chapterLabel{
      min-width:0;
      color: var(--muted);
      font-size: calc(12px * var(--fontScale));
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .statusRow{
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 0;
      color: var(--muted);
      font-size: calc(12px * var(--fontScale));
    }

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      white-space: nowrap;
    }

    .statusDot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(233,237,241,0.30);
      box-shadow: 0 0 0 3px rgba(233,237,241,0.06);
    }
    .dot-ok{ background: var(--green); box-shadow: 0 0 0 3px rgba(72,199,116,0.15); }
    .dot-warn{ background: var(--red); box-shadow: 0 0 0 3px rgba(230,90,90,0.15); }

    .rightBtns{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }

    .iconBtn{
      width:40px;height:40px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:active{ transform: scale(0.98); }

    /* ====== Sun Wu line ====== */
    .sunwu{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(215,181,106,0.10), rgba(255,255,255,0.04));
      border-radius: var(--radius);
      padding:10px 12px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-height: 54px;
    }
    .sunwuBadge{
      flex:0 0 auto;
      width:40px;height:40px;
      border-radius: 14px;
      border:1px solid rgba(215,181,106,0.55);
      background: rgba(215,181,106,0.14);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--gold);
      font-weight:800;
      letter-spacing: .1em;
    }
    .sunwuText{
      min-width: 0;
      font-size: calc(14px * var(--fontScale));
      line-height: 1.25;
      color: rgba(233,237,241,0.92);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* ====== Command Area ====== */
    .command{
      flex: 1 1 auto;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .commandHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }

    .title{
      font-weight:800;
      color: var(--gold);
      font-size: calc(14px * var(--fontScale));
      letter-spacing: .06em;
      white-space:nowrap;
    }

    .miniProgress{
      flex:1 1 auto;
      height: 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      min-width: 80px;
    }
    .miniFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(215,181,106,0.9), rgba(215,181,106,0.35));
      transition: width .25s ease;
    }

    .commandBody{
      flex:1 1 auto;
      border:1px dashed rgba(215,181,106,0.35);
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }

    .lineWrap{
      width:100%;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-content:flex-start;
      justify-content:flex-start;
      max-height: 100%;
      overflow:hidden; /* é¿å…æ•´é«”æ»‘å‹• */
    }

    .placeholder{
      color: rgba(233,237,241,0.45);
      font-size: calc(14px * var(--fontScale));
      letter-spacing:.04em;
      user-select:none;
    }

    /* Tokens */
    .token{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(215,181,106,0.45);
      background: rgba(215,181,106,0.12);
      color: rgba(233,237,241,0.95);
      font-weight:800;
      font-size: calc(16px * var(--fontScale));
      line-height: 1.05;
      letter-spacing:.02em;
      user-select:none;
      cursor:pointer;
      white-space: nowrap;
      box-shadow: 0 10px 20px rgba(0,0,0,0.18);
    }
    .token:active{ transform: scale(0.98); }

    .token.selected{
      background: rgba(72,199,116,0.14);
      border-color: rgba(72,199,116,0.55);
      color: rgba(233,237,241,0.98);
    }

    .token.wrongFlash{
      animation: wrong .25s ease 0s 2;
      border-color: rgba(230,90,90,0.9);
      background: rgba(230,90,90,0.14);
    }
    @keyframes wrong{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-4px); }
      50%{ transform: translateX(4px); }
      75%{ transform: translateX(-3px); }
      100%{ transform: translateX(0); }
    }

    /* ====== Controls ====== */
    .controls{
      flex:0 0 auto;
      display:flex;
      gap:10px;
    }

    .btn{
      flex:1 1 0;
      height: 46px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(233,237,241,0.92);
      font-weight:800;
      font-size: calc(14px * var(--fontScale));
      letter-spacing:.06em;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 24px rgba(0,0,0,0.22);
    }
    .btn:active{ transform: scale(0.99); }
    .btn.primary{
      border-color: rgba(215,181,106,0.55);
      background: rgba(215,181,106,0.14);
      color: var(--gold);
    }
    .btn.danger{
      border-color: rgba(230,90,90,0.45);
      background: rgba(230,90,90,0.12);
      color: rgba(233,237,241,0.95);
    }

    /* ====== Options ====== */
    .options{
      flex:0 0 auto;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .optionsHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .optionsLabel{
      color: var(--muted);
      font-weight:700;
      font-size: calc(12px * var(--fontScale));
      letter-spacing:.06em;
      white-space: nowrap;
    }
    .pager{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .pagerBtn{
      width:36px;height:34px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(233,237,241,0.9);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .pagerBtn:active{ transform: scale(0.98); }
    .pagerDots{
      color: rgba(233,237,241,0.55);
      font-size: calc(12px * var(--fontScale));
      letter-spacing:.08em;
      white-space: nowrap;
      min-width: 44px;
      text-align:center;
    }

    .tokenGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (min-width: 410px){
      .tokenGrid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .token.small{
      width:100%;
      justify-content:center;
      padding: 12px 10px;
      font-size: calc(15px * var(--fontScale));
    }

    /* ====== Modal ====== */
    .modal{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,0.78);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      z-index: 50;
    }
    .card{
      width: min(520px, 100%);
      border-radius: 18px;
      border:1px solid rgba(215,181,106,0.55);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      padding: 14px;
    }
    .cardTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .stamp{
      padding: 6px 10px;
      border-radius: 12px;
      border:1px solid rgba(72,199,116,0.55);
      background: rgba(72,199,116,0.12);
      color: rgba(233,237,241,0.95);
      font-weight:900;
      letter-spacing:.1em;
      font-size: calc(12px * var(--fontScale));
    }
    .closeBtn{
      width:40px;height:38px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(233,237,241,0.9);
      font-size: 18px;
      cursor:pointer;
    }
    .closeBtn:active{ transform: scale(0.98); }

    .cardBody{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .orig{
      font-size: calc(17px * var(--fontScale));
      line-height: 1.35;
      font-weight:900;
      color: rgba(233,237,241,0.96);
      letter-spacing:.02em;
    }
    .trans{
      font-size: calc(14px * var(--fontScale));
      line-height: 1.45;
      color: rgba(233,237,241,0.78);
      white-space: pre-wrap;
    }
    .cardBtns{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }

    /* ====== Settings Drawer ====== */
    .drawer{
      position: fixed;
      left:0; right:0; bottom:0;
      background: rgba(18,22,26,0.98);
      border-top: 1px solid rgba(215,181,106,0.35);
      border-radius: 18px 18px 0 0;
      padding: 14px 14px calc(14px + var(--safeBottom)) 14px;
      transform: translateY(110%);
      transition: transform .22s ease;
      z-index: 60;
      box-shadow: 0 -20px 60px rgba(0,0,0,0.55);
    }
    .drawer.open{ transform: translateY(0%); }
    .drawerHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
    }
    .drawerTitle{
      color: var(--gold);
      font-weight:900;
      letter-spacing:.08em;
      font-size: calc(14px * var(--fontScale));
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 0;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .row:first-of-type{ border-top:none; }
    .rowLabel{
      color: rgba(233,237,241,0.88);
      font-weight:800;
      font-size: calc(13px * var(--fontScale));
      letter-spacing:.03em;
    }
    .rowHint{
      color: rgba(233,237,241,0.55);
      font-size: calc(12px * var(--fontScale));
      margin-top: 4px;
    }

    /* Toggle */
    .toggle{
      width: 52px;
      height: 30px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
      position: relative;
      cursor:pointer;
      flex:0 0 auto;
    }
    .knob{
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(233,237,241,0.92);
      position:absolute;
      top: 1px; left: 1px;
      transition: left .18s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    .toggle.on{
      background: rgba(72,199,116,0.18);
      border-color: rgba(72,199,116,0.35);
    }
    .toggle.on .knob{ left: 24px; }

    input[type="range"]{
      width: 170px;
      accent-color: var(--gold);
    }

    /* Hint pulse (å­¸ç¿’æç¤º) */
    .hintPulse{
      animation: pulse 1.4s ease-in-out infinite;
      box-shadow: 0 0 0 0 rgba(215,181,106,0.35);
    }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 rgba(215,181,106,0.28); }
      70%{ box-shadow: 0 0 0 10px rgba(215,181,106,0.00); }
      100%{ box-shadow: 0 0 0 0 rgba(215,181,106,0.00); }
    }

  </style>
</head>

<body>
  <div class="app" id="app">
    <!-- Top Bar -->
    <div class="topbar">
      <div class="leftStack">
        <div class="rankRow">
          <div class="rankBadge" id="rankBadge">æ–°å…µ</div>
          <div class="chapterLabel" id="chapterLabel">å§‹è¨ˆç¯‡ï½œæ¼”ç·´ 1</div>
        </div>
        <div class="statusRow">
          <div class="statusPill">
            <span class="statusDot dot-ok" id="statusDot"></span>
            <span id="statusText">ç›®å‰ç„¡éŒ¯å­—</span>
          </div>
          <div class="statusPill" id="hintPill">å­¸ç¿’æç¤ºï¼šé–‹</div>
        </div>
      </div>

      <div class="rightBtns">
        <div class="iconBtn" id="btnSettings" title="è¨­å®š">âš™ï¸</div>
        <div class="iconBtn" id="btnBook" title="è»æ›¸">ğŸ“œ</div>
      </div>
    </div>

    <!-- Sun Wu -->
    <div class="sunwu">
      <div class="sunwuBadge">å­«æ­¦</div>
      <div class="sunwuText" id="sunwuText">æ ¡ä»¤ã€‚å…ˆæŠŠç¯€å¥æ’é †ï¼Œå†æ±‚ä¸€å­—ä¸å·®ã€‚</div>
    </div>

    <!-- Command Area -->
    <div class="command">
      <div class="commandHead">
        <div class="title">æ ¡ä»¤æ§½</div>
        <div class="miniProgress" aria-label="progress">
          <div class="miniFill" id="miniFill"></div>
        </div>
      </div>

      <div class="commandBody" id="commandBody">
        <div class="lineWrap" id="lineWrap"></div>
        <div class="placeholder" id="placeholder">é»ä¸‹æ–¹ä»¤ç‰Œï¼Œä¾é †åºä¸Šå‘ˆ</div>
      </div>

      <div class="controls">
        <button class="btn danger" id="btnUndo">æ’¤ä»¤</button>
        <button class="btn" id="btnReset">é‡æ•´</button>
        <button class="btn primary" id="btnCheck">é©—ä»¤</button>
      </div>
    </div>

    <!-- Options -->
    <div class="options">
      <div class="optionsHead">
        <div class="optionsLabel">ä»¤ç‰ŒåŒ£</div>
        <div class="pager">
          <button class="pagerBtn" id="pagePrev">â€¹</button>
          <div class="pagerDots" id="pageDots">1/1</div>
          <button class="pagerBtn" id="pageNext">â€º</button>
        </div>
      </div>
      <div class="tokenGrid" id="tokenGrid"></div>
    </div>
  </div>

  <!-- Win Modal -->
  <div class="modal" id="winModal" role="dialog" aria-modal="true">
    <div class="card">
      <div class="cardTop">
        <div class="stamp" id="stampText">é©—ä»¤é€šé</div>
        <button class="closeBtn" id="closeWin" title="é—œé–‰">âœ•</button>
      </div>
      <div class="cardBody">
        <div class="orig" id="origText"></div>
        <div class="trans" id="transText"></div>
      </div>
      <div class="cardBtns">
        <button class="btn" id="btnReplay">å†æ¼”ç·´</button>
        <button class="btn primary" id="btnNext">ä¸‹ä¸€æ®µ</button>
      </div>
    </div>
  </div>

  <!-- Settings Drawer -->
  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div class="drawerTitle">è»å¸³è¨­å®š</div>
      <button class="closeBtn" id="closeDrawer" title="é—œé–‰">âœ•</button>
    </div>

    <div class="row">
      <div>
        <div class="rowLabel">å­¸ç¿’æç¤º</div>
        <div class="rowHint">åªåšã€Œæº«æŸ”å¸¶è·¯ã€ï¼Œä¸è€ƒå€’ä½ </div>
      </div>
      <div class="toggle on" id="toggleHint"><div class="knob"></div></div>
    </div>

    <div class="row">
      <div>
        <div class="rowLabel">éŸ³æ•ˆ</div>
        <div class="rowHint">è½ä»¤ï¼ç¿»é ï¼ç¨€æœ‰è½å°ï¼ˆå¯é—œï¼‰</div>
      </div>
      <div class="toggle on" id="toggleSound"><div class="knob"></div></div>
    </div>

    <div class="row">
      <div>
        <div class="rowLabel">å­—é«”å¤§å°</div>
        <div class="rowHint">èª¿æ•´æ•´é«”é–±è®€èˆ’é©åº¦</div>
      </div>
      <input type="range" id="fontRange" min="0.9" max="1.25" step="0.01" value="1.00" />
    </div>
  </div>

  <script>
    /***********************
     * v1ï¼šå§‹è¨ˆç¯‡å°æ®µé©—è­‰
     ***********************/
    const PASSAGES = [
      {
        id: "sc_01",
        chapter: "å§‹è¨ˆç¯‡",
        label: "æ¼”ç·´ 1",
        // ä»¥ã€Œè©çµ„ã€ç‚ºæœ€å°å–®ä½ï¼ˆé †å£èƒŒèª¦ï¼‰
        segments: ["å…µè€…","åœ‹ä¹‹å¤§äº‹","æ­»ç”Ÿä¹‹åœ°","å­˜äº¡ä¹‹é“","ä¸å¯ä¸å¯Ÿä¹Ÿ"],
        punctuation: "ï¼Œ", // v1å…ˆç”¨é€—è™Ÿä¸²èµ·ä¾†ï¼ˆä¸æŠŠæ¨™é»ç•¶è€ƒè©¦ï¼‰
        translation:
`ã€ç™½è©±ã€‘æˆ°çˆ­æ˜¯åœ‹å®¶çš„å¤§äº‹ï¼Œé—œä¿‚åˆ°è»æ°‘çš„ç”Ÿæ­»ã€åœ‹å®¶çš„å­˜äº¡ï¼Œå› æ­¤çµ•å°ä¸å¯ä¸ä»”ç´°å¯©å¯Ÿã€‚`
      }
    ];

    /***********************
     * å­«æ­¦ï¼šç™½è©±ã€ä½é »ã€ç‹€æ…‹åˆ¤æ–·
     ***********************/
    const SUNWU = {
      base: [
        "æ ¡ä»¤ã€‚å…ˆæŠŠç¯€å¥æ’é †ï¼Œå†æ±‚ä¸€å­—ä¸å·®ã€‚",
        "å…ˆé †å£ï¼Œå†ç©©ä½ï¼›ç©©ä½äº†ï¼ŒèƒŒèµ·ä¾†å°±ä¸è²»åŠ›ã€‚",
        "ä¸å¿…æ€¥ï¼Œè®“å®ƒè®Šæˆä½ å˜´è£¡è‡ªç„¶æœƒå‡ºä¾†çš„å¥å­ã€‚"
      ],
      stable: [
        "é€™æ®µå·²ç¶“é †äº†ã€‚",
        "é€™ä¸€å¥ï¼Œå¾ˆç©©ã€‚",
        "ç¯€å¥æŠ“åˆ°äº†ã€‚",
        "é€™æ®µå®šä¸‹ä¾†äº†ã€‚",
        "ä¸ç”¨å†å¤šçœ‹ã€‚",
        "è¨˜å¾—ä½äº†ã€‚"
      ],
      lessHelp: [
        "å…¶å¯¦ä½ å·²ç¶“ä¸å¤ªéœ€è¦æç¤ºäº†ã€‚",
        "é€™æ®µé è‡ªå·±å°±è¡Œã€‚",
        "ä¸ç”¨å¤–åŠ©ï¼Œä¹Ÿèµ°å¾—å®Œã€‚",
        "æç¤ºåªæ˜¯å‚™ç”¨ã€‚",
        "é€™ä¸€å¥ï¼Œå¿ƒè£¡æœ‰äº†ã€‚"
      ],
      revisit: [
        "éš”äº†ä¸€é™£å­ï¼Œé‚„è¨˜å¾—ã€‚",
        "æ²’ç”Ÿç–ã€‚",
        "é€™æ®µæ²’æœ‰å¿˜ã€‚",
        "å†çœ‹ä¸€æ¬¡ï¼Œä¹Ÿé‚„åœ¨ã€‚",
        "è¨˜æ†¶æ²’æœ‰é€€ã€‚"
      ],
      failSoft: [
        "é™£å‹¢æœ‰é»äº‚ï¼Œæ’¤å›é‡æ’å°±å¥½ã€‚",
        "å…ˆæ’¤ä¸€ä»¤ï¼Œç¯€å¥å°±æœƒå›ä¾†ã€‚",
        "ä¸æ€¥ï¼ŒæŒ‰é †åºä¾†ã€‚"
      ],
      winSoft: [
        "å¥½ã€‚é€™æ®µå¯ä»¥äº†ã€‚",
        "å¯ä»¥ï¼Œé€™æ®µç©©ã€‚",
        "è¡Œï¼Œå·²æˆã€‚"
      ]
    };

    /***********************
     * å„²å­˜èˆ‡ç‹€æ…‹
     ***********************/
    const LS_KEY = "sunzi_v1_state";
    const now = () => Date.now();

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return {};
        return JSON.parse(raw);
      }catch(e){
        return {};
      }
    }
    function saveState(state){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    const appState = {
      passageIndex: 0,
      selection: [],
      pool: [],
      page: 0,
      perPage: 6, // 2æ¬„/3æ¬„æœƒè‡ªå‹•æ’ï¼Œé€™è£¡æ§åˆ¶ä¸€æ¬¡é¡¯ç¤ºå¤šå°‘ä»¤ç‰Œ
      hintOn: true,
      soundOn: true,
      fontScale: 1.0,

      // æ“ä½œç´€éŒ„ï¼ˆç”¨æ–¼æº«æŸ”æé†’èˆ‡é©šå–œï¼‰
      lastActionAt: 0,
      usedHintThisRun: false,
      wrongCountThisRun: 0,
      undoCountThisRun: 0,

      // é•·æœŸç´€éŒ„ï¼ˆæ¯æ®µï¼‰
      stats: loadState()
    };

    /***********************
     * DOM
     ***********************/
    const rankBadge = document.getElementById("rankBadge");
    const chapterLabel = document.getElementById("chapterLabel");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const hintPill = document.getElementById("hintPill");
    const sunwuText = document.getElementById("sunwuText");

    const lineWrap = document.getElementById("lineWrap");
    const placeholder = document.getElementById("placeholder");
    const miniFill = document.getElementById("miniFill");

    const tokenGrid = document.getElementById("tokenGrid");
    const pagePrev = document.getElementById("pagePrev");
    const pageNext = document.getElementById("pageNext");
    const pageDots = document.getElementById("pageDots");

    const btnUndo = document.getElementById("btnUndo");
    const btnReset = document.getElementById("btnReset");
    const btnCheck = document.getElementById("btnCheck");

    const btnSettings = document.getElementById("btnSettings");
    const btnBook = document.getElementById("btnBook");

    const winModal = document.getElementById("winModal");
    const closeWin = document.getElementById("closeWin");
    const origText = document.getElementById("origText");
    const transText = document.getElementById("transText");
    const btnReplay = document.getElementById("btnReplay");
    const btnNext = document.getElementById("btnNext");
    const stampText = document.getElementById("stampText");

    const drawer = document.getElementById("drawer");
    const closeDrawer = document.getElementById("closeDrawer");
    const toggleHint = document.getElementById("toggleHint");
    const toggleSound = document.getElementById("toggleSound");
    const fontRange = document.getElementById("fontRange");

    /***********************
     * éŸ³æ•ˆï¼ˆWebAudioï¼Œç„¡éœ€æª”æ¡ˆï¼‰
     ***********************/
    let audioCtx = null;
    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if(audioCtx.state === "suspended"){
        audioCtx.resume().catch(()=>{});
      }
    }

    function playTone({type="sine", freq=220, dur=0.07, gain=0.12, ramp=true}){
      if(!appState.soundOn) return;
      ensureAudio();
      const t0 = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      g.gain.value = 0.0001;

      osc.connect(g);
      g.connect(audioCtx.destination);

      if(ramp){
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
      }else{
        g.gain.setValueAtTime(gain, t0);
        g.gain.setValueAtTime(0.0001, t0 + dur);
      }

      osc.start(t0);
      osc.stop(t0 + dur + 0.02);
    }

    function playClick(){ // è½ä»¤
      playTone({type:"triangle", freq: 240, dur: 0.06, gain: 0.09});
    }
    function playFlip(){ // ç¿»é 
      playTone({type:"sine", freq: 330, dur: 0.09, gain: 0.07});
      setTimeout(()=>playTone({type:"sine", freq: 220, dur: 0.08, gain: 0.06}), 40);
    }
    function playStamp(){ // ç¨€æœ‰è½å°ï¼ˆä½æ²‰ï¼‰
      playTone({type:"sine", freq: 120, dur: 0.10, gain: 0.10});
    }
    function playWarn(){ // éŒ¯èª¤æé†’ï¼ˆå¾ˆè¼•ï¼Œä¸åˆºæ¿€ï¼‰
      playTone({type:"sine", freq: 170, dur: 0.07, gain: 0.06});
    }

    /***********************
     * éšç´šï¼ˆå…ˆè¼•é‡ï¼šä¸ç¶å…¨æ›¸ï¼‰
     ***********************/
    function computeRank(statsObj){
      // åªçœ‹ã€Œå®Œæˆæ®µè½æ¬¡æ•¸ã€èˆ‡ã€Œä¸åŒæ®µè½æ•¸ã€â€” v1åªæœ‰ä¸€æ®µï¼Œå…ˆè®“å®ƒèƒ½å‹•èµ·ä¾†
      const totalWins = Object.values(statsObj).reduce((a,b)=>a + (b.wins||0), 0);
      const distinct = Object.values(statsObj).filter(s => (s.wins||0) > 0).length;

      // é€™å¥—æ˜¯ã€Œæœå½¹æ„Ÿã€ï¼šæ…¢å‡ã€ä¸æ–½å£“
      if(totalWins >= 12 && distinct >= 2) return "ä»€é•·";
      if(totalWins >= 8) return "ä¼é•·";
      if(totalWins >= 3) return "è€å…µ";
      return "æ–°å…µ";
    }

    /***********************
     * å­«æ­¦èªå¥ï¼šä½é »ã€éç½é ­
     ***********************/
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function maybeSpeak(kind, passageId){
      // ä½é »æ§åˆ¶ï¼šåŒä¸€å›åˆæœ€å¤šè¬›ä¸€æ¬¡é©šå–œ/æé†’
      const s = getPassageStat(passageId);
      const cooldownMs = 16000; // é¿å…å¤ªå¸¸èªªè©±
      if(now() - (s.lastSpeakAt||0) < cooldownMs) return;

      let line = null;
      if(kind === "stable") line = pick(SUNWU.stable);
      if(kind === "lessHelp") line = pick(SUNWU.lessHelp);
      if(kind === "revisit") line = pick(SUNWU.revisit);
      if(kind === "failSoft") line = pick(SUNWU.failSoft);
      if(kind === "winSoft") line = pick(SUNWU.winSoft);

      if(!line) return;
      sunwuText.textContent = line;
      s.lastSpeakAt = now();
      setPassageStat(passageId, s);
    }

    function setBaseLine(){
      sunwuText.textContent = pick(SUNWU.base);
    }

    /***********************
     * Passage stats
     ***********************/
    function getPassageStat(id){
      if(!appState.stats[id]) appState.stats[id] = {};
      const s = appState.stats[id];
      if(typeof s.wins !== "number") s.wins = 0;
      if(typeof s.bestStreak !== "number") s.bestStreak = 0;
      if(typeof s.lastPlayedAt !== "number") s.lastPlayedAt = 0;
      if(typeof s.lastSpeakAt !== "number") s.lastSpeakAt = 0;
      if(typeof s.surpriseCount !== "number") s.surpriseCount = 0;
      if(typeof s.hintOffWins !== "number") s.hintOffWins = 0;
      if(typeof s.perfectWins !== "number") s.perfectWins = 0;
      return s;
    }
    function setPassageStat(id, s){
      appState.stats[id] = s;
      saveState(appState.stats);
      rankBadge.textContent = computeRank(appState.stats);
    }

    /***********************
     * åˆå§‹åŒ–/è¼‰å…¥æ®µè½
     ***********************/
    function loadPassage(i){
      appState.passageIndex = i;
      appState.selection = [];
      appState.pool = [];
      appState.page = 0;

      appState.usedHintThisRun = false;
      appState.wrongCountThisRun = 0;
      appState.undoCountThisRun = 0;

      const p = PASSAGES[i];
      chapterLabel.textContent = `${p.chapter}ï½œ${p.label}`;
      setBaseLine();

      // å»ºæ± ï¼šæ‰“äº‚
      appState.pool = [...p.segments].sort(()=>Math.random()-0.5);

      // å›è¨ªæº«æŸ”æé†’ï¼ˆå¾ˆä½é »ï¼‰
      const st = getPassageStat(p.id);
      const gap = now() - (st.lastPlayedAt || 0);
      st.lastPlayedAt = now();
      setPassageStat(p.id, st);

      if(gap > 1000*60*60*10 && st.wins > 0){
        // éš”å¾ˆä¹…å›ä¾†ï¼Œå¶çˆ¾èªªä¸€å¥
        if(Math.random() < 0.55) maybeSpeak("revisit", p.id);
      }

      renderAll();
      updateStatus();
    }

    /***********************
     * UI æ›´æ–°
     ***********************/
    function setFontScale(v){
      appState.fontScale = v;
      document.documentElement.style.setProperty("--fontScale", String(v));
    }

    function updateHintPill(){
      hintPill.textContent = `å­¸ç¿’æç¤ºï¼š${appState.hintOn ? "é–‹" : "é—œ"}`;
    }

    function updateStatus(){
      const p = PASSAGES[appState.passageIndex];

      // é€²åº¦
      const pct = (appState.selection.length / p.segments.length) * 100;
      miniFill.style.width = `${pct}%`;

      // éŒ¯å­—é¡¯ç¤ºï¼šv1ä¸åš´ï¼Œä½†ä»æç¤º
      if(appState.wrongCountThisRun > 0){
        statusDot.classList.remove("dot-ok");
        statusDot.classList.add("dot-warn");
        statusText.textContent = `å·²é€€å› ${appState.wrongCountThisRun} æ¬¡`;
      }else{
        statusDot.classList.remove("dot-warn");
        statusDot.classList.add("dot-ok");
        statusText.textContent = "ç›®å‰ç„¡éŒ¯å­—";
      }

      updateHintPill();
      applyHintPulse();
    }

    function applyHintPulse(){
      // å­¸ç¿’æç¤ºï¼šåªäº®ã€Œä¸‹ä¸€å€‹æ­£ç¢ºä»¤ç‰Œã€ï¼Œè€Œä¸”å¾ˆæº«æŸ”
      const gridBtns = tokenGrid.querySelectorAll(".token");
      gridBtns.forEach(b => b.classList.remove("hintPulse"));

      if(!appState.hintOn) return;

      const p = PASSAGES[appState.passageIndex];
      const nextIdx = appState.selection.length;
      if(nextIdx >= p.segments.length) return;

      const next = p.segments[nextIdx];
      // åœ¨ç•¶é æ‰¾
      gridBtns.forEach(b=>{
        if(b.dataset.text === next) b.classList.add("hintPulse");
      });
    }

    function renderLine(){
      lineWrap.innerHTML = "";
      if(appState.selection.length === 0){
        placeholder.style.display = "block";
        return;
      }
      placeholder.style.display = "none";

      appState.selection.forEach((t, idx)=>{
        const el = document.createElement("div");
        el.className = "token selected";
        el.textContent = t;
        el.title = "é»ä¸€ä¸‹å¯æ’¤å›æ­¤ä»¤ï¼ˆæœƒæ’¤åˆ°é€™è£¡ï¼‰";
        el.onclick = ()=>{
          // æ’¤åˆ° idx
          const removed = appState.selection.splice(idx);
          // æ”¾å›æ± 
          appState.pool.push(...removed);
          appState.undoCountThisRun += 1;
          renderAll();
          updateStatus();
          maybeSoftCoach();
        };
        lineWrap.appendChild(el);
      });
    }

    function renderOptions(){
      tokenGrid.innerHTML = "";

      const total = appState.pool.length;
      const pages = Math.max(1, Math.ceil(total / appState.perPage));
      appState.page = Math.min(appState.page, pages-1);

      const start = appState.page * appState.perPage;
      const view = appState.pool.slice(start, start + appState.perPage);

      view.forEach(text=>{
        const b = document.createElement("div");
        b.className = "token small";
        b.textContent = text;
        b.dataset.text = text;
        b.onclick = ()=>{
          onPickToken(text, b);
        };
        tokenGrid.appendChild(b);
      });

      pageDots.textContent = `${appState.page+1}/${pages}`;
      pagePrev.disabled = appState.page <= 0;
      pageNext.disabled = appState.page >= pages-1;

      applyHintPulse();
    }

    function renderAll(){
      renderLine();
      renderOptions();
      updateHintPill();
    }

    /***********************
     * é¸ä»¤èˆ‡é©—ä»¤
     ***********************/
    function onPickToken(text, btnEl){
      const p = PASSAGES[appState.passageIndex];
      const expected = p.segments[appState.selection.length];

      // è¨˜éŒ„ã€Œæ˜¯å¦ç”¨åˆ°æç¤ºã€ï¼šåªè¦æç¤ºé–‹è‘—ä¸”é»çš„æ­£æ˜¯ä¸‹ä¸€å€‹æç¤ºï¼Œå°±ç®—ä½¿ç”¨
      if(appState.hintOn && text === expected){
        appState.usedHintThisRun = true;
      }

      // v1ï¼šä¸è€ƒå€’äººï¼Œä½†é †åºä»è¦å°ï¼ˆä¸ç„¶èƒŒä¸èµ·ä¾†ï¼‰
      if(text !== expected){
        // éŒ¯ï¼šè¼•å¾®åé¥‹ + ä¸æŠŠäººæ‰“è¶´
        appState.wrongCountThisRun += 1;
        playWarn();
        btnEl.classList.add("wrongFlash");
        setTimeout(()=>btnEl.classList.remove("wrongFlash"), 380);
        maybeSpeak("failSoft", p.id);
        updateStatus();
        return;
      }

      // å°ï¼šæ”¶é€²é¸æ“‡ï¼Œå¾æ± ç§»é™¤
      appState.selection.push(text);
      const idx = appState.pool.indexOf(text);
      if(idx >= 0) appState.pool.splice(idx, 1);

      playClick();
      renderAll();
      updateStatus();

      if(appState.selection.length === p.segments.length){
        // è‡ªå‹•é€²å…¥å¯é©—ä»¤ç‹€æ…‹
        // é€™è£¡ä¸è·³è©±ï¼Œè®“å­¸å“¡å…ˆè‡ªå·±æ„Ÿè¦ºå®Œæˆ
        maybeSoftCoach(true);
      }else{
        maybeSoftCoach(false);
      }
    }

    function buildOriginalText(p){
      // ç”¨é€—è™Ÿä¸²èµ·ï¼ˆv1ä¸æŠŠæ¨™é»ç•¶è€ƒè©¦ï¼‰
      return p.segments.join(p.punctuation) + "ã€‚";
    }

    function checkAnswer(){
      const p = PASSAGES[appState.passageIndex];

      if(appState.selection.length !== p.segments.length){
        maybeSpeak("failSoft", p.id);
        return;
      }

      // v1ï¼šè©çµ„å¿…é ˆä¸€å­—ä¸å·®ï¼ˆè©çµ„æœ¬èº«å·²å›ºå®šï¼‰ï¼Œæ¨™é»ä¸åš´
      const ok = appState.selection.every((v,i)=>v === p.segments[i]);

      if(!ok){
        appState.wrongCountThisRun += 1;
        playWarn();
        maybeSpeak("failSoft", p.id);
        updateStatus();
        return;
      }

      // Win stats
      const st = getPassageStat(p.id);
      st.wins += 1;

      // streakï¼šä»¥ã€Œæœ¬æ¬¡éŒ¯é€€æ¬¡æ•¸å°‘ã€ä½œç‚ºç©©å®šåˆ¤æ–·
      const perfect = (appState.wrongCountThisRun === 0);
      if(perfect) st.perfectWins += 1;

      // bestStreakï¼šç°¡åŒ–ç‚ºé€£çºŒ perfect æ¬¡æ•¸ï¼ˆç”¨ local è®Šæ•¸ç¶­è­·ï¼‰
      st._tempStreak = (st._tempStreak || 0);
      st._tempStreak = perfect ? (st._tempStreak + 1) : 0;
      st.bestStreak = Math.max(st.bestStreak, st._tempStreak);

      if(!appState.hintOn) st.hintOffWins += 1;

      setPassageStat(p.id, st);

      // å­«æ­¦æº«æŸ”æé†’ + é©šå–œï¼ˆä¸å…¬å‘Šï¼‰
      maybeWinSpeakAndSurprise(p);

      // Modal
      origText.textContent = buildOriginalText(p);
      transText.textContent = p.translation;
      stampText.textContent = perfect ? "é©—ä»¤é€šéï¼ˆç©©ï¼‰" : "é©—ä»¤é€šé";
      openWin();
    }

    function maybeWinSpeakAndSurprise(p){
      // å…ˆä¸€å¥æº«æŸ”æé†’ï¼ˆä½é »ï¼‰
      // æ¢ä»¶ï¼šå®Œæ®µä¸”å¤§è‡´ç©©
      const st = getPassageStat(p.id);
      const perfect = (appState.wrongCountThisRun === 0);

      // 1) ä¾è³´ä¸‹é™ï¼šæç¤ºé—œï¼Œæˆ–æç¤ºé–‹ä½†å¹¾ä¹æ²’ç”¨ï¼ˆé€™è£¡ç”¨ hintOff åˆ¤æ–·ï¼‰
      if(!appState.hintOn && Math.random() < 0.75){
        maybeSpeak("lessHelp", p.id);
      } else if(perfect && appState.hintOn && !appState.usedHintThisRun && Math.random() < 0.45){
        // æç¤ºé–‹ä½†æ²’é å®ƒï¼ˆé«”æ„Ÿæœƒå¾ˆæœ‰æˆé•·ï¼‰
        maybeSpeak("lessHelp", p.id);
      } else {
        // 2) ç©©å®šåº¦ï¼šperfect æˆ– é€€å›å¾ˆå°‘
        if(perfect && Math.random() < 0.65) maybeSpeak("stable", p.id);
        else if(Math.random() < 0.35) maybeSpeak("winSoft", p.id);
      }

      // 3) ç¨€æœ‰è½å°ï¼ˆé©šå–œï¼‰ï¼šä¸è¬›ã€åªç™¼ç”Ÿ
      // æ¢ä»¶ï¼šperfect ä¸”æœ‰ä¸€å®šç´¯ç©
      if(perfect && st.wins >= 3){
        const chance = Math.min(0.18, 0.06 + st.wins*0.01); // æ…¢æ…¢å‡ï¼Œä½†ä¸è¶…é 18%
        if(Math.random() < chance){
          st.surpriseCount += 1;
          setPassageStat(p.id, st);
          // ç¨€æœ‰éŸ³æ•ˆ
          playStamp();
          // ä¹Ÿå¯è®“å­«æ­¦è£œä¸€å°å¥æ›´ç™½è©±ï¼Œä½†ä»ä½é »
          if(Math.random() < 0.55){
            setTimeout(()=>maybeSpeak("winSoft", p.id), 180);
          }
        }else{
          playFlip(); // å®Œæ®µå°ç¿»é ï¼ˆä¸ç®—é©šå–œï¼‰
        }
      }else{
        playFlip();
      }
    }

    function maybeSoftCoach(isJustCompleted=false){
      const p = PASSAGES[appState.passageIndex];
      const st = getPassageStat(p.id);

      // æº«æŸ”æé†’ï¼šç•¶ã€ŒéŒ¯é€€å°‘ã€æˆ–ã€Œæ’¤ä»¤å°‘ã€æ™‚ï¼Œå¶çˆ¾èªªä¸€å¥ï¼ˆä¸å¸¸ï¼‰
      if(isJustCompleted){
        // å®Œæˆä½†é‚„æ²’é©—ä»¤ï¼šä¿æŒå®‰éœè¼ƒæœ‰æ²ˆæµ¸æ„Ÿ
        return;
      }

      // æ“ä½œä¸­ä¸å¤šè©±ï¼Œåªåœ¨æŸäº›ç‹€æ…‹è½‰å¥½æ™‚è¬›ä¸€æ¬¡
      const picked = appState.selection.length;
      if(picked === 0) return;

      // å¦‚æœé€£çºŒæ“ä½œé †ï¼ˆæ²’æœ‰éŒ¯é€€ï¼‰åˆ°ä¸€å®šæ¯”ä¾‹ï¼Œå¶çˆ¾æç¤ºã€Œç¯€å¥å°äº†ã€
      if(appState.wrongCountThisRun === 0 && picked >= 3 && Math.random() < 0.10){
        maybeSpeak("stable", p.id);
      }
    }

    /***********************
     * æ“ä½œæŒ‰éˆ•
     ***********************/
    function undo(){
      if(appState.selection.length === 0) return;
      const last = appState.selection.pop();
      appState.pool.push(last);
      appState.undoCountThisRun += 1;
      renderAll();
      updateStatus();
      playClick();
      maybeSoftCoach();
    }

    function resetRun(){
      const p = PASSAGES[appState.passageIndex];
      // æŠŠé¸æ“‡å…¨éƒ¨ä¸Ÿå›æ± ä¸¦æ´—ç‰Œ
      appState.pool = [...p.segments].sort(()=>Math.random()-0.5);
      appState.selection = [];
      appState.page = 0;
      appState.usedHintThisRun = false;
      appState.wrongCountThisRun = 0;
      appState.undoCountThisRun = 0;
      setBaseLine();
      renderAll();
      updateStatus();
    }

    /***********************
     * Modal & Drawer
     ***********************/
    function openWin(){ winModal.style.display = "flex"; }
    function closeWinModal(){ winModal.style.display = "none"; }

    function openDrawer(){ drawer.classList.add("open"); }
    function closeDrawerPanel(){ drawer.classList.remove("open"); }

    /***********************
     * Bookï¼ˆv1å…ˆåšï¼šé¡¯ç¤ºæœ¬æ®µè»æ›¸ï¼‰
     ***********************/
    function showBook(){
      const p = PASSAGES[appState.passageIndex];
      origText.textContent = buildOriginalText(p);
      transText.textContent = p.translation;
      stampText.textContent = "è»æ›¸";
      openWin();
    }

    /***********************
     * Paging
     ***********************/
    function prevPage(){
      appState.page = Math.max(0, appState.page - 1);
      renderOptions();
    }
    function nextPage(){
      const total = appState.pool.length;
      const pages = Math.max(1, Math.ceil(total / appState.perPage));
      appState.page = Math.min(pages-1, appState.page + 1);
      renderOptions();
    }

    /***********************
     * è¨­å®šåˆ‡æ›
     ***********************/
    function setToggle(el, on){
      el.classList.toggle("on", !!on);
    }

    function toggleHintOn(){
      appState.hintOn = !appState.hintOn;
      setToggle(toggleHint, appState.hintOn);
      updateStatus();

      // åˆ‡æ›æ™‚å­«æ­¦ä¸å˜®å¨ï¼Œåªå›ä¸€å¥ã€Œæ“ä½œæ„Ÿã€çš„è©±ï¼ˆå¾ˆä½é »ï¼‰
      const p = PASSAGES[appState.passageIndex];
      if(!appState.hintOn){
        if(Math.random() < 0.65) sunwuText.textContent = "å¥½ã€‚è‡ªå·±ä¾†ä¸€è¼ªï¼Œæ„Ÿè¦ºæœƒæ›´æ¸…æ¥šã€‚";
      }else{
        if(Math.random() < 0.55) sunwuText.textContent = "å­¸ç¿’æç¤ºåªæ˜¯å¸¶è·¯ï¼Œä½ ä»æ˜¯ä¸»å¸¥ã€‚";
      }
    }

    function toggleSoundOn(){
      appState.soundOn = !appState.soundOn;
      setToggle(toggleSound, appState.soundOn);
      if(appState.soundOn){
        // ç”¨ä¸€å€‹å¾ˆè¼•çš„ã€Œè½ä»¤ã€ä½œå›é¥‹
        playClick();
      }
    }

    /***********************
     * äº‹ä»¶ç¶å®š
     ***********************/
    btnUndo.addEventListener("click", ()=>{ ensureAudio(); undo(); });
    btnReset.addEventListener("click", ()=>{ ensureAudio(); resetRun(); });
    btnCheck.addEventListener("click", ()=>{ ensureAudio(); checkAnswer(); });

    pagePrev.addEventListener("click", prevPage);
    pageNext.addEventListener("click", nextPage);

    btnSettings.addEventListener("click", ()=>{ ensureAudio(); openDrawer(); });
    closeDrawer.addEventListener("click", closeDrawerPanel);

    toggleHint.addEventListener("click", ()=>{ ensureAudio(); toggleHintOn(); });
    toggleSound.addEventListener("click", ()=>{ ensureAudio(); toggleSoundOn(); });

    fontRange.addEventListener("input", (e)=>{
      const v = Number(e.target.value);
      setFontScale(v);
    });

    btnBook.addEventListener("click", ()=>{ ensureAudio(); showBook(); });

    closeWin.addEventListener("click", closeWinModal);
    winModal.addEventListener("click", (e)=>{
      if(e.target === winModal) closeWinModal();
    });

    btnReplay.addEventListener("click", ()=>{
      closeWinModal();
      resetRun();
    });
    btnNext.addEventListener("click", ()=>{
      // v1åªæœ‰ä¸€æ®µï¼šä¸‹ä¸€æ®µå…ˆå›åˆ°åŒæ®µï¼ˆä¹‹å¾Œä½ è¦æ“´æ®µè½æˆ‘æœƒæŠŠé€™è£¡æ¥ä¸Šï¼‰
      closeWinModal();
      resetRun();
      sunwuText.textContent = "å†èµ°ä¸€è¼ªã€‚ç¬¬äºŒè¼ªæœ€å®¹æ˜“æŠŠå®ƒèƒŒç‰¢ã€‚";
    });

    /***********************
     * å•Ÿå‹•
     ***********************/
    (function boot(){
      // åˆå§‹å­—é«”
      setFontScale(appState.fontScale);
      fontRange.value = String(appState.fontScale);

      // åˆå§‹ toggle é¡¯ç¤º
      setToggle(toggleHint, appState.hintOn);
      setToggle(toggleSound, appState.soundOn);

      // éšç´š
      rankBadge.textContent = computeRank(appState.stats);

      // è¼‰å…¥ç¬¬ä¸€æ®µ
      loadPassage(0);

      // iOSï¼šç¬¬ä¸€æ¬¡äº’å‹•å¾Œå†å•Ÿå‹• AudioContextï¼ˆå·²åœ¨ click ä¸­ ensureAudioï¼‰
    })();
  </script>
</body>
</html>
