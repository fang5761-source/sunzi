<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å­«å­å…µæ³•ãƒ»èƒŒèª¦æ¼”ç·´ v1.2ï¼ˆæ‰‹æ©Ÿå„ªå…ˆï¼‰</title>
  <style>
    :root{
      --bg:#0f1410;
      --panel:#141b15;
      --panel2:#101612;
      --line:#2a3a2d;
      --ink:#e9f1e9;
      --muted:#a9b7aa;
      --accent:#9ad27a;
      --accent2:#ffd46a;
      --warn:#ffb4a2;
      --ok:#77e08b;
      --danger:#ff6b6b;
      --shadow: rgba(0,0,0,.35);

      --fontScale: 1; /* ç”± JS å¯«å…¥ */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 15% 15%, rgba(122,255,170,.08), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(255,212,106,.06), transparent 55%),
        linear-gradient(180deg, #0b100c 0%, #101612 100%);
      color:var(--ink);
      font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow:hidden;
    }

    /* ====== Layout ====== */
    .app{
      height:100vh;
      display:grid;
      grid-template-rows: auto 1fr auto auto;
      gap:10px;
      padding:10px 10px 12px;
    }

    header{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px 10px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(30,42,32,.92), rgba(16,22,18,.92));
      border-radius:14px;
      box-shadow: 0 10px 25px var(--shadow);
      min-height:56px;
    }
    .titleRow{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .titleTop{
      display:flex;
      gap:8px;
      align-items:center;
      min-width:0;
    }
    .badge{
      font-size:12px;
      color:#0c120d;
      background: linear-gradient(180deg, var(--accent), #56b96c);
      padding:3px 8px;
      border-radius:999px;
      font-weight:700;
      letter-spacing:.5px;
      flex:0 0 auto;
      box-shadow: 0 6px 14px rgba(154,210,122,.18);
    }
    .chapter{
      font-weight:800;
      letter-spacing:1px;
      font-size:15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1 1 auto;
    }
    .subline{
      display:flex;
      gap:10px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subline span{ opacity:.95; }

    .actionsTop{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    .iconBtn{
      border:1px solid var(--line);
      background: rgba(12,18,13,.55);
      color:var(--ink);
      padding:10px 10px;
      border-radius:12px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      min-width:44px;
      min-height:44px;
      display:grid;
      place-items:center;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .iconBtn:active{ transform: translateY(1px); }
    .iconBtn small{ font-size:12px; opacity:.9; }

    /* å‘¼å¸ç‡ˆï¼ˆæ…¢ä¸€é»ã€å…‰æšˆæ›´å¼·ï¼‰ */
    .glow{
      position:relative;
      border-color: rgba(255,212,106,.55) !important;
      box-shadow:
        0 0 0 1px rgba(255,212,106,.25) inset,
        0 0 22px rgba(255,212,106,.25),
        0 0 45px rgba(255,212,106,.12);
      animation: breathe 2.6s ease-in-out infinite;
    }
    .glow::after{
      content:"";
      position:absolute;
      inset:-8px;
      border-radius:16px;
      background: radial-gradient(closest-side, rgba(255,212,106,.22), transparent 70%);
      filter: blur(2px);
      pointer-events:none;
    }
    @keyframes breathe{
      0%   { transform: translateY(0); filter: brightness(1); }
      50%  { transform: translateY(-1px); filter: brightness(1.12); }
      100% { transform: translateY(0); filter: brightness(1); }
    }

    /* ====== Sun Wu speech ====== */
    .speech{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(20,27,21,.92), rgba(16,22,18,.92));
      border-radius:14px;
      box-shadow: 0 10px 25px var(--shadow);
      padding:10px 12px;
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:10px;
      align-items:start;
      min-height:64px;
    }
    .avatar{
      width:42px;height:42px;
      border-radius:12px;
      display:grid;
      place-items:center;
      font-weight:900;
      letter-spacing:1px;
      color:#0b100c;
      background: linear-gradient(180deg, #d7b86e, #bda15b);
      box-shadow: 0 10px 18px rgba(215,184,110,.18);
      flex:0 0 auto;
      user-select:none;
    }
    .speechText{
      min-width:0;
      font-size: calc(14px * var(--fontScale));
      line-height:1.35;
      color:var(--ink);
    }
    .speechText .name{
      color:#d7e7d8;
      font-weight:900;
      margin-right:6px;
    }
    .speechClamp{
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .moreInline{
      color: var(--accent2);
      font-weight:800;
      cursor:pointer;
      user-select:none;
      padding-left:6px;
      white-space:nowrap;
    }

    /* ====== Board + Tokens (åŒç•«é¢æ ¸å¿ƒ) ====== */
    .board{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,24,19,.92), rgba(12,18,13,.92));
      border-radius:16px;
      box-shadow: 0 12px 30px var(--shadow);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .boardTop{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      padding:0 2px;
    }

    .slot{
      flex:1 1 auto;
      min-height: 96px;
      border:1px dashed rgba(154,210,122,.35);
      border-radius:14px;
      padding:10px;
      display:flex;
      flex-wrap:wrap;
      align-content:flex-start;
      gap:8px;
      background:
        radial-gradient(900px 260px at 50% 0%, rgba(154,210,122,.08), transparent 60%);
      overflow:hidden;
    }

    .tokenBar{
      border-top:1px solid rgba(255,255,255,.06);
      padding-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .tokenTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:var(--muted);
      padding:0 2px;
    }
    .tokenWrap{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-content:flex-start;
      min-height: 108px; /* å…©æ’ä¿åº• */
      max-height: 130px; /* é˜²æ­¢æŠŠç•«é¢åƒå…‰ */
      overflow:hidden;   /* ä¸ç”¨æ‰‹å‹•ä¸Šä¸‹æ»‘ */
    }

    .token{
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(34,46,36,.95), rgba(16,22,18,.95));
      color:var(--ink);
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      font-size: calc(15px * var(--fontScale));
      letter-spacing:.5px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      gap:8px;
      min-height:44px;
    }
    .token:active{ transform: translateY(1px); }
    .token small{
      opacity:.85;
      font-weight:800;
      font-size: calc(12px * var(--fontScale));
      color: rgba(233,241,233,.85);
    }

    .token.hintNext{
      border-color: rgba(154,210,122,.55);
      box-shadow:
        0 0 0 1px rgba(154,210,122,.18) inset,
        0 0 18px rgba(154,210,122,.20),
        0 0 40px rgba(154,210,122,.10);
      animation: hintPulse 2.4s ease-in-out infinite;
    }
    @keyframes hintPulse{
      0%{ filter: brightness(1); }
      50%{ filter: brightness(1.16); }
      100%{ filter: brightness(1); }
    }

    /* ====== Bottom row ====== */
    .bottomRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(12,18,13,.55);
      color:var(--ink);
      padding:12px 12px;
      border-radius:14px;
      font-weight:900;
      font-size: calc(14px * var(--fontScale));
      cursor:pointer;
      min-height:48px;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(154,210,122,.28), rgba(12,18,13,.55));
      border-color: rgba(154,210,122,.45);
    }
    .btn.danger{
      border-color: rgba(255,107,107,.45);
      background: linear-gradient(180deg, rgba(255,107,107,.16), rgba(12,18,13,.55));
    }
    .btn.hidden{ display:none; }

    /* ====== Modal ====== */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:999;
    }
    .sheet{
      width:min(520px, 100%);
      background: linear-gradient(180deg, rgba(24,32,25,.98), rgba(12,18,13,.98));
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: 0 30px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .sheetHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .sheetHeader h3{
      margin:0;
      font-size:15px;
      letter-spacing:1px;
    }
    .sheetBody{
      padding:12px 14px 14px;
      color:var(--ink);
      line-height:1.55;
      font-size: calc(14px * var(--fontScale));
    }
    .sheetBody .muted{ color:var(--muted); font-size: calc(12px * var(--fontScale)); }
    .sheetFooter{
      display:flex;
      gap:10px;
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .sheetFooter .btn{ flex:1; }

    /* Settings controls */
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 0;
      border-bottom:1px dashed rgba(255,255,255,.08);
    }
    .row:last-child{ border-bottom:none; }
    .row label{
      font-weight:900;
      letter-spacing:.5px;
      font-size: calc(13px * var(--fontScale));
    }
    .row .desc{
      color:var(--muted);
      font-size: calc(12px * var(--fontScale));
      margin-top:4px;
      line-height:1.35;
    }
    .switch{
      display:flex;
      align-items:center;
      gap:10px;
    }
    input[type="checkbox"]{
      width:48px;height:28px;
      appearance:none;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.10);
      position:relative;
      outline:none;
      cursor:pointer;
    }
    input[type="checkbox"]::after{
      content:"";
      position:absolute;
      top:3px; left:3px;
      width:22px; height:22px;
      background: rgba(233,241,233,.92);
      border-radius:999px;
      transition:.18s;
      box-shadow: 0 8px 14px rgba(0,0,0,.25);
    }
    input[type="checkbox"]:checked{
      background: rgba(154,210,122,.35);
      border-color: rgba(154,210,122,.45);
    }
    input[type="checkbox"]:checked::after{
      left:22px;
      background: #e9f1e9;
    }
    input[type="range"]{
      width:180px;
      accent-color: var(--accent);
    }

    /* Small screens tightening */
    @media (max-height: 740px){
      .tokenWrap{ min-height:100px; max-height:122px; }
      .slot{ min-height: 88px; }
      .speech{ min-height:60px; }
    }
  </style>
</head>
<body>
  <div class="app">

    <header>
      <div class="titleRow">
        <div class="titleTop">
          <div class="badge" id="chapterRankBadge">æ–°å…µ</div>
          <div class="chapter" id="chapterTitle">å§‹è¨ˆç¯‡ãƒ»ç¬¬ä¸€æ®µ</div>
        </div>
        <div class="subline">
          <span id="globalRankText">å…¨åŸŸè»éšï¼šæ–°å…µ</span>
          <span>â€¢</span>
          <span id="progressText">é€²åº¦ï¼š1 / 1</span>
        </div>
      </div>
      <div class="actionsTop">
        <button class="iconBtn" id="bookBtn" title="å…µæ›¸ï¼ˆç™½è©±ï¼‰">ğŸ“œ</button>
        <button class="iconBtn" id="settingsBtn" title="è¨­å®š">âš™ï¸</button>
      </div>
    </header>

    <div class="speech">
      <div class="avatar">å­«æ­¦</div>
      <div class="speechText" id="speechText"></div>
      <button class="iconBtn" id="resetBtn" title="é‡æ•´">â†º</button>
    </div>

    <!-- æ ¸å¿ƒæˆ°å ´ï¼šä½ˆä»¤æ¿ + ä»¤ç‰Œå€ï¼ˆåŒç•«é¢ï¼‰ -->
    <section class="board">
      <div class="boardTop">
        <div id="modeText">æ¨¡å¼ï¼šæ¼”ç·´ï¼ˆä¾åºæ’å…¥ä½ˆä»¤æ¿ï¼‰</div>
        <div id="hintStateText">å­¸ç¿’æç¤ºï¼šé–‹</div>
      </div>

      <div class="slot" id="slot"></div>

      <div class="tokenBar">
        <div class="tokenTitle">
          <div>ä»¤ç‰Œå€ï¼ˆé»é¸ä»¤ç‰Œ â†’ æ”¾å…¥ä½ˆä»¤æ¿ï¼‰</div>
          <div id="tokenCountText">å‰©é¤˜ï¼š0</div>
        </div>
        <div class="tokenWrap" id="tokenWrap"></div>
      </div>
    </section>

    <div class="bottomRow">
      <button class="btn danger" id="undoBtn">â†©ï¸ é€€ä¸€ä»¤</button>
      <button class="btn primary hidden" id="quizBtn">ğŸ§ª æ¸¬é©—ï¼ˆç´¯ç©ï¼‰</button>
    </div>

    <div class="bottomRow" style="margin-top:-4px;">
      <button class="btn hidden" id="nextBtn">â¡ï¸ ä¸‹ä¸€æ®µ</button>
      <button class="btn primary hidden" id="checkBtn">âœ… é©—ä»¤</button>
    </div>

  </div>

  <!-- å…µæ›¸ Modal -->
  <div class="modal" id="bookModal">
    <div class="sheet">
      <div class="sheetHeader">
        <h3>å…µæ›¸ï¼ˆç™½è©±è£œè¨»ï¼‰</h3>
        <button class="iconBtn" id="closeBook">âœ•</button>
      </div>
      <div class="sheetBody">
        <div style="font-weight:900;margin-bottom:10px;" id="bookOriginal"></div>
        <div id="bookTranslation"></div>
        <div class="muted" style="margin-top:10px;" id="bookNote"></div>
        <div style="margin-top:12px;" class="muted">å°æç¤ºï¼šä¸ç”¨è¿½æ±‚ä¸€æ¬¡å°±å…¨å°ã€‚èƒ½ã€Œæ¯”å‰›æ‰é †ä¸€é»ã€å°±è´äº†ã€‚</div>
      </div>
      <div class="sheetFooter">
        <button class="btn" id="bookReadBtn">ğŸ”Š æœ—è®€</button>
        <button class="btn primary" id="bookOkBtn">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <!-- è¨­å®š Modal -->
  <div class="modal" id="settingsModal">
    <div class="sheet">
      <div class="sheetHeader">
        <h3>è¨­å®š</h3>
        <button class="iconBtn" id="closeSettings">âœ•</button>
      </div>
      <div class="sheetBody">
        <div class="row">
          <div>
            <label>å­—é«”å¤§å°</label>
            <div class="desc">æ‹–æ›³èª¿æ•´ï¼ˆæ‰‹æ©Ÿé–±è®€æ›´èˆ’æœï¼‰</div>
          </div>
          <div class="switch">
            <input type="range" id="fontSlider" min="0.9" max="1.25" step="0.01" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>å­¸ç¿’æç¤º</label>
            <div class="desc">æœƒç”¨æ·¡æ·¡å…‰æšˆæŒ‡å¼•ã€Œä¸‹ä¸€å€‹æ‡‰æ”¾çš„ä»¤ç‰Œã€</div>
          </div>
          <div class="switch">
            <input type="checkbox" id="hintToggle" checked />
          </div>
        </div>

        <div class="row">
          <div>
            <label>éŸ³æ•ˆ</label>
            <div class="desc">é»ä»¤ç‰Œã€é€šéé©—ä»¤æœƒæœ‰å°æç¤ºéŸ³ï¼ˆå¯é—œï¼‰</div>
          </div>
          <div class="switch">
            <input type="checkbox" id="sfxToggle" checked />
          </div>
        </div>

        <div class="row">
          <div>
            <label>æœ—è®€ï¼ˆèªéŸ³ï¼‰</label>
            <div class="desc">ä½¿ç”¨ iPhone å…§å»ºæœ—è®€ï¼ˆå¯é—œï¼‰</div>
          </div>
          <div class="switch">
            <input type="checkbox" id="ttsToggle" checked />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€šéå¾Œè‡ªå‹•é–‹å…µæ›¸</label>
            <div class="desc">é è¨­é—œé–‰ï¼šé€šéå¾Œåªäº®å‘¼å¸ç‡ˆæé†’ä½ å¯çœ‹å…µæ›¸</div>
          </div>
          <div class="switch">
            <input type="checkbox" id="autoBookToggle" />
          </div>
        </div>

      </div>
      <div class="sheetFooter">
        <button class="btn" id="settingsResetBtn">é‚„åŸé è¨­</button>
        <button class="btn primary" id="settingsOkBtn">å®Œæˆ</button>
      </div>
    </div>
  </div>

  <!-- å°è©å®Œæ•´ç‰ˆ Modal -->
  <div class="modal" id="speechModal">
    <div class="sheet">
      <div class="sheetHeader">
        <h3>å­«æ­¦</h3>
        <button class="iconBtn" id="closeSpeech">âœ•</button>
      </div>
      <div class="sheetBody" id="speechFull"></div>
      <div class="sheetFooter">
        <button class="btn primary" id="speechOkBtn">æ”¶èµ·ä¾†</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * v1.2 Dataï¼ˆå§‹è¨ˆç¯‡ç¬¬ä¸€å°æ®µé©—è­‰ï¼‰
     * ä½ è¦æ“´å……å…¨æœ¬æ™‚ï¼Œåªè¦å¾€ passages åŠ å°±è¡Œ
     ***********************/
    const passages = [{
      id: "sc_01",
      chapter: "å§‹è¨ˆç¯‡",
      title: "ç¬¬ä¸€æ®µ",
      segments: ["å…µè€…", "åœ‹ä¹‹å¤§äº‹", "æ­»ç”Ÿä¹‹åœ°", "å­˜äº¡ä¹‹é“", "ä¸å¯ä¸å¯Ÿä¹Ÿ"],
      translation: "æˆ°çˆ­æ˜¯åœ‹å®¶çš„å¤§äº‹ï¼Œç‰½æ¶‰åˆ°è»æ°‘çš„ç”Ÿæ­»èˆ‡åœ‹å®¶çš„å­˜äº¡ï¼Œæ‰€ä»¥çµ•å°ä¸èƒ½ä¸èªçœŸçœ‹æ¸…æ¥šã€‚",
      note: "ä½ ç¾åœ¨ç·´çš„æ˜¯ã€Œé †å£ã€ã€‚å…ˆæŠŠç¯€å¥èƒŒé †ï¼Œå†è«‡é€Ÿåº¦ã€‚"
    }];

    /***********************
     * å¤ä»£è»éšï¼ˆæ–°æ‰‹ç·šï¼‰
     ***********************/
    const ranks = ["æ–°å…µ","ä¼å’","ä»€é•·","ç™¾å¤«","æ ¡å°‰","éƒ½å°‰","å°‡è»"];

    /***********************
     * State
     ***********************/
    let idx = 0; // passage index
    let placed = [];      // å·²æ”¾å…¥ä½ˆä»¤æ¿çš„ä»¤ç‰Œï¼ˆé †åºï¼‰
    let pool = [];        // ä»¤ç‰Œå€å‰©é¤˜
    let mode = "train";   // train | quiz
    let readyForQuiz = false;

    // settings
    const settings = {
      fontScale: 1.0,
      hintOn: true,
      sfxOn: true,
      ttsOn: true,
      autoBook: false
    };

    // progress (localStorage)
    const KEY = "sunzi_mem_v12";
    const mem = loadMem();

    /***********************
     * Elements
     ***********************/
    const chapterRankBadge = document.getElementById("chapterRankBadge");
    const chapterTitle = document.getElementById("chapterTitle");
    const globalRankText = document.getElementById("globalRankText");
    const progressText = document.getElementById("progressText");

    const bookBtn = document.getElementById("bookBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const resetBtn = document.getElementById("resetBtn");

    const speechText = document.getElementById("speechText");
    const speechModal = document.getElementById("speechModal");
    const speechFull = document.getElementById("speechFull");
    const closeSpeech = document.getElementById("closeSpeech");
    const speechOkBtn = document.getElementById("speechOkBtn");

    const slot = document.getElementById("slot");
    const tokenWrap = document.getElementById("tokenWrap");
    const tokenCountText = document.getElementById("tokenCountText");
    const hintStateText = document.getElementById("hintStateText");
    const modeText = document.getElementById("modeText");

    const undoBtn = document.getElementById("undoBtn");
    const quizBtn = document.getElementById("quizBtn");
    const checkBtn = document.getElementById("checkBtn");
    const nextBtn = document.getElementById("nextBtn");

    const bookModal = document.getElementById("bookModal");
    const closeBook = document.getElementById("closeBook");
    const bookOkBtn = document.getElementById("bookOkBtn");
    const bookReadBtn = document.getElementById("bookReadBtn");
    const bookOriginal = document.getElementById("bookOriginal");
    const bookTranslation = document.getElementById("bookTranslation");
    const bookNote = document.getElementById("bookNote");

    const settingsModal = document.getElementById("settingsModal");
    const closeSettings = document.getElementById("closeSettings");
    const settingsOkBtn = document.getElementById("settingsOkBtn");
    const settingsResetBtn = document.getElementById("settingsResetBtn");
    const fontSlider = document.getElementById("fontSlider");
    const hintToggle = document.getElementById("hintToggle");
    const sfxToggle = document.getElementById("sfxToggle");
    const ttsToggle = document.getElementById("ttsToggle");
    const autoBookToggle = document.getElementById("autoBookToggle");

    /***********************
     * Audio (simple WebAudio beep)
     ***********************/
    let audioCtx;
    function beep(freq=660, dur=0.06, vol=0.05){
      if(!settings.sfxOn) return;
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "sine";
        o.frequency.value = freq;
        g.gain.value = vol;
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start();
        o.stop(audioCtx.currentTime + dur);
      }catch(e){}
    }

    /***********************
     * TTS (SpeechSynthesis)
     ***********************/
    function speak(text){
      if(!settings.ttsOn) return;
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "zh-TW";
      u.rate = 0.95;
      u.pitch = 1.0;
      u.volume = 1.0;
      window.speechSynthesis.speak(u);
    }

    /***********************
     * Helpers
     ***********************/
    function shuffle(a){
      const arr = [...a];
      for(let i=arr.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    function clampSpeechPreview(full){
      // å…§å®¹å…ˆå¡ï¼Œè¦–è¦ºç”¨ clampï¼Œæœ«å°¾åŠ  â€¦ï¼ˆæ›´å¤šï¼‰
      const safe = full.replace(/</g,"&lt;").replace(/>/g,"&gt;");
      return safe;
    }

    function openModal(el){ el.style.display="flex"; }
    function closeModal(el){ el.style.display="none"; }

    function setRootFontScale(v){
      document.documentElement.style.setProperty("--fontScale", v);
    }

    /***********************
     * Encouragement (ä¸ç½é ­ï¼Œä¸æ–‡è¨€)
     ***********************/
    const say = {
      startTrain: [
        "å…ˆæŠŠç¯€å¥æŠ“ç©©ã€‚é †äº†ï¼Œå°±è‡ªç„¶å¿«ã€‚",
        "ä»Šå¤©åªæ±‚ä¸€ä»¶äº‹ï¼šå”¸èµ·ä¾†é †å£ã€‚",
        "ä¸ç”¨æ€¥ï¼Œå…ˆæŠŠæ¯ä¸€å¡Šæ”¾åˆ°å°çš„ä½ç½®ã€‚"
      ],
      onPick: [
        "å—¯ï¼Œæ¥å¾—ä¸Šã€‚",
        "é€™æ­¥å¾ˆå¥½ï¼Œåˆ¥æ€¥è‘—å¿«ã€‚",
        "å°ï¼Œç¹¼çºŒã€‚"
      ],
      onWrong: [
        "å¡ä¸€ä¸‹å¾ˆæ­£å¸¸ã€‚å›åˆ°ä¸Šä¸€å¡Šï¼Œå†èµ°ä¸€éã€‚",
        "å…ˆåˆ¥ç¡¬æ‹šé€Ÿåº¦ã€‚æŠŠé †åºå®ˆä½å°±è´äº†ã€‚",
        "é€™å£å…ˆæ”¾è‘—ï¼Œç­‰ä¸€ä¸‹è‡ªç„¶æœƒé †ã€‚"
      ],
      onPass: [
        "å¯ä»¥ã€‚ä½ å‰›å‰›é‚£å£ï¼Œå¾ˆæº–ã€‚",
        "é€™æ®µä½ å·²ç¶“ç«™ç©©äº†ã€‚æ¥ä¸‹ä¾†æ˜¯æŠŠå®ƒèƒŒé †ã€‚",
        "å¥½ã€‚ç¾åœ¨ä½ ä¸é é‹æ°£äº†ï¼Œæ˜¯é ç©©ã€‚"
      ],
      quizInvite: [
        "è¦ä¸è¦é †ä¾¿é©—ä¸€éï¼Ÿä½ æ‡‰è©²æœ‰æŠŠæ¡äº†ã€‚",
        "é€™æ®µçœ‹èµ·ä¾†å·²ç¶“ç†Ÿäº†ã€‚è¦ä¸è¦è©¦è©¦ä¸é æç¤ºï¼Ÿ",
        "ä½ å·²ç¶“æŠ“åˆ°ç¯€å¥äº†ã€‚æƒ³é©—ä¸€ä¸‹å—ï¼Ÿ"
      ],
      quizStart: [
        "æ¸¬é©—ä¸æ˜¯å¯©åˆ¤ï¼Œåªæ˜¯ç¢ºèªä½ çœŸçš„æœƒäº†ã€‚",
        "å¥½ï¼Œç¾åœ¨é ä½ è‡ªå·±ã€‚æ…¢æ…¢ä¾†ï¼Œç…§é †åºã€‚",
        "ä½ å¯ä»¥éŒ¯ï¼Œä½†è¦çŸ¥é“æ€éº¼å›ä¾†ã€‚"
      ],
      quizPass: [
        "æ¼‚äº®ã€‚é€™å°±æ˜¯ã€Œæœƒã€çš„æ¨£å­ã€‚",
        "å¥½ã€‚ä½ ç¾åœ¨ä¸æ˜¯èƒŒï¼Œæ˜¯åœ¨æŒæ¡ã€‚",
        "ç©©ä½äº†ã€‚é€™æ®µå¯ä»¥æ”¶é€²èº«é«”è£¡ã€‚"
      ],
      quizFail: [
        "æ²’é—œä¿‚ã€‚å‰›å¥½å¡åœ¨å¤§å®¶æœ€å¸¸å¡çš„åœ°æ–¹ã€‚",
        "ä½ ä¸æ˜¯ä¸æœƒï¼Œæ˜¯é‚„å·®ä¸€å£æ°£çš„é †ã€‚",
        "å›å»æ¼”ç·´ä¸€æ¬¡å°±å¥½ï¼Œä¸ç”¨ç¡¬æ’ã€‚"
      ]
    };

    function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    /***********************
     * Surprise systemï¼ˆå®Œå…¨éš¨æ©Ÿã€å°ä¸­å¤§ï¼‰
     ***********************/
    function maybeSurprise(kind){
      // kind: "small"|"mid"|"big"
      // ä¸é å‘Šã€ä¹Ÿä¸æç¤ºè¦å‰‡
      const r = Math.random();
      if(kind==="small" && r < 0.22){
        // å°é©šå–œï¼šçŸ­å°ç« æ„Ÿï¼ˆåªé¡¯ç¤ºåœ¨å­«æ­¦å°è©çµå°¾ä¸€ç¬é–“ï¼‰
        const stamps = ["ã€ç©©ã€‘","ã€é †ã€‘","ã€ç²¾ã€‘","ã€å®šã€‘"];
        return " " + stamps[Math.floor(Math.random()*stamps.length)];
      }
      if(kind==="mid" && r < 0.10){
        const notes = [
          "ï¼ˆä½ ä»Šå¤©çš„æ‰‹æ„Ÿï¼Œæ¯”å‰›æ‰é †ã€‚ï¼‰",
          "ï¼ˆä½ ä¸æ˜¯å¿«ï¼Œä½ æ˜¯ç©©ã€‚ï¼‰",
          "ï¼ˆé€™æ®µå·²ç¶“é–‹å§‹ã€Œé»ã€ä¸Šå»äº†ã€‚ï¼‰"
        ];
        return " " + notes[Math.floor(Math.random()*notes.length)];
      }
      if(kind==="big" && r < 0.04){
        const big = [
          "ä½ ä¸ç”¨å†è­‰æ˜ä½ è¡Œä¸è¡Œäº†ã€‚ä½ å·²ç¶“åœ¨é€²æ­¥äº†ã€‚",
          "ä»Šå¤©åˆ°é€™è£¡å°±å¥½ã€‚æ”¶å¾—ä½çš„äººï¼Œé€²æ­¥æœ€å¿«ã€‚",
          "ä½ çœ‹ï¼Œä½ ä¸æ˜¯ä¸æœƒâ€”â€”ä½ åªæ˜¯éœ€è¦ä¸€å€‹é †çš„ç¯€å¥ã€‚"
        ];
        return " " + big[Math.floor(Math.random()*big.length)];
      }
      return "";
    }

    /***********************
     * Progress / Ranks
     ***********************/
    function loadMem(){
      try{
        const raw = localStorage.getItem(KEY);
        if(raw) return JSON.parse(raw);
      }catch(e){}
      return {
        globalXP: 0,
        globalRank: 0,
        chapters: {} // chapterId -> {xp, rank}
      };
    }
    function saveMem(){
      try{ localStorage.setItem(KEY, JSON.stringify(mem)); }catch(e){}
    }

    function ensureChapter(id){
      if(!mem.chapters[id]) mem.chapters[id] = { xp:0, rank:0 };
      return mem.chapters[id];
    }

    function xpToRank(xp){
      // æ··åˆåˆ¶ï¼šçœ‹ã€Œç·´ç¿’é‡ã€ä¹Ÿçœ‹ã€Œè¡¨ç¾ã€
      // é€™è£¡å…ˆç”¨ç°¡å–®é–€æª»ï¼ˆä¹‹å¾Œä½ è¦æ›´ç´°ç·»ï¼Œæˆ‘å†èª¿ï¼‰
      const thresholds = [0, 6, 14, 26, 42, 62, 86]; // 7éš
      let r = 0;
      for(let i=0;i<thresholds.length;i++){
        if(xp >= thresholds[i]) r=i;
      }
      return Math.min(r, ranks.length-1);
    }

    function updateRanksUI(){
      const p = passages[idx];
      const chap = ensureChapter(p.id);
      chapterRankBadge.textContent = ranks[chap.rank];
      globalRankText.textContent = `å…¨åŸŸè»éšï¼š${ranks[mem.globalRank]}`;
    }

    /***********************
     * Render / Game logic
     ***********************/
    function setSpeech(fullText){
      // é è¦½ 3 è¡Œ clamp + â€¦ï¼ˆæ›´å¤šï¼‰
      speechFull.textContent = fullText;
      const safe = clampSpeechPreview(fullText);
      speechText.innerHTML = `
        <span class="name">å­«æ­¦ï¼š</span>
        <span class="speechClamp">${safe}</span>
        <span class="moreInline" id="moreInline">â€¦ï¼ˆæ›´å¤šï¼‰</span>
      `;
      // å¦‚æœå…¶å¯¦ä¸é•·ï¼Œå°±ä¸é¡¯ç¤ºæ›´å¤š
      requestAnimationFrame(()=>{
        const clampEl = speechText.querySelector(".speechClamp");
        const moreEl = document.getElementById("moreInline");
        if(!clampEl || !moreEl) return;
        // ç²—ç•¥åˆ¤æ–·ï¼šå­—æ•¸ä¸å¤šå°±ä¸æ”¾æ›´å¤š
        if(fullText.length <= 32){
          moreEl.style.display = "none";
        }else{
          moreEl.onclick = ()=> openSpeechModal(fullText);
        }
      });
    }

    function openSpeechModal(text){
      speechFull.textContent = text;
      openModal(speechModal);
    }

    function setHeader(){
      const p = passages[idx];
      chapterTitle.textContent = `${p.chapter}ãƒ»${p.title}`;
      progressText.textContent = `é€²åº¦ï¼š${idx+1} / ${passages.length}`;
    }

    function resetLevel(toMode="train"){
      const p = passages[idx];
      mode = toMode;
      placed = [];
      pool = shuffle(p.segments);
      readyForQuiz = false;

      modeText.textContent = (mode==="train")
        ? "æ¨¡å¼ï¼šæ¼”ç·´ï¼ˆä¾åºæ’å…¥ä½ˆä»¤æ¿ï¼‰"
        : "æ¨¡å¼ï¼šæ¸¬é©—ï¼ˆä¸é æç¤ºï¼Œé ä½ è‡ªå·±ï¼‰";

      // æ§åˆ¶æŒ‰éˆ•é¡¯ç¤º
      checkBtn.classList.add("hidden");
      nextBtn.classList.add("hidden");
      quizBtn.classList.add("hidden");

      // å…µæ›¸æŒ‰éˆ•é è¨­ä¸äº®
      bookBtn.classList.remove("glow");

      // åˆå§‹å°è©
      if(mode==="train"){
        setSpeech(rand(say.startTrain));
      }else{
        setSpeech(rand(say.quizStart));
      }

      render();
    }

    function render(){
      const p = passages[idx];

      // slot
      slot.innerHTML = "";
      if(placed.length === 0){
        const hint = document.createElement("div");
        hint.style.color = "rgba(233,241,233,.70)";
        hint.style.fontWeight = "900";
        hint.style.fontSize = `calc(14px * var(--fontScale))`;
        hint.style.letterSpacing = ".5px";
        hint.textContent = (mode==="train")
          ? "æŠŠä»¤ç‰Œä¾é †åºæ”¾å…¥ä½ˆä»¤æ¿ï¼ˆé»ä»¤ç‰Œå³å¯ï¼‰"
          : "æ¸¬é©—ï¼šæŠŠä»¤ç‰Œæ’å›æ­£ç¢ºé †åºï¼ˆæ…¢æ…¢ä¾†ï¼‰";
        slot.appendChild(hint);
      }else{
        placed.forEach((t,i)=>{
          slot.appendChild(makeToken(t, i+1, true));
        });
      }

      // tokens
      tokenWrap.innerHTML = "";
      pool.forEach((t,i)=>{
        const el = makeToken(t, i+1, false);
        el.dataset.text = t;

        // å­¸ç¿’æç¤ºï¼šåªæç¤ºã€Œä¸‹ä¸€å€‹è©²æ”¾çš„ã€
        if(settings.hintOn && mode==="train"){
          const next = p.segments[placed.length];
          if(t === next) el.classList.add("hintNext");
        }
        tokenWrap.appendChild(el);
      });

      tokenCountText.textContent = `å‰©é¤˜ï¼š${pool.length}`;
      hintStateText.textContent = `å­¸ç¿’æç¤ºï¼š${settings.hintOn ? "é–‹" : "é—œ"}`;

      // undo
      undoBtn.disabled = placed.length===0;
      undoBtn.style.opacity = placed.length===0 ? .55 : 1;

      // é©—ä»¤æŒ‰éˆ•ï¼šæ”¾æ»¿æ‰å‡ºç¾
      if(placed.length === p.segments.length){
        checkBtn.classList.remove("hidden");
      }else{
        checkBtn.classList.add("hidden");
      }
    }

    function makeToken(text, num, inSlot){
      const el = document.createElement("div");
      el.className = "token";
      el.innerHTML = `<small>${num}</small><span>${text}</span>`;
      el.onclick = ()=>{
        if(inSlot){
          // é»ä½ˆä»¤æ¿ä¸Šçš„ä»¤ç‰Œï¼šé€€å›ä»¤ç‰Œå€ï¼ˆæ›´ç›´è¦ºï¼‰
          beep(520, .05);
          pool.push(text);
          placed.splice(placed.indexOf(text), 1);
          render();
        }else{
          // é»ä»¤ç‰Œå€ï¼šæ”¾å…¥ä½ˆä»¤æ¿
          beep(740, .05);
          placed.push(text);
          pool.splice(pool.indexOf(text), 1);
          // æ¯æ”¾ä¸€æ¬¡ï¼Œå­«æ­¦å¶çˆ¾ä¸€å¥å¾ˆçŸ­çš„ã€Œæ¥å¾—ä¸Šã€
          if(mode==="train" && Math.random()<0.22){
            setSpeech(rand(say.onPick) + maybeSurprise("small"));
          }
          render();
        }
      };
      return el;
    }

    function undo(){
      if(placed.length===0) return;
      const last = placed.pop();
      pool.push(last);
      pool = shuffle(pool); // é€€ä¸€ä»¤å¾Œï¼Œä»¤ç‰Œå€ç¨å¾®é‡æ´—é¿å…å›ºå®šæ’åˆ—
      beep(420, .06);
      render();
    }

    function check(){
      const p = passages[idx];
      if(placed.length !== p.segments.length) return;

      const correct = placed.every((t,i)=> t===p.segments[i]);

      if(correct){
        onPass();
      }else{
        onFail();
      }
    }

    function onPass(){
      const p = passages[idx];
      // é©—ä»¤é€šéï¼šä¸è‡ªå‹•è·³å…µæ›¸ï¼Œåªäº®å‘¼å¸ç‡ˆæç¤ºå¯çœ‹
      const msg = rand(mode==="quiz" ? say.quizPass : say.onPass) + maybeSurprise("mid");
      setSpeech(msg);

      // é€šééŸ³æ•ˆ
      beep(920, .07, .06);
      setTimeout(()=>beep(1180,.07,.05), 90);

      // è¨˜éŒ„ XPï¼ˆæ··åˆåˆ¶ï¼štrain pass +1, quiz pass +2ï¼‰
      const chap = ensureChapter(p.id);
      const gained = (mode==="quiz") ? 2 : 1;
      chap.xp += gained;
      mem.globalXP += gained;

      // å‡éšï¼ˆä¸é¡¯ç¤ºé–€æª»ï¼‰
      chap.rank = xpToRank(chap.xp);
      mem.globalRank = xpToRank(mem.globalXP);
      saveMem();
      updateRanksUI();

      // å…µæ›¸å¯çœ‹ï¼šå‘¼å¸ç‡ˆæ›´æ˜é¡¯
      bookBtn.classList.add("glow");

      // æ¸¬é©—æŒ‰éˆ•ï¼šåªåœ¨ã€Œå°çš„æ™‚æ©Ÿã€å‡ºç¾ï¼ˆä½ è¦çš„ï¼‰
      // train é€šéå¾Œï¼Œé‚€è«‹æ¸¬é©—ï¼›quiz é€šéå‰‡ç›´æ¥çµæŸæ­¤æ®µæ¼”ç·´
      if(mode==="train"){
        readyForQuiz = true;
        quizBtn.classList.remove("hidden");
        // è¼•è²é‚€è«‹ï¼Œä¸å¼·è¿«
        setTimeout(()=>{
          setSpeech(rand(say.quizInvite) + maybeSurprise("small"));
        }, 650);
      }else{
        // quiz é€šéï¼šä¸‹ä¸€æ®µï¼ˆç¾åœ¨åªæœ‰ä¸€æ®µï¼Œå…ˆé¡¯ç¤ºå®Œæˆï¼‰
        nextBtn.classList.remove("hidden");
      }

      // ä½ è‹¥é¸ã€Œé€šéå¾Œè‡ªå‹•é–‹å…µæ›¸ã€æ‰è·³
      if(settings.autoBook){
        setTimeout(()=>openBook(), 350);
      }
    }

    function onFail(){
      // å¤±æ•—ï¼šä¸è²¬å‚™ï¼Œåªå¼•å°å›ä¾†
      const msg = rand(mode==="quiz" ? say.quizFail : say.onWrong) + maybeSurprise("small");
      setSpeech(msg);
      beep(220, .09, .06);

      // æ··åˆåˆ¶ï¼šå¤±æ•—ä¹Ÿç®—ã€Œæœ‰ç·´ã€ï¼Œä½†è¼ƒå°‘
      const p = passages[idx];
      const chap = ensureChapter(p.id);
      chap.xp += 0.2;
      mem.globalXP += 0.2;
      chap.rank = xpToRank(chap.xp);
      mem.globalRank = xpToRank(mem.globalXP);
      saveMem();
      updateRanksUI();

      // ä¸æ¸…ç©ºã€ä¸æ‡²ç½°ï¼Œè®“ä»–è‡ªå·±èª¿æ•´ï¼ˆä¹Ÿç¬¦åˆä½ ã€Œå¿«æ¨‚èƒŒèª¦ã€ï¼‰
    }

    function openBook(){
      const p = passages[idx];
      bookOriginal.textContent = p.segments.join("ï¼Œ");
      bookTranslation.textContent = p.translation;
      bookNote.textContent = "è£œè¨»ï¼š" + p.note;
      openModal(bookModal);
    }

    function startQuiz(){
      // æ¸¬é©—ï¼šç”¨åŒä¸€æ®µå…§å®¹ï¼Œä½†æ¨¡å¼åˆ‡ quiz
      const p = passages[idx];
      mode = "quiz";
      placed = [];
      pool = shuffle(p.segments);

      modeText.textContent = "æ¨¡å¼ï¼šæ¸¬é©—ï¼ˆä¸é æç¤ºï¼Œé ä½ è‡ªå·±ï¼‰";
      // æ¸¬é©—é è¨­ä¸çµ¦æç¤ºï¼Œä½†å­¸å“¡å¯åœ¨è¨­å®šæ‰“é–‹ï¼ˆä¸æ˜¯è€ƒè©¦ï¼‰
      // æˆ‘é€™è£¡ä¸å¼·åˆ¶é—œæ‰è¨­å®šï¼Œåªæ˜¯ UI æ–‡å­—æé†’ç”±ä½ æŒæ§

      bookBtn.classList.remove("glow");
      quizBtn.classList.add("hidden");
      nextBtn.classList.add("hidden");
      checkBtn.classList.add("hidden");

      setSpeech(rand(say.quizStart) + maybeSurprise("big"));
      render();
    }

    function next(){
      // v1.2 å…ˆåªåšä¸€å°æ®µé©—è­‰ï¼šå®Œæˆå¾Œçµ¦çµæŸè¨Šæ¯
      const done = "å§‹è¨ˆç¯‡ãƒ»ç¬¬ä¸€æ®µå·²æ”¶å¥½ã€‚ä»Šå¤©ä¸å¿…å†é€¼è‡ªå·±å¤šèƒŒï¼Œèƒ½æ”¶å¾—ä½çš„äººï¼Œé€²æ­¥æœ€å¿«ã€‚";
      setSpeech(done + maybeSurprise("big"));
      // äº®ä¸€ä¸‹å…µæ›¸ï¼Œæ–¹ä¾¿å›çœ‹
      bookBtn.classList.add("glow");
      nextBtn.classList.add("hidden");
      checkBtn.classList.add("hidden");
      quizBtn.classList.add("hidden");
    }

    /***********************
     * Settings UI
     ***********************/
    function openSettings(){
      fontSlider.value = settings.fontScale;
      hintToggle.checked = settings.hintOn;
      sfxToggle.checked = settings.sfxOn;
      ttsToggle.checked = settings.ttsOn;
      autoBookToggle.checked = settings.autoBook;
      openModal(settingsModal);
    }

    function applySettingsFromUI(){
      settings.fontScale = parseFloat(fontSlider.value);
      settings.hintOn = !!hintToggle.checked;
      settings.sfxOn = !!sfxToggle.checked;
      settings.ttsOn = !!ttsToggle.checked;
      settings.autoBook = !!autoBookToggle.checked;

      setRootFontScale(settings.fontScale);
      saveSettings();
      render();
    }

    const SETTINGS_KEY = "sunzi_mem_settings_v12";
    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        if(raw){
          const obj = JSON.parse(raw);
          Object.assign(settings, obj);
        }
      }catch(e){}
      setRootFontScale(settings.fontScale);
    }
    function saveSettings(){
      try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }catch(e){}
    }
    function resetSettings(){
      settings.fontScale = 1.0;
      settings.hintOn = true;
      settings.sfxOn = true;
      settings.ttsOn = true;
      settings.autoBook = false;
      setRootFontScale(settings.fontScale);
      saveSettings();
    }

    /***********************
     * Bind events
     ***********************/
    resetBtn.onclick = ()=> resetLevel(mode); // åŒæ¨¡å¼é‡æ•´
    undoBtn.onclick = undo;
    checkBtn.onclick = check;
    quizBtn.onclick = startQuiz;
    nextBtn.onclick = next;

    bookBtn.onclick = openBook;
    closeBook.onclick = ()=> closeModal(bookModal);
    bookOkBtn.onclick = ()=> closeModal(bookModal);
    bookReadBtn.onclick = ()=>{
      const p = passages[idx];
      // æœ—è®€åŸæ–‡ï¼ˆé †å£ç”¨ï¼‰
      speak(p.segments.join("ï¼Œ") + "ã€‚");
      beep(660,.06,.04);
    };

    settingsBtn.onclick = openSettings;
    closeSettings.onclick = ()=> closeModal(settingsModal);
    settingsOkBtn.onclick = ()=>{
      applySettingsFromUI();
      closeModal(settingsModal);
    };
    settingsResetBtn.onclick = ()=>{
      resetSettings();
      fontSlider.value = settings.fontScale;
      hintToggle.checked = settings.hintOn;
      sfxToggle.checked = settings.sfxOn;
      ttsToggle.checked = settings.ttsOn;
      autoBookToggle.checked = settings.autoBook;
      applySettingsFromUI();
      beep(520,.06,.04);
    };

    closeSpeech.onclick = ()=> closeModal(speechModal);
    speechOkBtn.onclick = ()=> closeModal(speechModal);

    // é»èƒŒæ™¯é—œé–‰ modalï¼ˆé¿å…èª¤è§¸æ™‚å¡ä½ï¼‰
    [bookModal, settingsModal, speechModal].forEach(m=>{
      m.addEventListener("click", (e)=>{
        if(e.target === m) closeModal(m);
      });
    });

    // speech more click handled inside setSpeech

    /***********************
     * Init
     ***********************/
    function init(){
      loadSettings();
      setHeader();
      updateRanksUI();

      // åˆå§‹åŒ–å…µæ›¸æŒ‰éˆ•ï¼šåªæœ‰ã€Œé€šéå¾Œã€æ‰äº®
      bookBtn.classList.remove("glow");

      resetLevel("train");
    }

    init();
  </script>
</body>
</html>
