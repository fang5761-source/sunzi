<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­«å­ï¼šæ²™ç›¤æ¨æ¼” V6.0 (æœ€çµ‚æ±ºæˆ°ç‰ˆ)</title>
    <style>
        :root {
            /* V6.0 æ²™ç›¤é…è‰² */
            --wood-desk: #3E2723; /* æ·±è‰²æœ¨æ¡Œ */
            --map-paper: #D7CCC8; /* å¤åœ°åœ–ç´™ */
            --scroll-paper: #FFF8E1; /* è»ä»¤ç‹€ç´™ */
            --bamboo-dark: #5D4037;
            --bamboo-light: #D7A566;
            --accent-red: #B71C1C; /* å°ç« ç´… */
            --accent-gold: #FFD700; /* è»éšé‡‘ */
            --success-green: #2E7D32;
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", serif;
            margin: 0;
            padding: 0;
            /* èƒŒæ™¯å‡ç´šï¼šæœ¨æ¡Œ + åœ°åœ–ç¶²æ ¼ */
            background-color: var(--wood-desk);
            background-image: 
                linear-gradient(rgba(62, 39, 35, 0.8), rgba(62, 39, 35, 0.8)), /* æœ¨ç´‹é®ç½© */
                repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(0,0,0,0.2) 20px), /* æ©«å‘ç¶²æ ¼ */
                repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(0,0,0,0.2) 20px), /* ç¸±å‘ç¶²æ ¼ */
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect fill="%235D4037" width="50" height="50" x="0" y="0"/><rect fill="%234E342E" width="50" height="50" x="50" y="0"/><rect fill="%234E342E" width="50" height="50" x="0" y="50"/><rect fill="%235D4037" width="50" height="50" x="50" y="50"/></svg>'); /* æœ¨ç´‹ç†åŸºåº• */
            background-size: auto, 20px 20px, 20px 20px, 100px 100px;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        /* === é ‚éƒ¨è»å¸³æ©«æ¢ === */
        header {
            width: 100%;
            background: linear-gradient(to bottom, var(--wood-desk), #2c1b18);
            padding: 10px 0 5px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            z-index: 10;
            border-bottom: 3px solid #1a100e;
            flex-shrink: 0;
        }

        h1 {
            font-size: 1.4rem;
            margin: 0;
            text-align: center;
            color: var(--accent-gold);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            letter-spacing: 3px;
            font-family: "æ¨™æ¥·é«”", serif; /* æ›´æœ‰å¤é¢¨ */
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 92%;
            margin: 10px auto 0;
            color: #ccc;
        }

        .level-tag {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Switch Toggle (ç¶­æŒåŸæ¨£ï¼Œèª¿æ•´é…è‰²) */
        .switch-container {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            gap: 5px;
        }
        .switch-input { display: none; }
        .switch-track {
            width: 36px; height: 20px; background-color: #555; border-radius: 20px; position: relative; transition: 0.3s;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        .switch-knob {
            width: 16px; height: 16px; background-color: #ccc; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s;
        }
        .switch-input:checked + .switch-track { background-color: var(--accent-red); }
        .switch-input:checked + .switch-track .switch-knob { transform: translateX(16px); background-color: #fff; }

        /* é€²åº¦æ¢ï¼šè¡Œè»è·¯ç·š */
        .progress-container {
            width: 92%;
            height: 8px;
            background: rgba(0,0,0,0.6);
            margin: 8px auto 5px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #444;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--accent-red), var(--accent-gold));
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }
        /* é€²åº¦æ¢ä¸Šçš„å°æ——å¹Ÿ */
        .progress-fill::after {
            content: 'ğŸš©';
            position: absolute;
            right: -10px;
            top: -6px;
            font-size: 14px;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
        }

        /* === éŠæˆ²ä¸»å€åŸŸ === */
        #game-container {
            flex-grow: 1;
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
        }

        /* NPC å°è©±æ¡†ï¼šå°‡è»å°é¢¨æ ¼ */
        .npc-area {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-shrink: 0;
            align-items: center;
        }
        .npc-avatar {
            width: 54px;
            height: 54px;
            /* å°‡è»å°é¢¨æ ¼ */
            background: #8d6e63;
            color: var(--accent-gold);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.1rem;
            border: 4px solid var(--accent-gold);
            box-shadow: 0 5px 10px rgba(0,0,0,0.4), inset 0 2px 5px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
            font-family: "æ¨™æ¥·é«”", serif;
        }
        .npc-text {
            background: rgba(255, 248, 225, 0.9); /* æ³›é»ƒç´™å¼µæ„Ÿ */
            color: #333;
            padding: 12px 18px;
            border-radius: 8px 20px 20px 20px;
            border: 2px solid #5d4037;
            font-size: 0.95rem;
            line-height: 1.4;
            flex: 1;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.3);
            position: relative;
            font-weight: bold;
        }

        /* === 1. ä¸Šæ–¹æ”¾ç½®å€ï¼šè»ä»¤ç‹€å·è»¸ === */
        .target-zone-wrapper {
            flex-grow: 1;
            background: var(--scroll-paper); /* å·è»¸ç´™è‰² */
            /* å·è»¸é‚Šç·£æ•ˆæœ */
            background-image: linear-gradient(to right, rgba(0,0,0,0.1) 0%, transparent 5%, transparent 95%, rgba(0,0,0,0.1) 100%);
            border-top: 8px solid var(--bamboo-dark); /* å·è»¸è»¸å¿ƒ */
            border-bottom: 8px solid var(--bamboo-dark);
            border-left: 2px solid #c7bba8;
            border-right: 2px solid #c7bba8;
            border-radius: 4px;
            margin-bottom: 15px;
            position: relative;
            box-shadow: inset 0 0 30px rgba(141, 110, 99, 0.3), 0 10px 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* å·è»¸è»¸å¿ƒè£é£¾ */
        .target-zone-wrapper::before, .target-zone-wrapper::after {
            content: ''; position: absolute; width: 12px; height: 100%; background: #3e2723; top:0;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .target-zone-wrapper::before { left: 0; }
        .target-zone-wrapper::after { right: 0; }

        .scroll-board {
            padding: 20px 25px;
            overflow-y: auto;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            /* å·è»¸å…§éƒ¨æµ®æ°´å° */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.05"><text x="50%" y="50%" font-size="80" text-anchor="middle" dominant-baseline="middle" font-family="æ¨™æ¥·é«”" fill="black">å­«å­</text></svg>');
            background-repeat: no-repeat;
            background-position: center;
        }

        .hint-text {
            color: #8d6e63;
            margin-top: 40px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0.7;
        }

        /* === 2. ä¸‹æ–¹å€™é¸å€ï¼šæŒ‡æ®æ¡Œåº•éƒ¨ === */
        .source-zone-wrapper {
            flex-shrink: 0;
            background: rgba(0,0,0,0.3); /* åŠé€æ˜æ·±è‰² */
            border-top: 3px solid #5d4037;
            padding: 15px 5px 20px 5px; /* åº•éƒ¨ç•™å¤šä¸€é»ç©ºé–“çµ¦ç«‹é«”æŒ‰éˆ• */
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 15px 15px 0 0;
            box-shadow: inset 0 5px 10px rgba(0,0,0,0.3);
        }
        
        .section-label {
            font-size: 0.85rem;
            color: #ccc;
            margin-bottom: 10px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .options-board {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px 10px; /* å¢åŠ å‚ç›´é–“è·ï¼Œé¿å…ç«‹é«”æŒ‰éˆ•æ‰“æ¶ */
            min-height: 80px;
        }

        /* === 3. ç«¹ç°¡/å…µæ£‹æ¨£å¼ (V6.0 ç«‹é«”åŒ–å‡ç´š) === */
        .bamboo-slip {
            /* ç«‹é«”æ„Ÿæ ¸å¿ƒï¼šå¤šé‡æ¼¸å±¤èˆ‡é™°å½± */
            background: linear-gradient(to bottom, #eecfa1 0%, #d7a566 100%);
            border: none;
            /* å´é¢åšåº¦èˆ‡åº•éƒ¨é™°å½± */
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.4), /* é ‚éƒ¨é«˜å…‰ */
                0 4px 0 #8d6e63, /* å´é¢åšåº¦ (æ·±è‰²) */
                0 8px 10px rgba(0,0,0,0.4); /* åº•éƒ¨æŠ•å½± */
            
            padding: 12px 18px;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #3e2723;
            cursor: pointer;
            text-shadow: 0 1px 0 rgba(255,255,255,0.3);
            font-family: "æ¨™æ¥·é«”", serif;
            
            flex: 0 0 auto;
            min-width: 70px;
            text-align: center;
            
            transition: all 0.1s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            top: 0; /* åˆå§‹ä½ç½® */
        }

        /* æŒ‰ä¸‹æ•ˆæœï¼šçœŸå¯¦ä¸‹å£“ */
        .bamboo-slip:active {
            top: 4px; /* å‘ä¸‹ç§»å‹•ç­‰æ–¼åšåº¦çš„é«˜åº¦ */
            box-shadow: 
                inset 0 2px 5px rgba(0,0,0,0.2),
                0 0px 0 #8d6e63, /* åšåº¦æ¶ˆå¤± */
                0 2px 5px rgba(0,0,0,0.4); /* æŠ•å½±è®Šå° */
            background: linear-gradient(to bottom, #d7a566 0%, #c99555 100%); /* é¡è‰²è®Šæ·± */
        }

        /* æç¤ºç‰¹æ•ˆï¼šç™¼å…‰é‚Šç·£ */
        .bamboo-slip.hint-active {
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.4),
                0 4px 0 #f57f17, /* å´é¢è®Šäº® */
                0 0 15px #ffeb3b, /* ç™¼å…‰ */
                0 8px 10px rgba(0,0,0,0.4);
            animation: pulse-gold 1s infinite alternate;
            color: #000;
        }

        @keyframes pulse-gold {
            from { filter: brightness(1); }
            to { filter: brightness(1.15); }
        }

        /* æŒ‰éˆ•å€ */
        .action-area {
            display: flex;
            gap: 15px;
            width: 100%;
            justify-content: center;
            margin-bottom: 15px;
        }

        /* æ“ä½œæŒ‰éˆ•ä¹Ÿç«‹é«”åŒ– */
        .game-btn {
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            color: white;
            flex: 1;
            max-width: 160px;
            font-family: "æ¨™æ¥·é«”", serif;
            letter-spacing: 1px;
            transition: all 0.1s;
            position: relative; top: 0;
        }
        #check-answer-btn {
            background: linear-gradient(to bottom, #43a047, #2e7d32);
            box-shadow: 0 4px 0 #1b5e20, 0 8px 10px rgba(0,0,0,0.3);
            display: none;
        }
        #reset-btn {
            background: linear-gradient(to bottom, #8d6e63, #5d4037);
            box-shadow: 0 4px 0 #3e2723, 0 8px 10px rgba(0,0,0,0.3);
        }
        .game-btn:active {
            top: 4px;
            box-shadow: 0 0px 0 #000, 0 2px 5px rgba(0,0,0,0.4);
        }

        /* === Modal èˆ‡ å‹åˆ©å°ç« å‹•ç•« === */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: var(--scroll-paper);
            width: 85%; max-width: 400px;
            padding: 30px 25px;
            border-radius: 8px;
            border: 4px solid var(--bamboo-dark);
            text-align: center; color: #333;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%235D4037" stroke-width="1" stroke-dasharray="5,5"/></svg>');
        }
        
        /* å‹åˆ©å¤§å°ç«  */
        .big-stamp {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(3) rotate(-15deg);
            width: 120px; height: 120px;
            border: 6px solid var(--accent-red);
            border-radius: 10px;
            color: var(--accent-red);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.8rem;
            background: rgba(183, 28, 28, 0.1);
            opacity: 0; /* åˆå§‹éš±è— */
            pointer-events: none;
            font-family: "æ¨™æ¥·é«”", serif;
            z-index: 2001;
            /* è“‹ç« å‹•ç•« */
            animation: stamp-effect 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes stamp-effect {
            0% { transform: translate(-50%, -50%) scale(3) rotate(-15deg); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(-15deg); opacity: 0.9; }
        }

        .translation-text {
            text-align: left; margin: 25px 0; line-height: 1.8;
            color: #3e2723; background: rgba(255,255,255,0.5);
            padding: 15px; border-radius: 5px; border: 1px solid #d7ccc8;
            font-size: 1.05rem;
        }

    </style>
</head>
<body>

    <header>
        <h1>å­«å­ï¼šæ²™ç›¤æ¨æ¼”</h1>
        <div class="header-controls">
            <div class="level-tag" id="level-indicator">è¼‰å…¥ä¸­...</div>
            <label class="switch-container">
                <span>æç¤º</span>
                <input type="checkbox" id="hint-toggle" class="switch-input" checked onchange="toggleHint()">
                <div class="switch-track"><div class="switch-knob"></div></div>
            </label>
        </div>
        <div class="progress-container"><div class="progress-fill" id="progress-bar"></div></div>
    </header>

    <div id="game-container">
        
        <div class="npc-area">
            <div class="npc-avatar">å­«æ­¦</div>
            <div class="npc-text" id="npc-text">å°‡è»ï¼Œè«‹çœ‹æ²™ç›¤ã€‚</div>
        </div>

        <div class="target-zone-wrapper">
            <div id="victory-stamp" class="big-stamp" style="display: none;">è³ï¼šè¬€ç•¥é”æˆ</div>
            <div class="scroll-board" id="target-zone">
                <div class="hint-text" id="hint-text">(è«‹é»æ“Šä¸‹æ–¹å…µæ£‹ä½ˆé™£)</div>
            </div>
        </div>

        <div class="action-area">
            <button id="reset-btn" class="game-btn" onclick="resetCurrentLevel()">â†º é‡æ•´æ——é¼“</button>
            <button id="check-answer-btn" class="game-btn" onclick="showModal()">ğŸ“œ é©—æ”¶è»ä»¤</button>
        </div>

        <div class="source-zone-wrapper">
            <div class="section-label">â–¼ å€™é¸å…µæ£‹ â–¼</div>
            <div class="options-board" id="source-zone"></div>
        </div>

    </div>

    <div class="modal" id="win-modal">
        <div class="modal-content">
            <h2 style="color: var(--wood-dark); margin-top:0px; font-family: 'æ¨™æ¥·é«”';">â˜… è»ä»¤ç„¡èª¤ â˜…</h2>
            <div class="translation-text" id="modal-content"></div>
            <div style="display:flex; gap:15px; justify-content: center;">
                <button class="game-btn" style="background: linear-gradient(to bottom, #757575, #616161); box-shadow: 0 4px 0 #424242;" onclick="replayLevel()">å†æ¬¡æ¼”ç·´</button>
                <button class="game-btn" style="background: linear-gradient(to bottom, #3e2723, #2c1b18); box-shadow: 0 4px 0 #1a100e;" onclick="nextLevel()">ä¸‹ä¸€é—œ</button>
            </div>
        </div>
    </div>

    <script>
        window.onload = function() { initGame(); };

        // é¡Œåº«è³‡æ–™ (ç¶­æŒåŸæ¨£)
        const levels = [
            { segments: ["å…µè€…", "åœ‹ä¹‹å¤§äº‹", "æ­»ç”Ÿä¹‹åœ°", "å­˜äº¡ä¹‹é“", "ä¸å¯ä¸å¯Ÿä¹Ÿ"], translation: "ã€ç™½è©±ã€‘æˆ°çˆ­æ˜¯åœ‹å®¶çš„å¤§äº‹ï¼Œé—œä¿‚åˆ°è»æ°‘çš„ç”Ÿæ­»ï¼Œåœ‹å®¶çš„å­˜äº¡ï¼Œæ˜¯çµ•å°ä¸å¯ä»¥ä¸èªçœŸè€ƒå¯Ÿç ”ç©¶çš„ã€‚", npcWin: "å­«æ­¦ï¼šã€Œä¸éŒ¯ï¼ä¸çŸ¥æ­»ç”Ÿï¼Œä¸é…è¨€å…µã€‚ã€" },
            { segments: ["ä¸€æ›°é“", "äºŒæ›°å¤©", "ä¸‰æ›°åœ°", "å››æ›°å°‡", "äº”æ›°æ³•"], translation: "ã€ç™½è©±ã€‘é€™äº”å€‹æ–¹é¢æ˜¯ï¼šç¬¬ä¸€æ˜¯é“ï¼ˆæ”¿æ²»ï¼‰ï¼Œç¬¬äºŒæ˜¯å¤©ï¼ˆå¤©æ™‚ï¼‰ï¼Œç¬¬ä¸‰æ˜¯åœ°ï¼ˆåœ°åˆ©ï¼‰ï¼Œç¬¬å››æ˜¯å°‡ï¼ˆå°‡é ˜ï¼‰ï¼Œç¬¬äº”æ˜¯æ³•ï¼ˆæ³•åˆ¶ï¼‰ã€‚", npcWin: "å­«æ­¦ï¼šã€Œæ­¤äº”è€…ï¼Œå°‡é ˜ä¸å¯ä¸å¯Ÿã€‚ã€" },
            { segments: ["é“è€…", "ä»¤æ°‘èˆ‡ä¸ŠåŒæ„ä¹Ÿ", "æ•…å¯èˆ‡ä¹‹æ­»", "å¯èˆ‡ä¹‹ç”Ÿ", "è€Œä¸ç•å±"], translation: "ã€ç™½è©±ã€‘æ‰€è¬‚ã€Œé“ã€ï¼Œå°±æ˜¯ä½¿æ°‘çœ¾èˆ‡å›ä¸»çš„æ„é¡˜ä¸€è‡´ã€‚é€™æ¨£ï¼Œæ°‘çœ¾å°±èƒ½èˆ‡å›ä¸»åŒç”Ÿæ­»ã€å…±æ‚£é›£ï¼Œè€Œä¸ç•æ‡¼å±éšªã€‚", npcWin: "å­«æ­¦ï¼šã€Œä¸Šä¸‹åŒæ¬²è€…å‹ï¼Œæ­¤ä¹ƒé“ä¹Ÿã€‚ã€" },
            { segments: ["å¤©è€…", "é™°é™½", "å¯’æš‘", "æ™‚åˆ¶ä¹Ÿ"], translation: "ã€ç™½è©±ã€‘æ‰€è¬‚ã€Œå¤©ã€ï¼Œå°±æ˜¯æŒ‡æ™å¤œé™°é™½çš„è®ŠåŒ–ï¼Œå¯’å†¬æš‘å­£çš„æ›´æ›¿ï¼Œä»¥åŠé©æ–¼ä½œæˆ°çš„å­£ç¯€æ°£å€™ã€‚", npcWin: "å­«æ­¦ï¼šã€ŒçŸ¥å¤©æ™‚è€…ï¼Œå¯å€Ÿé¢¨é›¨ä¹‹åŠ›ã€‚ã€" },
            { segments: ["åœ°è€…", "é è¿‘", "éšªæ˜“", "å»£ç‹¹", "æ­»ç”Ÿä¹Ÿ"], translation: "ã€ç™½è©±ã€‘æ‰€è¬‚ã€Œåœ°ã€ï¼Œæ˜¯æŒ‡è·¯ç¨‹çš„é è¿‘ã€åœ°å‹¢çš„éšªè¦æˆ–å¹³å¦ã€æˆ°å ´çš„å»£é—Šæˆ–ç‹¹çª„ï¼Œä»¥åŠåœ°å½¢æ˜¯çµ•åœ°é‚„æ˜¯ç”Ÿè·¯ã€‚", npcWin: "å­«æ­¦ï¼šã€Œåœ°åˆ©è€…ï¼Œå…µä¹‹åŠ©ä¹Ÿã€‚ã€" },
            { segments: ["å°‡è€…", "æ™º", "ä¿¡", "ä»", "å‹‡", "åš´ä¹Ÿ"], translation: "ã€ç™½è©±ã€‘æ‰€è¬‚ã€Œå°‡ã€ï¼Œå°±æ˜¯å°‡é ˜è¦å…·å‚™æ™ºæ…§ã€èª ä¿¡ã€ä»æ„›ã€å‹‡æ•¢ã€åš´æ˜é€™äº”ç¨®ç´ è³ªã€‚", npcWin: "å­«æ­¦ï¼šã€Œç‚ºå°‡è€…ï¼Œç•¶å…·å‚™æ­¤äº”å¾·ã€‚ã€" },
            { segments: ["æ³•è€…", "æ›²åˆ¶", "å®˜é“", "ä¸»ç”¨ä¹Ÿ"], translation: "ã€ç™½è©±ã€‘æ‰€è¬‚ã€Œæ³•ã€ï¼Œæ˜¯æŒ‡è»éšŠçš„çµ„ç¹”ç·¨åˆ¶ã€å°‡åçš„è·è²¬ç®¡ç†ã€ä»¥åŠè»éœ€ç‰©è³‡çš„ä¾›æ‡‰ç®¡ç†ã€‚", npcWin: "å­«æ­¦ï¼šã€Œæ³•åˆ¶ä¸æ˜ï¼Œå‰‡è»ä»¤ä¸è¡Œã€‚ã€" }
        ];

        let currentLevel = 0;
        let currentSelection = [];
        let pool = [];
        let isHintOn = true;

        // DOM å…ƒç´ åƒè€ƒ
        const targetZone = document.getElementById('target-zone');
        const sourceZone = document.getElementById('source-zone');
        const hintText = document.getElementById('hint-text');
        const npcText = document.getElementById('npc-text');
        const levelIndicator = document.getElementById('level-indicator');
        const progressBar = document.getElementById('progress-bar');
        const winModal = document.getElementById('win-modal');
        const modalContent = document.getElementById('modal-content');
        const hintToggle = document.getElementById('hint-toggle');
        const checkBtn = document.getElementById('check-answer-btn');
        const resetBtn = document.getElementById('reset-btn');
        const victoryStamp = document.getElementById('victory-stamp');
        const targetZoneWrapper = document.querySelector('.target-zone-wrapper');

        function initGame() { loadLevel(currentLevel); }
        function toggleHint() { isHintOn = hintToggle.checked; updateHintEffect(); updateNpcText(); }

        function updateNpcText() {
            if (checkBtn.style.display === 'block') return;
            npcText.innerText = isHintOn ? "å­«æ­¦ï¼šã€Œä¾å…µæ£‹å…‰èŠ’ï¼Œä½ˆä¸‹é™£å‹¢ã€‚ã€" : "å­«æ­¦ï¼šã€Œæˆ°å ´è¿·éœ§é‡é‡ï¼Œå…¨æ†‘å°‡è»æ±ºæ–·ï¼ã€";
            npcText.style.color = "#333";
            targetZoneWrapper.style.borderColor = "#c7bba8"; // å›å¾©å·è»¸é‚Šæ¡†
        }

        function loadLevel(idx) {
            currentSelection = [];
            pool = [...levels[idx].segments].sort(() => Math.random() - 0.5);

            levelIndicator.innerText = `æˆ°å½¹ ${idx + 1} / ${levels.length}`;
            // æ›´æ–°è¡Œè»æ——å¹Ÿä½ç½®
            progressBar.style.width = `${((idx) / levels.length) * 100}%`;
            
            checkBtn.style.display = 'none'; 
            resetBtn.style.display = 'block'; 
            winModal.style.display = 'none';
            victoryStamp.style.display = 'none'; // éš±è—å°ç« 

            npcText.innerText = "...";

            setTimeout(() => {
                renderBoard();
                updateNpcText();
            }, 50);
        }

        function renderBoard() {
            targetZone.innerHTML = '';
            if (currentSelection.length === 0) targetZone.appendChild(hintText);
            else currentSelection.forEach((text, i) => targetZone.appendChild(createBamboo(text, 'target', i)));

            sourceZone.innerHTML = '';
            pool.forEach((text, i) => {
                const btn = createBamboo(text, 'source', i);
                btn.setAttribute('data-text', text);
                sourceZone.appendChild(btn);
            });
            updateHintEffect();
        }

        function updateHintEffect() {
            const allBtns = sourceZone.querySelectorAll('.bamboo-slip');
            allBtns.forEach(btn => btn.classList.remove('hint-active'));
            if (!isHintOn) return;

            const data = levels[currentLevel];
            if (currentSelection.length >= data.segments.length) return;
            const nextText = data.segments[currentSelection.length];

            for(let btn of allBtns) {
                if (btn.getAttribute('data-text') === nextText) {
                    btn.classList.add('hint-active');
                    break;
                }
            }
        }

        function createBamboo(text, type, index) {
            if (checkBtn.style.display === 'block') {
                 // éé—œå¾Œç”¢ç”Ÿä¸€å€‹ç´”å±•ç¤ºçš„å…µæ£‹ (æ²’æœ‰é»æ“Šäº‹ä»¶)
                 const displayBtn = document.createElement('div');
                 displayBtn.className = 'bamboo-slip';
                 displayBtn.innerText = text;
                 displayBtn.style.cursor = 'default';
                 // ç§»é™¤ç«‹é«”æ•ˆæœè®“å®ƒçœ‹èµ·ä¾†è²¼åœ¨å·è»¸ä¸Š
                 displayBtn.style.boxShadow = 'none';
                 displayBtn.style.background = 'transparent';
                 displayBtn.style.border = '2px solid #5d4037';
                 return displayBtn;
            }

            const btn = document.createElement('div');
            btn.className = 'bamboo-slip';
            btn.innerText = text;
            btn.onclick = function() {
                // ç°¡å–®çš„è§¸è¦ºå›é¥‹
                if (navigator.vibrate) navigator.vibrate(10); 
                
                if (type === 'source') {
                    currentSelection.push(text);
                    pool.splice(pool.indexOf(text), 1);
                } else {
                    pool.push(text);
                    currentSelection.splice(currentSelection.indexOf(text), 1);
                }
                renderBoard();
                checkWin();
            };
            return btn;
        }

        function checkWin() {
            const data = levels[currentLevel];
            if (currentSelection.length !== data.segments.length) return;

            const isCorrect = currentSelection.every((val, i) => val === data.segments[i]);

            if (isCorrect) {
                npcText.innerText = data.npcWin;
                npcText.style.color = var(--accent-red);
                targetZoneWrapper.style.borderColor = var(--success-green); // å·è»¸é‚Šæ¡†è®Šç¶ 
                
                // æ’­æ”¾å‹åˆ©å‹•ç•«
                victoryStamp.style.display = 'flex';
                // è®“ç›®æ¨™å€çš„å…µæ£‹è®Šæˆå¹³é¢è²¼åœ¨å·è»¸ä¸Šçš„æ¨£å­
                renderBoard(); 

                checkBtn.style.display = 'block';
                resetBtn.style.display = 'none';
                 // å‹åˆ©è§¸è¦ºå›é¥‹
                if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
            } else {
                npcText.innerText = "å­«æ­¦ï¼šã€Œé™£å‹¢å·²äº‚ï¼è«‹é‡æ•´æ——é¼“ã€‚ã€";
                // éŒ¯èª¤è§¸è¦ºå›é¥‹
                if (navigator.vibrate) navigator.vibrate(200);
            }
        }

        function showModal() {
             const data = levels[currentLevel];
             // å¼·èª¿åŸæ–‡
             modalContent.innerHTML = `<div style="font-size:1.2rem; font-weight:bold; margin-bottom:10px; font-family:'æ¨™æ¥·é«”';">${data.segments.join('ï¼Œ')}</div>${data.translation}`;
             winModal.style.display = 'flex';
        }

        function nextLevel() {
            currentLevel++;
            if (currentLevel >= levels.length) { alert("æ­å–œå°‡è»ï¼å§‹è¨ˆç¯‡æ¼”ç·´å®Œç•¢ï¼"); currentLevel = 0; }
            loadLevel(currentLevel);
        }

        function replayLevel() { loadLevel(currentLevel); }
        function resetCurrentLevel() { loadLevel(currentLevel); }
    </script>
</body>
</html>
