<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>孫子兵法｜原文佈令 v1（始計篇 Demo）</title>
  <style>
    :root{
      --bg:#0f1410;
      --panel:#141b14;
      --panel2:#101610;
      --line:#2a3a2a;
      --text:#e8f0e8;
      --muted:#a9b6a9;
      --accent:#d7b35a;
      --accent2:#7cc08a;
      --danger:#d36b6b;
      --shadow:rgba(0,0,0,.35);
      --glow:rgba(215,179,90,.35);
      --glow2:rgba(124,192,138,.35);
      --fontScale:1.00;
      --breath: 2.8s;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", system-ui, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(215,179,90,.08), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(124,192,138,.08), transparent 60%),
        linear-gradient(180deg, #0c110c, #0f1410 45%, #0c110c);
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }

    /* ===== Top bar ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 10px 8px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(20,27,20,.95), rgba(16,22,16,.70));
      position:relative;
      z-index:5;
    }
    .titleWrap{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .titleLine{
      display:flex;
      align-items:baseline;
      gap:8px;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .bookTitle{
      font-weight:800;
      letter-spacing:.5px;
      font-size: calc(15px * var(--fontScale));
    }
    .chapTitle{
      font-weight:700;
      color:var(--muted);
      font-size: calc(13px * var(--fontScale));
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 48vw;
    }
    .rankPill{
      flex:0 0 auto;
      border:1px solid rgba(215,179,90,.45);
      background:rgba(215,179,90,.10);
      color: #f1e1b4;
      padding:2px 8px;
      border-radius:999px;
      font-size: calc(12px * var(--fontScale));
      font-weight:800;
    }
    .subline{
      font-size: calc(12px * var(--fontScale));
      color:var(--muted);
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .topActions{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .iconBtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      border-radius:10px;
      padding:8px 10px;
      font-size: calc(13px * var(--fontScale));
      font-weight:800;
      box-shadow: 0 10px 18px var(--shadow);
      -webkit-tap-highlight-color: transparent;
    }
    .iconBtn:active{ transform: translateY(1px); }

    /* ===== Layout ===== */
    .wrap{
      height: calc(100vh - 56px);
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:10px;
      max-width:720px;
      margin:0 auto;
    }

    /* ===== NPC line + controls ===== */
    .npcRow{
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .npcCard{
      flex:1;
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      background: linear-gradient(180deg, rgba(20,27,20,.75), rgba(16,22,16,.6));
      box-shadow: 0 12px 22px var(--shadow);
      min-height:64px;
      overflow:hidden;
    }
    .avatar{
      width:40px;
      height:40px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      border:1px solid rgba(215,179,90,.40);
      background: radial-gradient(circle at 30% 30%, rgba(215,179,90,.25), rgba(215,179,90,.08));
      font-weight:900;
      letter-spacing:.5px;
    }
    .npcText{
      min-width:0;
      line-height:1.25;
      font-size: calc(13px * var(--fontScale));
      color:var(--text);
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .npcMore{
      color:#f1e1b4;
      opacity:.9;
      font-weight:800;
      margin-left:6px;
      cursor:pointer;
      white-space:nowrap;
      border-bottom:1px dashed rgba(215,179,90,.55);
    }

    .sideBtns{
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:0 0 auto;
      width:110px;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      font-size: calc(13px * var(--fontScale));
      font-weight:900;
      box-shadow: 0 12px 18px var(--shadow);
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{
      border-color: rgba(124,192,138,.55);
      background: rgba(124,192,138,.10);
      color:#dff3e4;
    }
    .btnDanger{
      border-color: rgba(211,107,107,.55);
      background: rgba(211,107,107,.10);
      color:#ffe4e4;
    }
    .btnGold{
      border-color: rgba(215,179,90,.55);
      background: rgba(215,179,90,.10);
      color:#f1e1b4;
    }

    /* ===== Boards ===== */
    .boards{
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
      min-height:0;
    }
    .board{
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(20,27,20,.78), rgba(16,22,16,.62));
      box-shadow: 0 14px 26px var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .boardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(42,58,42,.9);
      background: rgba(16,22,16,.55);
    }
    .boardTitle{
      font-weight:900;
      font-size: calc(13px * var(--fontScale));
      color:var(--muted);
      letter-spacing:.4px;
    }
    .mini{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .segPill{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: calc(12px * var(--fontScale));
      font-weight:900;
      white-space:nowrap;
    }
    .segPill strong{ color:var(--text); }

    .boardBody{
      padding:10px 10px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-content:flex-start;
      justify-content:flex-start;
      min-height:0;
    }

    /* Fixed-height layout on mobile: keep both boards visible */
    .board.big{ flex: 0 0 44%; }
    .board.small{ flex: 1; }

    @media (max-height: 740px){
      .board.big{ flex-basis: 42%; }
    }
    @media (max-height: 680px){
      .board.big{ flex-basis: 40%; }
      .btn{ padding:9px 10px; }
    }

    /* ===== Tokens ===== */
    .token{
      border:1px solid rgba(215,179,90,.35);
      background: linear-gradient(180deg, rgba(215,179,90,.16), rgba(215,179,90,.07));
      color:#f1e1b4;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      font-size: calc(15px * var(--fontScale));
      letter-spacing:.3px;
      box-shadow: 0 10px 18px var(--shadow);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      white-space:nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .token:active{ transform: translateY(1px); }
    .slot{
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.02);
      color: rgba(232,240,232,.55);
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      font-size: calc(15px * var(--fontScale));
      min-width: 92px;
      text-align:center;
      user-select:none;
    }
    .slot.filled{
      border-style:solid;
      border-color: rgba(124,192,138,.45);
      background: rgba(124,192,138,.08);
      color:#dff3e4;
    }

    .hintGlow{
      animation: breath var(--breath) ease-in-out infinite;
      box-shadow:
        0 0 0 1px rgba(215,179,90,.15),
        0 0 18px 6px rgba(215,179,90,.14),
        0 0 34px 10px rgba(215,179,90,.10);
      border-color: rgba(215,179,90,.60);
    }
    .bookGlow{
      animation: breath2 var(--breath) ease-in-out infinite;
      box-shadow:
        0 0 0 1px rgba(124,192,138,.18),
        0 0 18px 7px rgba(124,192,138,.18),
        0 0 36px 12px rgba(124,192,138,.12);
      border-color: rgba(124,192,138,.65) !important;
    }
    @keyframes breath{
      0%{ filter:brightness(1); transform: translateY(0); }
      50%{ filter:brightness(1.08); transform: translateY(-1px); }
      100%{ filter:brightness(1); transform: translateY(0); }
    }
    @keyframes breath2{
      0%{ filter:brightness(1); transform: translateY(0); }
      50%{ filter:brightness(1.10); transform: translateY(-1px); }
      100%{ filter:brightness(1); transform: translateY(0); }
    }

    /* ===== Chapter overview & chapter home ===== */
    .screen{
      flex:1;
      min-height:0;
      display:none;
      flex-direction:column;
      gap:10px;
    }
    .screen.active{ display:flex; }

    .list{
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(20,27,20,.78), rgba(16,22,16,.62));
      box-shadow: 0 14px 26px var(--shadow);
      overflow:hidden;
    }
    .listHead{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(42,58,42,.9);
      color:var(--muted);
      font-weight:900;
      letter-spacing:.4px;
      font-size: calc(13px * var(--fontScale));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .listBody{
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .chapRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border:1px solid rgba(255,255,255,.07);
      border-radius:14px;
      background: rgba(255,255,255,.02);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .chapRow:active{ transform: translateY(1px); }
    .chapLeft{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .chapMain{
      font-weight:950;
      font-size: calc(14px * var(--fontScale));
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chapSub{
      color:var(--muted);
      font-size: calc(12px * var(--fontScale));
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chapRight{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .miniPill{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(215,179,90,.35);
      background: rgba(215,179,90,.08);
      color:#f1e1b4;
      font-size: calc(12px * var(--fontScale));
      font-weight:900;
      white-space:nowrap;
    }
    .miniPill.gray{
      border-color: rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }

    .homeCard{
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(20,27,20,.78), rgba(16,22,16,.62));
      box-shadow: 0 14px 26px var(--shadow);
      padding:12px;
    }
    .homeTop{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .homeH{
      font-weight:1000;
      font-size: calc(16px * var(--fontScale));
      letter-spacing:.4px;
    }
    .homeQuote{
      border:1px solid rgba(215,179,90,.18);
      background: rgba(215,179,90,.06);
      border-radius:14px;
      padding:10px 10px;
      color:#f1e1b4;
      font-weight:900;
      line-height:1.25;
      font-size: calc(14px * var(--fontScale));
      margin:8px 0 10px;
    }
    .homeActions{
      display:flex;
      gap:10px;
    }
    .homeActions .btn{ flex:1; }

    /* ===== Modals ===== */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:12px;
      background: rgba(0,0,0,.72);
      z-index:100;
    }
    .modal.show{ display:flex; }
    .modalBox{
      width:min(720px, 100%);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(20,27,20,.96), rgba(10,14,10,.92));
      box-shadow: 0 18px 38px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalTitle{
      font-weight:1000;
      letter-spacing:.4px;
      font-size: calc(14px * var(--fontScale));
      color:var(--text);
    }
    .xBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      font-size: calc(13px * var(--fontScale));
      font-weight:1000;
      -webkit-tap-highlight-color: transparent;
    }
    .xBtn:active{ transform: translateY(1px); }
    .modalBody{
      padding:12px;
      color:var(--text);
      font-size: calc(14px * var(--fontScale));
      line-height:1.5;
    }
    .modalFoot{
      padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    /* ===== Settings ===== */
    .field{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px;
      margin:10px 0;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .label{
      font-weight:950;
      color:var(--text);
      font-size: calc(13px * var(--fontScale));
    }
    .desc{
      color:var(--muted);
      font-size: calc(12px * var(--fontScale));
      margin-top:4px;
      line-height:1.35;
    }
    .toggle{
      width:46px;height:26px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      position:relative;
      flex:0 0 auto;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .toggle::after{
      content:"";
      position:absolute;top:3px;left:3px;
      width:20px;height:20px;border-radius:999px;
      background: rgba(255,255,255,.85);
      transition:.18s;
      box-shadow: 0 8px 14px rgba(0,0,0,.35);
    }
    .toggle.on{
      border-color: rgba(124,192,138,.55);
      background: rgba(124,192,138,.12);
    }
    .toggle.on::after{ left:23px; background:#e7fff0; }

    input[type="range"]{
      width:100%;
      accent-color: var(--accent2);
    }
    .dangerZone{
      border-color: rgba(211,107,107,.35);
      background: rgba(211,107,107,.06);
    }

    /* ===== Selects (quiz range) ===== */
    select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-weight:900;
      font-size: calc(13px * var(--fontScale));
      outline:none;
    }
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    /* ===== Small helper ===== */
    .muted{ color:var(--muted); }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin:10px 0; }
  </style>
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="titleWrap">
      <div class="titleLine">
        <div class="bookTitle">孫子兵法</div>
        <div class="chapTitle" id="topChap">篇章總覽</div>
        <div class="rankPill" id="topRank">—</div>
      </div>
      <div class="subline" id="topSub">依原書順序｜可自由進入篇章</div>
    </div>

    <div class="topActions">
      <button class="iconBtn" id="btnOverview" onclick="goOverview()">總覽</button>
      <button class="iconBtn" onclick="openSettings()">設定</button>
    </div>
  </div>

  <div class="wrap">
    <!-- SCREEN: Overview -->
    <div class="screen active" id="screenOverview">
      <div class="list">
        <div class="listHead">
          <div>篇章總覽（原書順序）</div>
          <div class="muted" style="font-weight:900;font-size:calc(12px*var(--fontScale));">點選進入</div>
        </div>
        <div class="listBody" id="chapList"></div>
      </div>
    </div>

    <!-- SCREEN: Chapter Home -->
    <div class="screen" id="screenHome">
      <div class="homeCard">
        <div class="homeTop">
          <div class="homeH" id="homeTitle">第一篇 始計篇</div>
          <div class="miniPill" id="homeRank">【伍卒】</div>
        </div>
        <div class="muted" id="homeSub">先站一下，調整呼吸，再入局。</div>

        <div class="homeQuote" id="homeQuote">「兵者，國之大事也。」</div>

        <div class="homeActions">
          <button class="btn btnGold" onclick="startDrill('default')">開始佈令</button>
          <button class="btn" id="btnResume" style="display:none" onclick="startDrill('resume')">從上次進度開始</button>
        </div>

        <div class="hr"></div>

        <button class="btn" id="btnChooseSeg" style="width:100%;display:none" onclick="openChooseSegment()">
          選擇段落
        </button>

        <div class="desc" id="homeHint" style="margin-top:8px;"></div>
      </div>
    </div>

    <!-- SCREEN: Drill -->
    <div class="screen" id="screenDrill">
      <div class="npcRow">
        <div class="npcCard">
          <div class="avatar">孫武</div>
          <div class="npcText" id="npcText"></div>
        </div>

        <div class="sideBtns">
          <button class="btn btnDanger" id="btnRetreat" onclick="undoToken()">退令</button>
          <button class="btn btnPrimary" id="btnVerify" onclick="verifyOrder()">驗令</button>
          <button class="btn" id="btnReset" onclick="resetThisRound()">重整</button>
        </div>
      </div>

      <div class="boards">
        <div class="board big">
          <div class="boardHead">
            <div class="boardTitle">佈令板</div>
            <div class="mini">
              <div class="segPill" id="segPill">第<strong>1</strong>段 / 共<strong>1</strong>段</div>
              <button class="btn btnGold" id="btnBook" style="padding:8px 10px; border-radius:12px; display:none;" onclick="openBook()">
                兵書
              </button>
            </div>
          </div>
          <div class="boardBody" id="target"></div>
        </div>

        <div class="board small">
          <div class="boardHead">
            <div class="boardTitle">令牌區</div>
            <div class="mini">
              <div class="segPill" id="hintPill">學習提示：<strong id="hintState">開</strong></div>
              <button class="btn" id="btnQuiz" style="padding:8px 10px; border-radius:12px; display:none;" onclick="openQuiz()">
                測驗
              </button>
            </div>
          </div>
          <div class="boardBody" id="source"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Settings -->
  <div class="modal" id="modalSettings">
    <div class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">設定</div>
        <button class="xBtn" onclick="closeSettings()">關閉</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <div class="row">
            <div>
              <div class="label">學習提示</div>
              <div class="desc">預設開啟｜會用呼吸燈提示下一枚令牌</div>
            </div>
            <div class="toggle on" id="tgHint" onclick="toggleSetting('hint')"></div>
          </div>
        </div>

        <div class="field">
          <div class="row">
            <div>
              <div class="label">音效</div>
              <div class="desc">可關閉｜點令牌、通過、失敗的提示音</div>
            </div>
            <div class="toggle on" id="tgSound" onclick="toggleSetting('sound')"></div>
          </div>
        </div>

        <div class="field">
          <div class="label">字體大小</div>
          <div class="desc">拖曳滑桿調整（手機更舒服）</div>
          <div style="margin-top:8px;">
            <input type="range" id="fontSlider" min="0.9" max="1.2" step="0.02" value="1.00" />
            <div class="desc">目前：<span id="fontVal">100%</span></div>
          </div>
        </div>

        <div class="field dangerZone">
          <div class="label">學習紀錄</div>
          <div class="desc">清除所有篇章的足跡與階級（不影響你的設定）</div>
          <button class="btn btnDanger" style="width:100%; margin-top:10px;" onclick="openClearConfirm()">清空足跡紀錄</button>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn" onclick="closeSettings()">好了</button>
      </div>
    </div>
  </div>

  <!-- Modal: Book -->
  <div class="modal" id="modalBook">
    <div class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">兵書（白話）</div>
        <button class="xBtn" onclick="closeBook()">關閉</button>
      </div>
      <div class="modalBody" id="bookBody"></div>
      <div class="modalFoot">
        <button class="btn btnGold" onclick="closeBook()">收兵書</button>
      </div>
    </div>
  </div>

  <!-- Modal: NPC full -->
  <div class="modal" id="modalNpc">
    <div class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">孫武</div>
        <button class="xBtn" onclick="closeNpcFull()">關閉</button>
      </div>
      <div class="modalBody" id="npcFullBody"></div>
      <div class="modalFoot">
        <button class="btn" onclick="closeNpcFull()">懂了</button>
      </div>
    </div>
  </div>

  <!-- Modal: Choose Segment (chapter home) -->
  <div class="modal" id="modalChooseSeg">
    <div class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">選擇段落（從第幾段開始）</div>
        <button class="xBtn" onclick="closeChooseSegment()">關閉</button>
      </div>
      <div class="modalBody" id="chooseSegBody"></div>
      <div class="modalFoot">
        <button class="btn btnGold" onclick="applyChooseSegment()">開始佈令</button>
      </div>
    </div>
  </div>

  <!-- Modal: Quiz -->
  <div class="modal" id="modalQuiz">
    <div class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">測驗（自選範圍）</div>
        <button class="xBtn" onclick="closeQuiz()">關閉</button>
      </div>
      <div class="modalBody" id="quizBody"></div>
      <div class="modalFoot">
        <button class="btn" onclick="closeQuiz()">先不測</button>
        <button class="btn btnPrimary" onclick="startQuizNow()">開始測驗</button>
      </div>
    </div>
  </div>

  <!-- Modal: Fail -->
  <div class="modal" id="modalFail">
    <div class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">陣勢未穩</div>
        <button class="xBtn" onclick="closeFail()">關閉</button>
      </div>
      <div class="modalBody" id="failBody"></div>
      <div class="modalFoot">
        <button class="btn" onclick="restLater()">先休息，之後再來</button>
        <button class="btn btnGold" onclick="retryAfterFail()">重來一輪</button>
      </div>
    </div>
  </div>

  <!-- Modal: Clear Confirm -->
  <div class="modal" id="modalClear">
    <div class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">清空足跡紀錄</div>
        <button class="xBtn" onclick="closeClearConfirm()">關閉</button>
      </div>
      <div class="modalBody">
        這會清除所有篇章的學習足跡與階級，但不影響你的設定。<br><br>
        確定要重新開始嗎？
      </div>
      <div class="modalFoot">
        <button class="btn" onclick="closeClearConfirm()">取消</button>
        <button class="btn btnDanger" onclick="clearAllFootprints()">清空並重新開始</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   v1 Demo Data (始計篇)
   ========================= */
const BOOK_ORDER = [
  { id:"c1", no:1, name:"始計篇" },
  { id:"c2", no:2, name:"作戰篇" },
  { id:"c3", no:3, name:"謀攻篇" },
  { id:"c4", no:4, name:"形篇" },
  { id:"c5", no:5, name:"勢篇" },
  { id:"c6", no:6, name:"虛實篇" },
  { id:"c7", no:7, name:"軍爭篇" },
  { id:"c8", no:8, name:"九變篇" },
  { id:"c9", no:9, name:"行軍篇" },
  { id:"c10", no:10, name:"地形篇" },
  { id:"c11", no:11, name:"九地篇" },
  { id:"c12", no:12, name:"火攻篇" },
  { id:"c13", no:13, name:"用間篇" },
];

/* Demo: 只做始計篇前 4 段（可擴充） */
const CHAPTER_TEXT = {
  c1: {
    segments: [
      {
        tokens:["兵者","國之大事","死生之地","存亡之道","不可不察也"],
        plain:"【白話】戰爭是國家的大事，牽動生死與存亡，絕對不可不審慎考察。",
        quote:"兵者，國之大事也。"
      },
      {
        tokens:["故","經之以五事","校之以計","而索其情"],
        plain:"【白話】所以要從五個面向衡量，再用計算比較，才能推知勝負的情勢。",
        quote:"故經之以五事。"
      },
      {
        tokens:["一曰道","二曰天","三曰地","四曰將","五曰法"],
        plain:"【白話】五事：道、天、地、將、法。抓住這五個骨架，才算站在兵法門口。",
        quote:"一曰道，二曰天。"
      },
      {
        tokens:["將者","智","信","仁","勇","嚴也"],
        plain:"【白話】將領要具備：智慧、誠信、仁愛、勇敢、嚴明。",
        quote:"將者，智信仁勇嚴也。"
      }
    ]
  }
};

/* =========================
   Storage & Settings
   ========================= */
const STORAGE_KEY = "sunzi_v1_state";
const DEFAULT_STATE = {
  settings: {
    hint: true,
    sound: true,
    fontScale: 1.00,
    breath: 2.8
  },
  // footprints per chapter
  footprints: {
    // c1: { unlocked: 1, lastSeg: 1, rank: "伍卒", visitedSegs: [1], quizSeen:false }
  }
};

let state = loadState();

/* =========================
   UI refs
   ========================= */
const screenOverview = document.getElementById("screenOverview");
const screenHome = document.getElementById("screenHome");
const screenDrill = document.getElementById("screenDrill");

const chapList = document.getElementById("chapList");
const topChap = document.getElementById("topChap");
const topRank = document.getElementById("topRank");
const topSub = document.getElementById("topSub");

const homeTitle = document.getElementById("homeTitle");
const homeRank = document.getElementById("homeRank");
const homeQuote = document.getElementById("homeQuote");
const homeHint = document.getElementById("homeHint");
const btnResume = document.getElementById("btnResume");
const btnChooseSeg = document.getElementById("btnChooseSeg");

const npcText = document.getElementById("npcText");
const npcFullBody = document.getElementById("npcFullBody");

const target = document.getElementById("target");
const source = document.getElementById("source");
const segPill = document.getElementById("segPill");
const hintState = document.getElementById("hintState");
const hintPill = document.getElementById("hintPill");

const btnVerify = document.getElementById("btnVerify");
const btnRetreat = document.getElementById("btnRetreat");
const btnReset = document.getElementById("btnReset");
const btnBook = document.getElementById("btnBook");
const btnQuiz = document.getElementById("btnQuiz");

const modalSettings = document.getElementById("modalSettings");
const modalBook = document.getElementById("modalBook");
const bookBody = document.getElementById("bookBody");
const modalNpc = document.getElementById("modalNpc");
const modalChooseSeg = document.getElementById("modalChooseSeg");
const chooseSegBody = document.getElementById("chooseSegBody");
const modalQuiz = document.getElementById("modalQuiz");
const quizBody = document.getElementById("quizBody");
const modalFail = document.getElementById("modalFail");
const failBody = document.getElementById("failBody");
const modalClear = document.getElementById("modalClear");

const tgHint = document.getElementById("tgHint");
const tgSound = document.getElementById("tgSound");
const fontSlider = document.getElementById("fontSlider");
const fontVal = document.getElementById("fontVal");

/* =========================
   Runtime drill vars
   ========================= */
let currentChapterId = null;      // e.g. "c1"
let currentSegIndex = 0;          // 0-based in chapter segments
let selection = [];               // chosen tokens in order
let pool = [];                    // remaining tokens
let lastNpcLong = "";             // full npc line

let quizMode = false;
let quizRange = { start: 1, end: 1 }; // 1-based seg numbers
let quizSegIndex = 0;             // within quiz range
let quizCorrectStreak = 0;

/* =========================
   Init
   ========================= */
applySettingsToRoot();
renderOverview();

/* =========================
   Navigation
   ========================= */
function setScreen(which){
  [screenOverview, screenHome, screenDrill].forEach(s => s.classList.remove("active"));
  which.classList.add("active");
}

function goOverview(){
  closeAllModals();
  setScreen(screenOverview);
  topChap.textContent = "篇章總覽";
  topRank.textContent = "—";
  topSub.textContent = "依原書順序｜可自由進入篇章";
  renderOverview();
}

function openChapterHome(chId){
  closeAllModals();
  currentChapterId = chId;
  const chap = BOOK_ORDER.find(x=>x.id===chId);
  const fp = getFootprint(chId);

  setScreen(screenHome);
  topChap.textContent = `第${chap.no}篇 ${chap.name}`;
  topRank.textContent = fp.rank ? `【${fp.rank}】` : "—";
  topSub.textContent = "先站一下，調整呼吸，再入局。";

  homeTitle.textContent = `第${chap.no}篇 ${chap.name}`;
  homeRank.textContent = fp.rank ? `【${fp.rank}】` : "【未入】";

  // Quote: 用第一段的第一句當引
  const segs = getChapterSegments(chId);
  homeQuote.textContent = `「${segs?.[0]?.quote || "兵者，國之大事也。"}」`;

  // Resume/Choose visibility
  const hasProgress = fp.unlocked > 1 || fp.lastSeg > 1 || (fp.visitedSegs && fp.visitedSegs.length>0);
  btnResume.style.display = hasProgress ? "inline-block" : "none";
  btnChooseSeg.style.display = (getChapterSegments(chId).length > 1) ? "inline-block" : "none";

  // Home hint text (低調)
  const maxSeg = getChapterSegments(chId).length;
  const unlocked = Math.min(fp.unlocked || 1, maxSeg);
  const lastSeg = Math.min(fp.lastSeg || 1, maxSeg);

  homeHint.textContent = hasProgress
    ? `你在本篇已走到：第${lastSeg}段（目前可練到第${unlocked}段）。`
    : `本篇共 ${maxSeg} 段（Demo）。按「開始佈令」直接從第1段進場。`;
}

function startDrill(mode){
  const segs = getChapterSegments(currentChapterId);
  if (!segs || segs.length===0){
    alert("此篇章 Demo 尚未收錄。");
    return;
  }
  const fp = getFootprint(currentChapterId);

  quizMode = false;
  btnQuiz.style.display = "none";
  btnBook.style.display = "none";
  btnBook.classList.remove("bookGlow");

  // 規則：預設從第1段開始；resume 從上次段落；choose 由 chooseSeg modal 設
  if (mode === "default"){
    currentSegIndex = 0;
  } else if (mode === "resume"){
    currentSegIndex = clamp((fp.lastSeg || 1) - 1, 0, segs.length-1);
  } else if (mode === "choose"){
    // currentSegIndex 已由 applyChooseSegment 設定
  }

  // 規則：即使從中段開始，前段不算已完成；只更新 lastSeg / visitedSegs
  setScreen(screenDrill);
  updateTopbarForDrill();
  loadSegment(currentSegIndex);
}

function updateTopbarForDrill(){
  const chap = BOOK_ORDER.find(x=>x.id===currentChapterId);
  const fp = getFootprint(currentChapterId);
  topChap.textContent = `第${chap.no}篇 ${chap.name}`;
  topRank.textContent = fp.rank ? `【${fp.rank}】` : "—";
  topSub.textContent = "佈令 → 驗令 → 兵書（可選）→ 下一段";
}

/* =========================
   Overview render
   ========================= */
function renderOverview(){
  chapList.innerHTML = "";
  BOOK_ORDER.forEach(ch=>{
    const fp = getFootprint(ch.id);
    const row = document.createElement("div");
    row.className = "chapRow";
    row.onclick = ()=> openChapterHome(ch.id);

    const left = document.createElement("div");
    left.className = "chapLeft";

    const main = document.createElement("div");
    main.className = "chapMain";
    main.textContent = `第${ch.no}篇　${ch.name}`;

    const sub = document.createElement("div");
    sub.className = "chapSub";

    // Demo only notice
    if (!CHAPTER_TEXT[ch.id]) sub.textContent = "（Demo 未收錄）";
    else{
      const maxSeg = getChapterSegments(ch.id).length;
      const unlocked = Math.min(fp.unlocked||1, maxSeg);
      sub.textContent = `可練到第${unlocked}段｜本篇共${maxSeg}段（Demo）`;
    }

    left.appendChild(main);
    left.appendChild(sub);

    const right = document.createElement("div");
    right.className = "chapRight";

    const pill = document.createElement("div");
    if (!CHAPTER_TEXT[ch.id]){
      pill.className = "miniPill gray";
      pill.textContent = "未入";
    } else if (!fp.rank){
      pill.className = "miniPill gray";
      pill.textContent = "未入";
    } else {
      pill.className = "miniPill";
      pill.textContent = fp.rank;
    }

    right.appendChild(pill);
    row.appendChild(left);
    row.appendChild(right);

    chapList.appendChild(row);
  });
}

/* =========================
   Segments / Drill
   ========================= */
function getChapterSegments(chId){
  return CHAPTER_TEXT[chId]?.segments || null;
}

function loadSegment(segIdx){
  const segs = getChapterSegments(currentChapterId);
  const fp = getFootprint(currentChapterId);

  // ensure unlocked at least this segment
  if (segIdx + 1 > (fp.unlocked || 1)){
    // allow only unlocked
    segIdx = (fp.unlocked || 1) - 1;
    currentSegIndex = segIdx;
  }

  selection = [];
  pool = [...segs[segIdx].tokens].slice().sort(()=>Math.random()-0.5);

  // ui
  updateSegPill();
  renderBoards();
  updateHintUI();
  setNpcLine("start");

  btnVerify.classList.remove("btnGold");
  btnVerify.classList.add("btnPrimary");

  btnBook.style.display = "none";
  btnBook.classList.remove("bookGlow");
}

function updateSegPill(){
  const segs = getChapterSegments(currentChapterId);
  const fp = getFootprint(currentChapterId);
  const maxSeg = segs.length;
  const cur = currentSegIndex + 1;
  segPill.innerHTML = `第<strong>${cur}</strong>段 / 共<strong>${maxSeg}</strong>段`;
}

function renderBoards(){
  // target slots
  target.innerHTML = "";
  const segs = getChapterSegments(currentChapterId);
  const needed = segs[currentSegIndex].tokens.length;

  for (let i=0;i<needed;i++){
    const slot = document.createElement("div");
    if (selection[i]){
      slot.className = "slot filled";
      slot.textContent = selection[i];
      slot.onclick = ()=> { // tap to return
        returnTokenAt(i);
      };
    } else {
      slot.className = "slot";
      slot.textContent = "—";
    }
    target.appendChild(slot);
  }

  // source tokens
  source.innerHTML = "";
  pool.forEach(t=>{
    const token = document.createElement("div");
    token.className = "token";
    token.textContent = t;
    token.onclick = ()=> pickToken(t);
    source.appendChild(token);
  });

  // enable/disable verify based on filled
  const filled = selection.length === needed;
  btnVerify.disabled = !filled;
  btnVerify.style.opacity = filled ? "1" : ".55";
}

function pickToken(t){
  const segs = getChapterSegments(currentChapterId);
  const needed = segs[currentSegIndex].tokens.length;
  if (selection.length >= needed) return;

  playSfx("tap");
  selection.push(t);
  pool.splice(pool.indexOf(t),1);
  renderBoards();
  updateHintUI();
}

function returnTokenAt(idx){
  const t = selection[idx];
  if (!t) return;
  playSfx("tap");
  selection.splice(idx,1);
  pool.push(t);
  renderBoards();
  updateHintUI();
}

function undoToken(){
  if (selection.length===0) return;
  playSfx("tap");
  const t = selection.pop();
  pool.push(t);
  renderBoards();
  updateHintUI();
}

function resetThisRound(){
  playSfx("tap");
  loadSegment(currentSegIndex);
}

function updateHintUI(){
  hintState.textContent = state.settings.hint ? "開" : "關";
  if (state.settings.hint){
    hintPill.style.borderColor = "rgba(215,179,90,.45)";
    hintPill.style.background = "rgba(215,179,90,.08)";
    hintPill.style.color = "#f1e1b4";
  } else {
    hintPill.style.borderColor = "rgba(255,255,255,.12)";
    hintPill.style.background = "rgba(255,255,255,.03)";
    hintPill.style.color = "var(--muted)";
  }

  // glow next correct token
  [...source.children].forEach(el=> el.classList.remove("hintGlow"));
  if (!state.settings.hint) return;

  const segs = getChapterSegments(currentChapterId);
  const correct = segs[currentSegIndex].tokens;
  const nextNeed = correct[selection.length];
  if (!nextNeed) return;

  for (const el of source.children){
    if (el.textContent === nextNeed){
      el.classList.add("hintGlow");
      break;
    }
  }
}

function verifyOrder(){
  const segs = getChapterSegments(currentChapterId);
  const correct = segs[currentSegIndex].tokens;

  if (selection.length !== correct.length) return;

  const ok = selection.every((t,i)=>t===correct[i]);
  if (ok){
    playSfx("pass");
    onPassSegment();
  } else {
    playSfx("fail");
    onFailSegment();
  }
}

function onPassSegment(){
  const fp = getFootprint(currentChapterId);
  const segNo = currentSegIndex + 1;
  const segs = getChapterSegments(currentChapterId);

  // footprints update: visited segs add
  fp.visitedSegs = fp.visitedSegs || [];
  if (!fp.visitedSegs.includes(segNo)) fp.visitedSegs.push(segNo);

  // lastSeg update to current
  fp.lastSeg = Math.max(fp.lastSeg || 1, segNo);

  // unlock next (but only within demo max)
  const maxSeg = segs.length;
  fp.unlocked = clamp(Math.max(fp.unlocked || 1, segNo + 1), 1, maxSeg);

  // rank update (low pressure): based on visited count
  fp.rank = computeRank(fp, maxSeg);

  saveState();

  // NPC gentle praise + surprise-ish
  const line = pickNpcPraise(fp);
  setNpcLine("custom", line);

  // Show book button with stronger glow
  btnBook.style.display = "inline-block";
  btnBook.classList.add("bookGlow");

  // show quiz button once at least 2 segments visited/unlocked
  if ((fp.unlocked || 1) >= 2){
    btnQuiz.style.display = "inline-block";
  }

  // lock interactions by disabling tokens? keep simple: allow next segment button via book modal or after short
  // We'll auto-advance only AFTER user closes book OR taps "下一段" by using "兵書" then close triggers next suggestion.
}

function onFailSegment(){
  const msg = pickNpcFail();
  // show fail modal with option
  failBody.innerHTML = `
    <div style="font-weight:1000; margin-bottom:8px;">孫武：</div>
    <div style="color:var(--text);">${escapeHtml(msg)}</div>
    <div class="hr"></div>
    <div class="muted">要不要自己按下「重來一輪」？那一刻，是你在選擇繼續，不是被推回去。</div>
  `;
  modalFail.classList.add("show");
}

/* =========================
   Book (plain explanation)
   ========================= */
function openBook(){
  const segs = getChapterSegments(currentChapterId);
  const seg = segs[currentSegIndex];

  const correctLine = seg.tokens.join("、");
  bookBody.innerHTML = `
    <div style="font-weight:1000; color:#f1e1b4;">原文（本段）</div>
    <div style="margin-top:6px; padding:10px; border:1px solid rgba(215,179,90,.18); background:rgba(215,179,90,.06); border-radius:14px; font-weight:900;">
      ${escapeHtml(correctLine)}
    </div>
    <div style="height:10px;"></div>
    <div style="font-weight:1000; color:#dff3e4;">白話</div>
    <div style="margin-top:6px; padding:10px; border:1px solid rgba(124,192,138,.18); background:rgba(124,192,138,.06); border-radius:14px;">
      ${escapeHtml(seg.plain)}
    </div>
    <div class="hr"></div>
    <div class="muted">關掉兵書後，我會讓你自己決定：下一段，或先休息。</div>
  `;
  modalBook.classList.add("show");
}

function closeBook(){
  modalBook.classList.remove("show");
  // after closing, offer next step gently in npc
  const fp = getFootprint(currentChapterId);
  const segs = getChapterSegments(currentChapterId);
  const cur = currentSegIndex + 1;
  const canGoNext = (cur < (fp.unlocked || 1)) && (cur < segs.length);

  if (canGoNext){
    setNpcLine("custom", "兵書看過就好。要不要進下一段？你自己決定。");
    // move to next segment automatically? 依你的理念：不自動跳，讓他決定
    // 這裡用「驗令」改成「下一段」會更擠；所以我採用：點一下佈令板空白處即可進下一段會太隱藏
    // v1：給一個不吵的小提示：雙擊「重整」可前進？不好
    // 最簡：在 NPC 長文裡提示：按「重整」=重來；按「總覽」=離開；要下一段就直接再按一次「驗令」? 不合理
    // v1 改成：顯示「測驗」旁再出現「下一段」按鈕會擠
    // v1 解法：把「重整」在通過後自動變成「下一段」
    btnReset.textContent = "下一段";
    btnReset.classList.add("btnGold");
    btnReset.onclick = ()=> nextSegment();
  } else {
    // no next (demo end or not unlocked)
    btnReset.textContent = "重整";
    btnReset.classList.remove("btnGold");
    btnReset.onclick = ()=> resetThisRound();

    if (cur >= segs.length){
      setNpcLine("custom", "這一篇（Demo）到這裡。你已經做得很穩了。要不要回總覽換一篇走走？");
      btnQuiz.style.display = "inline-block";
    }
  }
}

function nextSegment(){
  // restore reset button behavior
  btnReset.textContent = "重整";
  btnReset.classList.remove("btnGold");
  btnReset.onclick = ()=> resetThisRound();

  const fp = getFootprint(currentChapterId);
  const segs = getChapterSegments(currentChapterId);
  const next = currentSegIndex + 1;
  if (next >= segs.length) return;

  // only if unlocked allows
  if (next + 1 <= (fp.unlocked || 1)){
    currentSegIndex = next;
    loadSegment(currentSegIndex);
  } else {
    // should not happen
    loadSegment(currentSegIndex);
  }
}

/* =========================
   Quiz (Range select: start/end)
   Rules:
   - Each time open quiz: default to system preset:
     start=1, end=unlocked-1 (已通過段落) 或 end=unlocked (若想)
   - User can change within modal; closing resets.
   ========================= */
function openQuiz(){
  const fp = getFootprint(currentChapterId);
  const segs = getChapterSegments(currentChapterId);
  const maxSeg = segs.length;

  const unlocked = clamp(fp.unlocked || 1, 1, maxSeg);
  // 預設：從第1段到「目前已解鎖的上一段」（也就是已走過的範圍），至少 1
  const defaultEnd = clamp((unlocked - 1), 1, maxSeg);

  quizRange = { start: 1, end: defaultEnd };
  quizSegIndex = 0;
  quizCorrectStreak = 0;

  const options = [];
  for (let i=1;i<=defaultEnd;i++){
    options.push(`<option value="${i}">第${i}段</option>`);
  }

  quizBody.innerHTML = `
    <div class="muted">每次進來都回到系統預設範圍（比較安心）。你也可以臨時改一下。</div>
    <div style="height:10px;"></div>
    <div class="grid2">
      <div>
        <div class="label" style="margin-bottom:6px;">開始</div>
        <select id="quizStart">${options.join("")}</select>
      </div>
      <div>
        <div class="label" style="margin-bottom:6px;">結束</div>
        <select id="quizEnd">${options.map(o=>o.replace('value="1"','value="1"')).join("")}</select>
      </div>
    </div>
    <div class="desc" style="margin-top:8px;">提示：若你只想練最新一段，也可以把開始與結束都選同一段。</div>
  `;

  // set defaults
  setTimeout(()=>{
    const s = document.getElementById("quizStart");
    const e = document.getElementById("quizEnd");
    if (!s || !e) return;
    s.value = "1";
    e.value = String(defaultEnd);
  },0);

  modalQuiz.classList.add("show");
}

function closeQuiz(){
  modalQuiz.classList.remove("show");
  // reset to preset next time by design
}

function startQuizNow(){
  const s = document.getElementById("quizStart");
  const e = document.getElementById("quizEnd");
  if (!s || !e) return;

  let start = Number(s.value);
  let end = Number(e.value);
  if (end < start){ [start,end] = [end,start]; }

  quizRange = { start, end };
  quizSegIndex = 0;
  quizCorrectStreak = 0;
  quizMode = true;

  modalQuiz.classList.remove("show");
  setNpcLine("custom", "測驗開始。別急，先把順序走穩。");

  // jump to first seg in range
  currentSegIndex = (quizRange.start - 1);
  loadSegment(currentSegIndex);
}

function onPassSegmentInQuiz(){
  // if pass in quiz mode: advance within range until end
  const curSegNo = currentSegIndex + 1;
  if (curSegNo >= quizRange.end){
    quizMode = false;
    playSfx("pass");

    // reward gentle line
    const fp = getFootprint(currentChapterId);
    const line = (Math.random() < 0.5)
      ? "好。你不是在拼速度，你是在把順序種進腦子裡。"
      : "這一輪走得很穩。你會越來越省力。";
    setNpcLine("custom", line);

    // back to lastSeg (resume point)
    const last = clamp((fp.lastSeg || 1) - 1, 0, getChapterSegments(currentChapterId).length-1);
    currentSegIndex = last;
    loadSegment(currentSegIndex);

    return;
  }

  // next within quiz
  quizCorrectStreak++;
  currentSegIndex = curSegNo; // already 1-based, so next index = curSegNo
  loadSegment(currentSegIndex);
}

/* Hook pass for quiz mode */
const _onPassSegment = onPassSegment;
onPassSegment = function(){
  // call original pass updates
  const beforeQuiz = quizMode;

  // do normal pass
  const fp = getFootprint(currentChapterId);
  const segNo = currentSegIndex + 1;
  const segs = getChapterSegments(currentChapterId);

  fp.visitedSegs = fp.visitedSegs || [];
  if (!fp.visitedSegs.includes(segNo)) fp.visitedSegs.push(segNo);
  fp.lastSeg = Math.max(fp.lastSeg || 1, segNo);
  fp.unlocked = clamp(Math.max(fp.unlocked || 1, segNo + 1), 1, segs.length);
  fp.rank = computeRank(fp, segs.length);
  saveState();

  // show book + quiz avail
  const line = pickNpcPraise(fp);
  setNpcLine("custom", line);
  btnBook.style.display = "inline-block";
  btnBook.classList.add("bookGlow");
  if ((fp.unlocked || 1) >= 2) btnQuiz.style.display = "inline-block";

  if (beforeQuiz){
    // in quiz mode, we don't force book reading, keep flow
    btnBook.style.display = "none";
    btnBook.classList.remove("bookGlow");
    onPassSegmentInQuiz();
  }
};

/* =========================
   Chapter Home: choose start segment
   ========================= */
let chooseStartSeg = 1;

function openChooseSegment(){
  const fp = getFootprint(currentChapterId);
  const segs = getChapterSegments(currentChapterId);
  const maxSeg = segs.length;

  const unlocked = clamp(fp.unlocked || 1, 1, maxSeg);
  // 允許選到已解鎖的段落（含）
  const options = [];
  for (let i=1;i<=unlocked;i++){
    const preview = segs[i-1].tokens.join("、");
    options.push(`<option value="${i}">第${i}段｜${escapeHtml(preview)}</option>`);
  }

  chooseSegBody.innerHTML = `
    <div class="muted">你可以從已解鎖的段落開始。系統會記得你「在哪裡練」，但不會把前面段落當作已完成。</div>
    <div style="height:10px;"></div>
    <div class="label" style="margin-bottom:6px;">從這一段開始</div>
    <select id="chooseSegSel">${options.join("")}</select>
    <div class="desc" style="margin-top:8px;">你也可以隨時回首頁重新選。</div>
  `;

  setTimeout(()=>{
    const sel = document.getElementById("chooseSegSel");
    if (sel) sel.value = String(clamp((fp.lastSeg || 1), 1, unlocked));
  },0);

  modalChooseSeg.classList.add("show");
}

function closeChooseSegment(){
  modalChooseSeg.classList.remove("show");
}

function applyChooseSegment(){
  const sel = document.getElementById("chooseSegSel");
  if (!sel) return;
  chooseStartSeg = Number(sel.value);
  currentSegIndex = clamp(chooseStartSeg - 1, 0, getChapterSegments(currentChapterId).length-1);
  modalChooseSeg.classList.remove("show");
  startDrill("choose");
}

/* =========================
   Fail modal flow
   ========================= */
function closeFail(){ modalFail.classList.remove("show"); }
function retryAfterFail(){
  modalFail.classList.remove("show");
  // let user choose “重來” moment: we already did; now reset
  resetThisRound();
  setNpcLine("custom","就這樣。先把第一步走順，後面自然就會順。");
}
function restLater(){
  modalFail.classList.remove("show");
  // go back to chapter home without shaming
  openChapterHome(currentChapterId);
  // gentle one-liner
  topSub.textContent = "今天到這裡也行。兵法不急。";
}

/* =========================
   NPC lines
   ========================= */
function setNpcLine(type, customText){
  const fp = currentChapterId ? getFootprint(currentChapterId) : null;

  let shortLine = "";
  let fullLine = "";

  if (type === "start"){
    shortLine = state.settings.hint
      ? "看令牌的光，就知道下一步。先慢，不要急。"
      : "不靠提示也行。你先穩住節奏，順序自然就會出來。";
    fullLine = shortLine + "（你做的是背原文，不是做題目。）";
  } else if (type === "custom"){
    shortLine = customText || "好。";
    fullLine = customText || "好。";
  } else {
    shortLine = "先穩住。";
    fullLine = "先穩住。";
  }

  // compress: use “…（更多）”
  lastNpcLong = fullLine;
  npcText.innerHTML = `${escapeHtml(shortLine)} <span class="npcMore" onclick="openNpcFull()">…（更多）</span>`;

  // also allow tap on npc card? (not needed)
}

function openNpcFull(){
  npcFullBody.innerHTML = escapeHtml(lastNpcLong).replace(/\n/g,"<br>");
  modalNpc.classList.add("show");
}
function closeNpcFull(){ modalNpc.classList.remove("show"); }

function pickNpcPraise(fp){
  const lines = [
    "這一段，你已經走順了。記得：順序先穩，速度自然會來。",
    "好。你不是在硬背，你是在把它「放進隊形」。",
    "不錯。能把它走完的人，其實不多。",
    "你剛剛那一下很穩。繼續也好，先停也行——你自己決定。",
  ];
  // 小驚喜：偶爾更貼心一句（不罐頭）
  if (fp && (fp.visitedSegs||[]).length >= 2 && Math.random() < 0.25){
    return "你願意再走一輪，代表你沒有逃。這很難得。";
  }
  return lines[Math.floor(Math.random()*lines.length)];
}

function pickNpcFail(){
  const lines = [
    "這一輪有點急。先把呼吸放慢，再走一次就好。",
    "順序亂不等於你不行，只代表它還沒定下來。",
    "先別跟自己較勁。你只要願意重來，這局就沒輸。",
    "沒事。你現在做的，是把「隊形」排好，不是考試。",
  ];
  return lines[Math.floor(Math.random()*lines.length)];
}

/* =========================
   Rank rules (simple, low pressure)
   - per chapter, based on visited segments count and quiz attempts
   - "之前版本比較好"：用伍卒/什長/隊正/校尉/偏將
   ========================= */
function computeRank(fp, maxSeg){
  const v = (fp.visitedSegs || []).length;
  if (v <= 0) return null;
  if (v === 1) return "伍卒";
  if (v === 2) return "什長";
  if (v === 3) return "隊正";
  if (v >= 4) return "校尉";
  return "伍卒";
}

/* =========================
   Settings
   ========================= */
function openSettings(){
  // sync toggles
  tgHint.classList.toggle("on", !!state.settings.hint);
  tgSound.classList.toggle("on", !!state.settings.sound);
  fontSlider.value = String(state.settings.fontScale);
  fontVal.textContent = Math.round(state.settings.fontScale*100) + "%";
  modalSettings.classList.add("show");
}
function closeSettings(){
  modalSettings.classList.remove("show");
  // update hint UI if in drill
  updateHintUI();
}
function toggleSetting(which){
  if (which === "hint"){
    state.settings.hint = !state.settings.hint;
    tgHint.classList.toggle("on", !!state.settings.hint);
    saveState();
    applySettingsToRoot();
    updateHintUI();
    setNpcLine("start"); // refresh tone
  }
  if (which === "sound"){
    state.settings.sound = !state.settings.sound;
    tgSound.classList.toggle("on", !!state.settings.sound);
    saveState();
  }
}
fontSlider.addEventListener("input", ()=>{
  state.settings.fontScale = Number(fontSlider.value);
  fontVal.textContent = Math.round(state.settings.fontScale*100) + "%";
  applySettingsToRoot();
  saveState();
});

function applySettingsToRoot(){
  document.documentElement.style.setProperty("--fontScale", state.settings.fontScale.toFixed(2));
  document.documentElement.style.setProperty("--breath", (state.settings.breath || 2.8) + "s");
}

/* =========================
   Book / Modals helpers
   ========================= */
function closeAllModals(){
  [modalSettings, modalBook, modalNpc, modalChooseSeg, modalQuiz, modalFail, modalClear]
    .forEach(m=>m.classList.remove("show"));
}
function closeBook(){ /* overridden above */ }
function openBook(){ /* overridden above */ }

/* =========================
   Clear footprints
   ========================= */
function openClearConfirm(){ modalClear.classList.add("show"); }
function closeClearConfirm(){ modalClear.classList.remove("show"); }
function clearAllFootprints(){
  // keep settings
  const settings = state.settings;
  state = JSON.parse(JSON.stringify(DEFAULT_STATE));
  state.settings = settings;
  saveState();
  applySettingsToRoot();
  closeAllModals();
  goOverview();
}

/* =========================
   Persistence
   ========================= */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return JSON.parse(JSON.stringify(DEFAULT_STATE));
    const parsed = JSON.parse(raw);

    // merge defaults safely
    const merged = JSON.parse(JSON.stringify(DEFAULT_STATE));
    merged.settings = Object.assign(merged.settings, parsed.settings || {});
    merged.footprints = Object.assign({}, parsed.footprints || {});
    return merged;
  }catch(e){
    return JSON.parse(JSON.stringify(DEFAULT_STATE));
  }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  // update topbar rank if in chapter
  if (currentChapterId){
    const fp = getFootprint(currentChapterId);
    topRank.textContent = fp.rank ? `【${fp.rank}】` : "—";
    // sync home rank too
    homeRank.textContent = fp.rank ? `【${fp.rank}】` : "【未入】";
    document.getElementById("topRank").textContent = fp.rank ? `【${fp.rank}】` : "—";
  }
  renderOverview();
}

function getFootprint(chId){
  if (!state.footprints[chId]){
    state.footprints[chId] = { unlocked: 1, lastSeg: 1, rank: null, visitedSegs: [] };
  }
  return state.footprints[chId];
}

/* =========================
   Audio (simple, optional)
   ========================= */
let audioCtx = null;
function playSfx(type){
  if (!state.settings.sound) return;

  try{
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);

    const now = audioCtx.currentTime;
    let freq = 440, dur = 0.06, vol = 0.04;

    if (type === "tap"){ freq = 520; dur = 0.045; vol = 0.03; }
    if (type === "pass"){ freq = 660; dur = 0.10; vol = 0.05; }
    if (type === "fail"){ freq = 220; dur = 0.12; vol = 0.05; }

    o.type = "sine";
    o.frequency.setValueAtTime(freq, now);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(vol, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

    o.start(now);
    o.stop(now + dur + 0.02);
  }catch(e){}
}

/* =========================
   Utilities
   ========================= */
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   Small glue
   ========================= */
function openBook(){ /* already defined above */ }
function closeBook(){ /* already defined above */ }

/* initial NPC text for drill when enters (safe fallback) */
npcText.textContent = "點令牌佈令。先慢，不要急。";

/* In overview, clicking demo missing chapters should still open home but show alert if no data */
function openChapterHome(chId){
  closeAllModals();
  currentChapterId = chId;
  const chap = BOOK_ORDER.find(x=>x.id===chId);
  const fp = getFootprint(chId);

  setScreen(screenHome);
  topChap.textContent = `第${chap.no}篇 ${chap.name}`;
  topRank.textContent = fp.rank ? `【${fp.rank}】` : "—";
  topSub.textContent = "先站一下，調整呼吸，再入局。";

  homeTitle.textContent = `第${chap.no}篇 ${chap.name}`;
  homeRank.textContent = fp.rank ? `【${fp.rank}】` : "【未入】";

  const segs = getChapterSegments(chId);
  if (!segs){
    homeQuote.textContent = "「Demo 尚未收錄」";
    homeHint.textContent = "這一篇還沒放進 Demo。你可以先用「始計篇」驗證整體架構。";
    btnResume.style.display = "none";
    btnChooseSeg.style.display = "none";
    return;
  }

  homeQuote.textContent = `「${segs?.[0]?.quote || "兵者，國之大事也。"}」`;

  const hasProgress = fp.unlocked > 1 || fp.lastSeg > 1 || (fp.visitedSegs && fp.visitedSegs.length>0);
  btnResume.style.display = hasProgress ? "inline-block" : "none";
  btnChooseSeg.style.display = (segs.length > 1) ? "inline-block" : "none";

  const maxSeg = segs.length;
  const unlocked = Math.min(fp.unlocked || 1, maxSeg);
  const lastSeg = Math.min(fp.lastSeg || 1, maxSeg);

  homeHint.textContent = hasProgress
    ? `你在本篇已走到：第${lastSeg}段（目前可練到第${unlocked}段）。`
    : `本篇共 ${maxSeg} 段（Demo）。按「開始佈令」直接從第1段進場。`;
}

/* When entering drill, ensure buttons make sense */
function startDrill(mode){
  const segs = getChapterSegments(currentChapterId);
  if (!segs || segs.length===0){
    alert("此篇章 Demo 尚未收錄。");
    return;
  }
  const fp = getFootprint(currentChapterId);

  quizMode = false;
  btnQuiz.style.display = "none";
  btnBook.style.display = "none";
  btnBook.classList.remove("bookGlow");

  // restore reset button normal
  btnReset.textContent = "重整";
  btnReset.classList.remove("btnGold");
  btnReset.onclick = ()=> resetThisRound();

  if (mode === "default"){
    currentSegIndex = 0;
  } else if (mode === "resume"){
    currentSegIndex = clamp((fp.lastSeg || 1) - 1, 0, segs.length-1);
  } else if (mode === "choose"){
    // keep currentSegIndex
  }

  setScreen(screenDrill);
  updateTopbarForDrill();

  // set hint pill state
  updateHintUI();
  setNpcLine("start");

  loadSegment(currentSegIndex);
}

/* =============== */
</script>
</body>
</html>
