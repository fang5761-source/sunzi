<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å­«å­å…µæ³•ãƒ»ä½ˆä»¤æ¼”ç·´ v1.2</title>
  <style>
    :root{
      --bg:#0b0f0d;
      --panel:#111815;
      --panel2:#0f1412;
      --gold:#d6b36a;
      --gold2:#9a7b40;
      --line:rgba(214,179,106,.35);
      --muted:rgba(255,255,255,.65);
      --text:rgba(255,255,255,.92);
      --ok:#2fbf71;
      --warn:#d85c5c;
      --chip:#151f1a;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:20px;

      --fs-base: 16px; /* ç”±è¨­å®šæ»‘æ¡¿æ§åˆ¶ */
      --fs-small: calc(var(--fs-base) - 1px);
      --fs-large: calc(var(--fs-base) + 2px);

      --breathe: 2.8s; /* å‘¼å¸æ…¢ä¸€é» */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Microsoft JhengHei", "Noto Sans TC", sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(214,179,106,.10), transparent 60%),
                  radial-gradient(900px 700px at 80% 30%, rgba(47,191,113,.08), transparent 55%),
                  linear-gradient(180deg, #070a08, #0b0f0d);
      color:var(--text);
      overflow:hidden;
      font-size: var(--fs-base);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    /* å®‰å…¨å€ */
    .safeTop{height: env(safe-area-inset-top);}
    .safeBottom{height: env(safe-area-inset-bottom);}

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: 10px 12px 10px 12px;
      gap:10px;
    }

    /* é ‚éƒ¨ç‹€æ…‹åˆ—ï¼ˆæ›´æ‰ã€æ›´çœç©ºé–“ï¼‰ */
    .topbar{
      background: rgba(17,24,21,.75);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 10px 12px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height: 64px;
    }
    .top-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .rank{
      padding:8px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      color: var(--gold);
      font-weight: 800;
      letter-spacing: .08em;
      background: rgba(0,0,0,.18);
      flex: 0 0 auto;
    }
    .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .chapter{
      font-weight:800;
      color: rgba(255,255,255,.88);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .submeta{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: var(--fs-small);
      color: var(--muted);
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 10px rgba(47,191,113,.55);
      flex:0 0 auto;
    }
    .hint-pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      white-space:nowrap;
    }

    .top-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
    }
    .iconbtn{
      width:44px;height:44px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      color: rgba(255,255,255,.9);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position:relative;
    }
    .iconbtn:active{transform: scale(.98)}
    .icon{
      font-size:20px;
      opacity:.95;
    }

    /* å…µæ›¸å‘¼å¸ç‡ˆï¼ˆæ›´äº®ã€æ›´æ…¢ï¼‰ */
    .breath::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 16px;
      border:2px solid rgba(214,179,106,.65);
      filter: drop-shadow(0 0 10px rgba(214,179,106,.35));
      animation: breathe var(--breathe) ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes breathe{
      0%{opacity:.25; transform: scale(1);}
      50%{opacity:.95; transform: scale(1.02);}
      100%{opacity:.25; transform: scale(1);}
    }

    /* å­«æ­¦èªéŒ„ */
    .npc{
      background: rgba(17,24,21,.65);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px 14px;
      box-shadow: var(--shadow);
      display:flex;
      gap:12px;
      align-items:flex-start;
      min-height: 76px;
    }
    .npc-badge{
      width:52px;height:52px;
      border-radius: 16px;
      border:1px solid var(--line);
      color: var(--gold);
      display:grid;
      place-items:center;
      font-weight:900;
      letter-spacing:.12em;
      flex:0 0 auto;
      background: rgba(0,0,0,.18);
    }
    .npc-text{
      flex:1;
      line-height: 1.35;
      font-size: var(--fs-large);
      position:relative;
      padding-right: 8px;
      min-width:0;
    }
    .npc-text.fade{
      mask-image: linear-gradient(180deg, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 72%, rgba(0,0,0,0) 100%);
      -webkit-mask-image: linear-gradient(180deg, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 72%, rgba(0,0,0,0) 100%);
      max-height: calc(1.35em * 3);
      overflow:hidden;
    }
    .npc-more{
      margin-top:6px;
      font-size: var(--fs-small);
      color: rgba(214,179,106,.9);
      cursor:pointer;
      user-select:none;
      width: fit-content;
    }

    /* ä¸»èˆå° */
    .stage{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .board{
      background: rgba(15,20,18,.62);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 0;
    }

    .board-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .board-title{
      font-weight:900;
      color: var(--gold);
      letter-spacing:.08em;
    }
    .missing{
      font-weight:800;
      color: rgba(255,255,255,.75);
      font-size: var(--fs-small);
    }

    /* ä½ˆä»¤æ¿ï¼šå›ºå®šå…©åˆ—+ä¸æ»‘å‹• */
    .slots{
      border:1px dashed rgba(214,179,106,.35);
      border-radius: 18px;
      padding: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      min-height: 132px;
      background: rgba(0,0,0,.12);
    }

    /* ä»¤ç‰Œï¼šæ›´åƒè»ä»¤ç‰Œï¼Œä¸åƒç«¹ç°¡ */
    .token{
      border-radius: 18px;
      border:1px solid rgba(214,179,106,.35);
      background: linear-gradient(180deg, rgba(21,31,26,.92), rgba(12,18,15,.92));
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      padding: 14px 12px;
      text-align:center;
      font-weight:900;
      letter-spacing:.06em;
      color: rgba(255,255,255,.92);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      line-height:1.15;
      min-height: 56px;
      display:grid;
      place-items:center;
    }
    .token:active{transform: scale(.99)}
    .token.hint{
      border-color: rgba(214,179,106,.95);
      box-shadow: 0 0 0 2px rgba(214,179,106,.25), 0 0 18px rgba(214,179,106,.35);
      animation: glow var(--breathe) ease-in-out infinite;
    }
    @keyframes glow{
      0%{filter: brightness(1);}
      50%{filter: brightness(1.18);}
      100%{filter: brightness(1);}
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top: 2px;
    }
    .btn{
      flex:1;
      border:none;
      border-radius: 18px;
      padding: 14px 12px;
      font-weight:900;
      letter-spacing:.06em;
      color: rgba(255,255,255,.95);
      background: rgba(0,0,0,.22);
      border:1px solid rgba(214,179,106,.25);
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      font-size: var(--fs-base);
    }
    .btn:active{transform: scale(.99)}
    .btn.red{border-color: rgba(216,92,92,.55); background: rgba(216,92,92,.10)}
    .btn.green{border-color: rgba(47,191,113,.55); background: rgba(47,191,113,.10)}
    .btn.gold{border-color: rgba(214,179,106,.65); background: rgba(214,179,106,.10)}

    /* ä»¤ç‰Œå€ï¼šå›ºå®šå…©åˆ—æ ¼å­ + åˆ†é  */
    .pool{
      background: rgba(17,24,21,.58);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 0;
    }
    .pool-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size: var(--fs-small);
      color: rgba(255,255,255,.72);
    }
    .pager{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pbtn{
      width:42px;height:36px;
      border-radius: 14px;
      border:1px solid rgba(214,179,106,.25);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      display:grid;
      place-items:center;
      user-select:none;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pbtn:active{transform: scale(.99)}
    .pinfo{min-width:50px; text-align:right}

    .pool-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      min-height: 128px;
    }

    /* Toast */
    .toast{
      position: fixed;
      left:50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.68);
      border:1px solid rgba(214,179,106,.28);
      color: rgba(255,255,255,.92);
      padding: 10px 14px;
      border-radius: 999px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      font-weight:800;
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease;
      font-size: var(--fs-small);
    }
    .toast.show{opacity:1}

    /* Modalï¼ˆä¸é€æ˜èƒŒæ™¯ï¼Œè§£æ±ºå¦³èªªçš„ã€Œé€æ˜å¹²æ“¾ã€ï¼‰ */
    .modal{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.78);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      z-index: 50;
    }
    .modal.show{display:flex}
    .card{
      width: min(520px, 100%);
      border-radius: 22px;
      border:1px solid rgba(214,179,106,.35);
      background: rgba(15,20,18,.96);
      box-shadow: 0 24px 60px rgba(0,0,0,.55);
      padding: 14px 14px 16px;
      position:relative;
    }
    .card-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 4px 10px;
    }
    .card-title{
      font-weight: 950;
      color: var(--gold);
      letter-spacing: .08em;
    }
    .x{
      width:42px;height:42px;border-radius: 14px;
      border:1px solid rgba(214,179,106,.25);
      background: rgba(0,0,0,.25);
      display:grid; place-items:center;
      cursor:pointer; user-select:none;
    }
    .x:active{transform: scale(.99)}
    .card-body{
      padding: 6px 6px 0;
      color: rgba(255,255,255,.9);
      line-height: 1.55;
    }
    .quote{
      font-weight: 900;
      font-size: calc(var(--fs-base) + 2px);
      letter-spacing: .02em;
    }
    .plain{
      margin-top: 10px;
      color: rgba(255,255,255,.78);
      background: rgba(0,0,0,.20);
      border:1px solid rgba(214,179,106,.18);
      border-radius: 16px;
      padding: 10px 12px;
    }

    /* è¨­å®š */
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 6px;
      border-top: 1px solid rgba(214,179,106,.12);
    }
    .row:first-of-type{border-top:none}
    .label{
      font-weight: 900;
      color: rgba(255,255,255,.88);
    }
    .sub{
      font-size: var(--fs-small);
      color: rgba(255,255,255,.65);
      margin-top: 2px;
    }
    .switch{
      width: 56px; height: 34px;
      border-radius: 999px;
      border:1px solid rgba(214,179,106,.25);
      background: rgba(0,0,0,.25);
      position:relative;
      cursor:pointer;
      user-select:none;
      flex:0 0 auto;
    }
    .knob{
      position:absolute; top:4px; left:4px;
      width:26px;height:26px;border-radius:50%;
      background: rgba(255,255,255,.88);
      transition: left .2s ease, background .2s ease;
      box-shadow: 0 8px 16px rgba(0,0,0,.35);
    }
    .switch.on{
      background: rgba(214,179,106,.22);
      border-color: rgba(214,179,106,.55);
    }
    .switch.on .knob{left:26px; background: rgba(214,179,106,.95)}
    input[type="range"]{width: 160px}

    /* å°è¢å¹•å¾®èª¿ */
    @media (max-height: 700px){
      .npc{min-height: 70px}
      .slots{min-height: 120px}
      .pool-grid{min-height: 116px}
      .token{min-height: 52px}
      .btn{padding: 12px 10px}
    }
  </style>
</head>

<body>
  <div class="safeTop"></div>

  <div class="app" id="app">
    <div class="topbar">
      <div class="top-left">
        <div class="rank" id="rankTag">æ–°å…µ</div>
        <div class="meta">
          <div class="chapter" id="chapterLine">å§‹è¨ˆç¯‡ï½œæ¼”ç·´ 1</div>
          <div class="submeta">
            <span class="dot" id="statusDot"></span>
            <span id="statusText">ç›®å‰ç„¡éŒ¯å­—</span>
            <span class="hint-pill" id="hintPill">å­¸ç¿’æç¤ºï¼šé–‹</span>
          </div>
        </div>
      </div>

      <div class="top-right">
        <div class="iconbtn" id="btnSettings" title="è¨­å®š"><span class="icon">âš™ï¸</span></div>
        <div class="iconbtn" id="btnBook" title="å…µæ›¸"><span class="icon">ğŸ“œ</span></div>
      </div>
    </div>

    <div class="npc">
      <div class="npc-badge">å­«æ­¦</div>
      <div class="npc-text" id="npcText"></div>
    </div>

    <div class="stage">
      <div class="board">
        <div class="board-head">
          <div class="board-title">ä½ˆä»¤æ¿</div>
          <div class="missing" id="missingText">ç¼ºè©ï¼š0</div>
        </div>

        <div class="slots" id="slots"></div>

        <div class="actions">
          <button class="btn red" id="btnUndo">æ’¤ä»¤</button>
          <button class="btn" id="btnReset">é‡æ•´</button>
          <button class="btn green" id="btnCheck">é©—ä»¤</button>
        </div>

        <button class="btn gold" id="btnTest" style="display:none;">æ¸¬é©—ï¼ˆç´¯ç©ï¼‰</button>
      </div>

      <div class="pool">
        <div class="pool-head">
          <div>ä»¤ç‰Œå€</div>
          <div class="pager">
            <div class="pbtn" id="pPrev">â€¹</div>
            <div class="pinfo" id="pInfo">1/1</div>
            <div class="pbtn" id="pNext">â€º</div>
          </div>
        </div>
        <div class="pool-grid" id="poolGrid"></div>
      </div>
    </div>

    <div class="safeBottom"></div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- å…µæ›¸ Modal -->
  <div class="modal" id="modalBook">
    <div class="card">
      <div class="card-head">
        <div class="card-title">å…µæ›¸</div>
        <div class="x" data-close="modalBook">âœ•</div>
      </div>
      <div class="card-body">
        <div class="quote" id="bookQuote"></div>
        <div class="plain" id="bookPlain"></div>
      </div>
    </div>
  </div>

  <!-- è¨­å®š Modal -->
  <div class="modal" id="modalSettings">
    <div class="card">
      <div class="card-head">
        <div class="card-title">è¨­å®š</div>
        <div class="x" data-close="modalSettings">âœ•</div>
      </div>

      <div class="card-body">
        <div style="color: rgba(255,255,255,.70); font-size: var(--fs-small); margin-bottom: 10px;">
          v1.2 å…ˆæŠŠã€Œå¥½èƒŒã€å¥½ç©ã€ä¸ç”¨æ»‘ã€ç«™ç©©ã€‚æœ—è®€èˆ‡æ›´æ·±çš„é©šå–œå…ˆç•™åˆ°å¾ŒçºŒã€‚
        </div>

        <div class="row">
          <div>
            <div class="label">å­¸ç¿’æç¤º</div>
            <div class="sub">ä»¤ç‰Œæœƒç”¨å‘¼å¸ç‡ˆæç¤ºä¸‹ä¸€å€‹æ­£ç¢ºé †åº</div>
          </div>
          <div class="switch" id="swHint"><div class="knob"></div></div>
        </div>

        <div class="row">
          <div>
            <div class="label">éŸ³æ•ˆ</div>
            <div class="sub">é»æ“Š/é€šéæ™‚çš„æç¤ºéŸ³ï¼ˆå¯é—œï¼‰</div>
          </div>
          <div class="switch" id="swSfx"><div class="knob"></div></div>
        </div>

        <div class="row">
          <div>
            <div class="label">å­—é«”å¤§å°</div>
            <div class="sub">æ»‘æ¡¿èª¿æ•´ï¼ˆä¹Ÿæœƒå½±éŸ¿æŒ‰éˆ•å­—ï¼‰</div>
          </div>
          <input type="range" id="fontRange" min="14" max="20" step="1" />
        </div>

        <button class="btn gold" id="btnDone">å®Œæˆ</button>
      </div>
    </div>
  </div>

<script>
/* ========= è³‡æ–™ï¼ˆå…ˆåšå§‹è¨ˆç¯‡ä¸€å°æ®µé©—è­‰ï¼‰ ========= */
const drills = [
  {
    id: "SC_01",
    chapter: "å§‹è¨ˆç¯‡",
    title: "æ¼”ç·´ 1",
    segments: ["å…µè€…","åœ‹ä¹‹å¤§äº‹","æ­»ç”Ÿä¹‹åœ°","å­˜äº¡ä¹‹é“","ä¸å¯ä¸å¯Ÿä¹Ÿ"],
    quote: "å…µè€…ï¼Œåœ‹ä¹‹å¤§äº‹ï¼Œæ­»ç”Ÿä¹‹åœ°ï¼Œå­˜äº¡ä¹‹é“ï¼Œä¸å¯ä¸å¯Ÿä¹Ÿã€‚",
    plain: "ã€ç™½è©±ã€‘æˆ°çˆ­æ˜¯åœ‹å®¶çš„å¤§äº‹ï¼Œé—œä¿‚åˆ°è»æ°‘ç”Ÿæ­»ã€åœ‹å®¶å­˜äº¡ï¼Œæ‰€ä»¥çµ•å°ä¸èƒ½ä¸ä»”ç´°å¯©å¯Ÿã€‚"
  },
  {
    id: "SC_02",
    chapter: "å§‹è¨ˆç¯‡",
    title: "æ¼”ç·´ 2",
    segments: ["ä¸€æ›°é“","äºŒæ›°å¤©","ä¸‰æ›°åœ°","å››æ›°å°‡","äº”æ›°æ³•"],
    quote: "ä¸€æ›°é“ï¼ŒäºŒæ›°å¤©ï¼Œä¸‰æ›°åœ°ï¼Œå››æ›°å°‡ï¼Œäº”æ›°æ³•ã€‚",
    plain: "ã€ç™½è©±ã€‘äº”å€‹é¢å‘ï¼šé“ï¼ˆä¸Šä¸‹åŒå¿ƒï¼‰ã€å¤©ï¼ˆæ™‚æ©Ÿè®Šæ•¸ï¼‰ã€åœ°ï¼ˆåœ°å½¢åˆ©å®³ï¼‰ã€å°‡ï¼ˆå°‡é ˜ç´ è³ªï¼‰ã€æ³•ï¼ˆçµ„ç¹”åˆ¶åº¦ï¼‰ã€‚"
  }
];

/* ========= ç‹€æ…‹ ========= */
let idx = 0;
let selection = [];     // å·²æ”¾å…¥ä½ˆä»¤æ¿çš„ segments
let pool = [];          // ä»¤ç‰Œå€çš„ segmentsï¼ˆäº‚åºï¼‰
let page = 0;
const perPage = 4;      // å…©åˆ—ï¼ˆ2x2ï¼‰
let hintOn = true;      // é è¨­é–‹å•Ÿ
let sfxOn = false;      // é è¨­é—œé–‰ï¼ˆå…ˆä¿å®ˆï¼‰
let passed = false;     // æ­¤æ®µæ˜¯å¦å·²é©—ä»¤é€šé

/* ç´¯ç©æ¸¬é©—ï¼šç¬¬ n æ®µå¯æ¸¬å‰ n æ®µï¼ˆå¦³çš„æƒ³æ³•ï¼‰ */
let testUnlocked = 0;   // å·²è§£é–åˆ°ç¬¬å¹¾æ®µï¼ˆé©—ä»¤é€šéæ‰+1ï¼‰

/* ========= DOM ========= */
const rankTag = document.getElementById("rankTag");
const chapterLine = document.getElementById("chapterLine");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const hintPill = document.getElementById("hintPill");

const npcText = document.getElementById("npcText");
const slotsEl = document.getElementById("slots");
const missingText = document.getElementById("missingText");

const poolGrid = document.getElementById("poolGrid");
const pPrev = document.getElementById("pPrev");
const pNext = document.getElementById("pNext");
const pInfo = document.getElementById("pInfo");

const btnUndo = document.getElementById("btnUndo");
const btnReset = document.getElementById("btnReset");
const btnCheck = document.getElementById("btnCheck");
const btnBook = document.getElementById("btnBook");
const btnSettings = document.getElementById("btnSettings");
const btnTest = document.getElementById("btnTest");

const modalBook = document.getElementById("modalBook");
const bookQuote = document.getElementById("bookQuote");
const bookPlain = document.getElementById("bookPlain");

const modalSettings = document.getElementById("modalSettings");
const swHint = document.getElementById("swHint");
const swSfx = document.getElementById("swSfx");
const fontRange = document.getElementById("fontRange");
const btnDone = document.getElementById("btnDone");

const toast = document.getElementById("toast");

/* ========= éŸ³æ•ˆï¼ˆä¸èµ°å¤–éƒ¨æª”ï¼Œå…å¾—ä¸Šç·šéº»ç…©ï¼‰ ========= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let ac = null;
function beep(freq=660, dur=0.06, type="sine", gain=0.06){
  if(!sfxOn) return;
  try{
    if(!ac) ac = new AudioCtx();
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(ac.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, dur*1000);
  }catch(e){}
}
function sfxClick(){beep(540,0.05,"triangle",0.05)}
function sfxOk(){beep(880,0.08,"sine",0.06); setTimeout(()=>beep(1175,0.08,"sine",0.05),90)}
function sfxBad(){beep(220,0.10,"sawtooth",0.03)}

/* ========= å°å·¥å…· ========= */
function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1300);
}
function setNpc(msg){
  npcText.textContent = msg;
  // è¶…éä¸‰è¡Œå°±æ·¡å‡ºï¼Œä¸¦é¡¯ç¤ºã€Œçœ‹å®Œæ•´ç‰ˆã€
  npcText.classList.remove("fade");
  const lineHeight = 1.35;
  const maxH = (lineHeight * 3) * parseFloat(getComputedStyle(npcText).fontSize);
  // å…ˆè®“å®ƒè‡ªç„¶æ’ç‰ˆï¼Œå†æª¢æ¸¬
  requestAnimationFrame(()=>{
    if(npcText.scrollHeight > maxH + 6){
      npcText.classList.add("fade");
      ensureNpcMore(msg);
    }else{
      removeNpcMore();
    }
  });
}
function ensureNpcMore(full){
  if(document.getElementById("npcMore")) return;
  const more = document.createElement("div");
  more.id = "npcMore";
  more.className = "npc-more";
  more.textContent = "çœ‹å®Œæ•´ç‰ˆ";
  more.onclick = ()=>{
    sfxClick();
    openModalText("å­«æ­¦", full);
  };
  npcText.parentNode.appendChild(more);
}
function removeNpcMore(){
  const el = document.getElementById("npcMore");
  if(el) el.remove();
}

/* é€šç”¨æ–‡å­—å½ˆçª— */
function openModalText(title, content){
  bookQuote.textContent = title + "ï¼š";
  bookPlain.textContent = content;
  modalBook.classList.add("show");
}
function closeModal(id){
  document.getElementById(id).classList.remove("show");
}

/* ========= UIæ¸²æŸ“ ========= */
function render(){
  const d = drills[idx];
  chapterLine.textContent = `${d.chapter}ï½œ${d.title}`;
  missingText.textContent = `ç¼ºè©ï¼š${Math.max(0, d.segments.length - selection.length)}`;

  // ç‹€æ…‹
  statusDot.style.background = passed ? "var(--ok)" : "rgba(255,255,255,.28)";
  statusText.textContent = passed ? "é©—ä»¤é€šéï¼ˆç©©ï¼‰" : "å°šæœªé©—ä»¤";
  hintPill.textContent = `å­¸ç¿’æç¤ºï¼š${hintOn ? "é–‹" : "é—œ"}`;

  // å…µæ›¸æŒ‰éˆ•ï¼šé€šéå¾Œæ‰äº® + å‘¼å¸ç‡ˆæç¤º
  btnBook.classList.toggle("breath", passed);

  // ä½ˆä»¤æ¿ slots
  slotsEl.innerHTML = "";
  const need = d.segments.length;
  for(let i=0;i<need;i++){
    const slot = document.createElement("div");
    slot.className = "token";
    slot.style.opacity = selection[i] ? "1" : ".30";
    slot.textContent = selection[i] ? selection[i] : " ";
    slot.onclick = ()=>{
      if(!selection[i]) return;
      sfxClick();
      // é» slot é€€å› pool
      const word = selection[i];
      selection.splice(i,1);
      pool.push(word);
      pool = shuffle(pool);
      passed = false;
      page = 0;
      setNpc(randomEncourage(false));
      render();
    };
    slotsEl.appendChild(slot);
  }

  // ä»¤ç‰Œå€åˆ†é 
  const totalPages = Math.max(1, Math.ceil(pool.length / perPage));
  if(page > totalPages-1) page = totalPages-1;
  pInfo.textContent = `${page+1}/${totalPages}`;
  pPrev.style.opacity = page===0 ? .35 : 1;
  pNext.style.opacity = page===totalPages-1 ? .35 : 1;

  poolGrid.innerHTML = "";
  const start = page*perPage;
  const slice = pool.slice(start, start+perPage);
  while(slice.length < perPage) slice.push(null);

  slice.forEach((word, i)=>{
    const t = document.createElement("div");
    t.className = "token";
    t.style.visibility = word ? "visible" : "hidden";
    if(word){
      t.textContent = word;

      // æç¤ºï¼šä¸‹ä¸€å€‹æ­£ç¢ºè©çš„å‘¼å¸ç‡ˆ
      if(hintOn && !passed){
        const next = d.segments[selection.length];
        if(word === next) t.classList.add("hint");
      }

      t.onclick = ()=>{
        sfxClick();
        if(passed) return;

        // æ”¾å…¥ä¸‹ä¸€å€‹ç©ºä½ï¼ˆé †åºä¸Šä½ï¼‰
        if(selection.length >= need) return;
        selection.push(word);

        // å¾ pool ç§»é™¤ï¼ˆç”¨ indexOf æœƒç§»åˆ°å¦ä¸€é é€ æˆæ€ªæ„Ÿï¼Œé€™è£¡ç”¨å¯¦éš›ç´¢å¼•ï¼‰
        const realIndex = pool.indexOf(word);
        if(realIndex > -1) pool.splice(realIndex,1);

        // æ”¾å®Œå¾Œä¸è®“ä»¤ç‰Œã€Œæ‰å‡ºæ¿ã€ï¼šæˆ‘å€‘ä¸åšæ‹–æ›³ï¼Œåªåšé»é¸ï¼Œæ¿ä¸Šæ°¸é ç©©å®š
        setNpc(randomEncourage(false));
        render();
      };
    }
    poolGrid.appendChild(t);
  });

  // æ¸¬é©—æŒ‰éˆ•ï¼šè‡³å°‘é€šé 1 æ®µæ‰å‡ºç¾
  btnTest.style.display = (testUnlocked >= 1) ? "block" : "none";
}

/* ========= æ–‡æ¡ˆï¼ˆä¸å…‡çš„å­«æ­¦ï¼‰ ========= */
function randomEncourage(isPass){
  const a = [
    "ä¸ç”¨æ€¥ã€‚ä½ åªè¦æ¯”å‰›å‰›æ›´é †ä¸€é»ï¼Œå°±å¤ äº†ã€‚",
    "å…ˆé †å£ï¼Œå†ç©©ä½ï¼›ç©©ä½äº†ï¼Œå°±èƒŒèµ·ä¾†ã€‚",
    "ä½ ä¸æ˜¯åœ¨èƒŒå­—ï¼Œä½ æ˜¯åœ¨æŠŠç¯€å¥è£é€²è…¦å­ã€‚",
    "é€™æ®µä½ å·²ç¶“æŠ“åˆ°é–€è·¯äº†ï¼Œå‰©ä¸‹æ˜¯ç†Ÿç·´ã€‚",
    "å¥½ï¼Œåˆ¥è¿½å®Œç¾ï¼Œè¿½ã€æ›´é †ã€å°±è¡Œã€‚"
  ];
  const b = [
    "ç©©ã€‚é€™æ®µå…ˆæ”¶ä¸‹ï¼Œç­‰ä½ æƒ³çœ‹å†ç¿»å…µæ›¸ã€‚",
    "å¥½ï¼Œéäº†ã€‚ä½ ç¾åœ¨ä¸æ˜¯è¨˜ä½ï¼Œæ˜¯ã€èƒ½èªªå‡ºå£ã€äº†ã€‚",
    "ä¸éŒ¯ã€‚ä½ å·²ç¶“æŠŠéª¨æ¶ç«‹èµ·ä¾†äº†ã€‚",
    "å¯ä»¥ã€‚é€™æ®µå…ˆç•¶æˆä½ çš„ã€Œç¬¬ä¸€æ”¯è»ä»¤ã€ã€‚"
  ];
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  return isPass ? pick(b) : pick(a);
}

/* ========= æµç¨‹ ========= */
function loadDrill(i){
  idx = i;
  selection = [];
  pool = shuffle(drills[idx].segments);
  page = 0;
  passed = false;

  setNpc(randomEncourage(false));
  render();
}

function check(){
  const d = drills[idx];
  if(selection.length !== d.segments.length){
    sfxBad();
    showToast("ä½ˆä»¤æœªæ»¿ã€‚å…ˆæŠŠä»¤ç‰Œè£œé½Šã€‚");
    setNpc("å…ˆæŠŠä»¤ç‰Œæ”¾æ»¿ã€‚æ»¿äº†å†é©—ä»¤ï¼Œæ¯”è¼ƒæº–ã€‚");
    return;
  }
  // ä¸€å­—ä¸å·®ï¼ˆä»¥ã€Œè©ã€ç‚ºå–®ä½ï¼‰
  const ok = d.segments.every((w, i)=>selection[i] === w);
  if(ok){
    passed = true;
    sfxOk();
    showToast("é©—ä»¤é€šéï¼ˆç©©ï¼‰");
    setNpc(randomEncourage(true));

    // è§£é–ç´¯ç©æ¸¬é©—
    testUnlocked = Math.max(testUnlocked, idx+1);

    // å…µæ›¸è³‡æ–™å‚™å¥½ï¼Œä½†ä¸è‡ªå‹•è·³
    bookQuote.textContent = d.quote;
    bookPlain.textContent = d.plain;

    render();
  }else{
    sfxBad();
    showToast("é †åºäº‚äº†ï¼šé‡æ•´æˆ–æ’¤ä»¤èª¿æ•´");
    setNpc("é †åºæœ‰é»äº‚ã€‚å…ˆé‡æ•´ä¸€ä¸‹ï¼Œå†ä¾†ä¸€æ¬¡æœƒæ›´å¿«ã€‚");
  }
}

function undo(){
  if(selection.length===0) return;
  sfxClick();
  const word = selection.pop();
  pool.push(word);
  pool = shuffle(pool);
  passed = false;
  page = 0;
  setNpc("æ’¤ä¸€å¼µå°±å¥½ã€‚ä½ æ˜¯åœ¨ä¿®é †åºï¼Œä¸æ˜¯åœ¨æ¨å€’é‡ä¾†ã€‚");
  render();
}

function reset(){
  sfxClick();
  loadDrill(idx);
  showToast("å·²é‡æ•´");
}

/* ========= æ¸¬é©—ï¼ˆç´¯ç©ï¼‰ =========
   å…ˆåšã€Œå…¥å£èˆ‡åŸºæœ¬æµç¨‹ã€ï¼šæ¸¬é©—æœƒæŠ½ã€Œå·²é€šéçš„æ®µè½ã€å…¶ä¸­ä¸€æ®µï¼Œé—œæ‰æç¤ºï¼ˆé™¤éä½ æ‰‹å‹•é–‹ï¼‰ã€‚
*/
function startTest(){
  if(testUnlocked < 1){
    showToast("å…ˆé€šéä¸€æ®µï¼Œæ‰æœ‰æ¸¬é©—ã€‚");
    return;
  }
  // æŠ½ 1 æ®µå…ˆæ¸¬ï¼ˆä¹‹å¾Œå†æ“´å……æˆï¼šç¬¬2æ®µæ¸¬1+2ï¼Œç¬¬4æ®µæ¸¬1~3ï¼‰
  const max = Math.min(testUnlocked, drills.length);
  const pickIdx = Math.floor(Math.random()*max);
  idx = pickIdx;
  selection = [];
  pool = shuffle(drills[idx].segments);
  page = 0;
  passed = false;

  // æ¸¬é©—é è¨­æŠŠæç¤ºé—œæ‰ï¼ˆä½†ä½ å¯åœ¨è¨­å®šæ‰“é–‹ï¼‰
  hintOn = false;
  syncSettingsUI();
  setNpc("æ¸¬é©—ï¼šä¸é æç¤ºï¼Œçœ‹çœ‹ä½ èƒ½ä¸èƒ½é †å£æ’å›ä¾†ã€‚å¡ä½å†é–‹å­¸ç¿’æç¤ºä¹Ÿè¡Œã€‚");
  showToast("æ¸¬é©—é–‹å§‹");
  render();
}

/* ========= å…µæ›¸ ========= */
function openBook(){
  if(!passed){
    showToast("å…ˆé©—ä»¤é€šéï¼Œå…µæ›¸æ‰æœƒé–‹å·ã€‚");
    return;
  }
  sfxClick();
  const d = drills[idx];
  bookQuote.textContent = d.quote;
  bookPlain.textContent = d.plain;
  modalBook.classList.add("show");
}

/* ========= è¨­å®š ========= */
function setSwitch(el, on){
  el.classList.toggle("on", on);
}
function syncSettingsUI(){
  setSwitch(swHint, hintOn);
  setSwitch(swSfx, sfxOn);
  fontRange.value = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--fs-base"));
  hintPill.textContent = `å­¸ç¿’æç¤ºï¼š${hintOn ? "é–‹" : "é—œ"}`;
}
function applyFont(px){
  document.documentElement.style.setProperty("--fs-base", px+"px");
}

/* ========= ç¶å®š ========= */
btnUndo.onclick = undo;
btnReset.onclick = reset;
btnCheck.onclick = check;

pPrev.onclick = ()=>{ if(page>0){ sfxClick(); page--; render(); } };
pNext.onclick = ()=>{
  const totalPages = Math.max(1, Math.ceil(pool.length / perPage));
  if(page<totalPages-1){ sfxClick(); page++; render(); }
};

btnBook.onclick = openBook;
btnSettings.onclick = ()=>{
  sfxClick();
  syncSettingsUI();
  modalSettings.classList.add("show");
};

btnDone.onclick = ()=>{
  sfxClick();
  closeModal("modalSettings");
};

btnTest.onclick = startTest;

document.querySelectorAll("[data-close]").forEach(x=>{
  x.onclick = ()=>{ sfxClick(); closeModal(x.dataset.close); }
});
modalBook.addEventListener("click",(e)=>{ if(e.target===modalBook) closeModal("modalBook"); });
modalSettings.addEventListener("click",(e)=>{ if(e.target===modalSettings) closeModal("modalSettings"); });

swHint.onclick = ()=>{
  sfxClick();
  hintOn = !hintOn;
  syncSettingsUI();
  render();
};
swSfx.onclick = ()=>{
  sfxClick();
  sfxOn = !sfxOn;
  syncSettingsUI();
  showToast(sfxOn ? "éŸ³æ•ˆï¼šé–‹" : "éŸ³æ•ˆï¼šé—œ");
};

fontRange.oninput = ()=>{
  applyFont(parseInt(fontRange.value,10));
  // å­—è®Šå¤§å¾Œå³åˆ»é‡ç®—å­«æ­¦ä¸‰è¡Œæ·¡å‡º
  setNpc(npcText.textContent);
  render();
};

/* ========= åˆå§‹ ========= */
applyFont(16);
hintOn = true;   // é è¨­é–‹å•Ÿ
sfxOn = false;   // é è¨­é—œé–‰
testUnlocked = 0;

loadDrill(0);
</script>
</body>
</html>
