<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>孫子兵法｜佈令背誦 v1（母版 5.2）</title>
  <style>
    :root{
      --bg:#0f1410;
      --panel:#151b16;
      --panel2:#1b241d;
      --ink:#e9efe9;
      --muted:#aab6aa;
      --line:#2b3a2f;
      --gold:#d6b25e;
      --red:#b23a2f;
      --green:#2e7d32;

      --token:#212b23;
      --token2:#1a221b;

      --glowStrong: 0 0 1.15rem rgba(255,225,140,.95), 0 0 2.2rem rgba(255,225,140,.45);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 22px;

      --fontScale: 1;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% -20%, rgba(214,178,94,.16), transparent 55%),
                  radial-gradient(1000px 600px at 120% 0%, rgba(46,125,50,.12), transparent 60%),
                  var(--bg);
      color:var(--ink);
      font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      overflow:hidden;
    }

    .safeTop{ padding-top: env(safe-area-inset-top); }
    .safeBottom{ padding-bottom: env(safe-area-inset-bottom); }

    .app{
      height: 100dvh;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(21,27,22,.95), rgba(21,27,22,.55));
      backdrop-filter: blur(10px);
    }
    .toprow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .titleWrap{ min-width:0; }
    .title{
      font-size: calc(18px * var(--fontScale));
      font-weight: 760;
      letter-spacing:.02em;
    }
    .subtitle{
      margin-top:4px;
      font-size: calc(12px * var(--fontScale));
      color: var(--muted);
    }
    .topActions{
      display:flex;
      gap:8px;
      flex-shrink:0;
    }

    .pillBtn{
      border:1px solid var(--line);
      background: rgba(27,36,29,.7);
      color: var(--ink);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: calc(12px * var(--fontScale));
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .pillBtn.primary{
      border-color: rgba(214,178,94,.45);
      background: rgba(214,178,94,.14);
      color: var(--ink);
    }
    .pillBtn.danger{
      border-color: rgba(178,58,47,.55);
      background: rgba(178,58,47,.14);
    }

    .main{
      flex:1;
      min-height:0;
      padding: 14px;
      overflow:hidden;
    }

    .panel{
      height: 100%;
      background: linear-gradient(180deg, rgba(27,36,29,.75), rgba(21,27,22,.65));
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .view{
      height:100%;
      display:none;
    }
    .view.active{ display:block; }

    .scroll{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    /* OVERVIEW */
    .list{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px 14px;
      border:1px solid rgba(43,58,47,.9);
      border-radius: 16px;
      background: rgba(21,27,22,.55);
      cursor:pointer;
    }
    .rowLeft{ min-width:0; }
    .rowTitle{
      font-size: calc(15px * var(--fontScale));
      font-weight: 720;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rowDesc{
      margin-top:4px;
      font-size: calc(12px * var(--fontScale));
      color: var(--muted);
    }
    .badgeProgress{
      flex-shrink:0;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(214,178,94,.35);
      background: rgba(214,178,94,.12);
      color: var(--ink);
      font-weight: 760;
      font-size: calc(12px * var(--fontScale));
    }

    /* HOME */
    .homeCard{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:14px;
      gap:12px;
    }
    .homeTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .homeTitle{
      font-size: calc(18px * var(--fontScale));
      font-weight: 800;
    }
    .homeProgress{
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }
    .homeText{
      flex:1;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 12px;
      border:1px solid rgba(43,58,47,.9);
      border-radius: 16px;
      background: rgba(21,27,22,.52);
      font-size: calc(14px * var(--fontScale));
      line-height: 1.75;
      color: rgba(233,239,233,.92);
      white-space: pre-wrap;
    }

    .homeReadRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px;
      border:1px solid rgba(43,58,47,.9);
      border-radius: 16px;
      background: rgba(21,27,22,.52);
    }
    .homeReadTitle{ font-weight: 800; font-size: calc(14px * var(--fontScale)); }
    .homeReadDesc{ margin-top:4px; color:var(--muted); font-size: calc(12px * var(--fontScale)); }

    .homeActions{
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      border: 1px solid var(--line);
      background: rgba(27,36,29,.75);
      color: var(--ink);
      padding: 12px 14px;
      border-radius: 16px;
      font-size: calc(14px * var(--fontScale));
      font-weight: 760;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .btn.primary{
      border-color: rgba(214,178,94,.45);
      background: rgba(214,178,94,.16);
    }

    /* GAME */
    .gameWrap{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: 14px;
      gap: 10px;
      min-height:0;
    }

    .statusLine{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .npc{
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-width:0;
    }
    .npcBadge{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      background: rgba(214,178,94,.18);
      border: 1px solid rgba(214,178,94,.45);
      flex-shrink:0;
    }
    .npcText{
      font-size: calc(13px * var(--fontScale));
      color: rgba(233,239,233,.9);
      line-height:1.5;
      padding-top: 4px;
      min-width:0;
      word-break: break-word;
    }

    .miniBtn{
      border:1px solid rgba(43,58,47,.95);
      background: rgba(21,27,22,.55);
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 12px;
      font-size: calc(12px * var(--fontScale));
      cursor:pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,.25);
      white-space:nowrap;
    }
    .miniBtn.primary{
      border-color: rgba(214,178,94,.45);
      background: rgba(214,178,94,.15);
      font-weight: 800;
    }
    .miniBtn.book{
      border-color: rgba(214,178,94,.22);
    }
    .miniBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    /* ✅ 2 → 3：上方固定，下面是可滾動工作區 */
    .workArea{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .slots{
      border: 1px solid rgba(43,58,47,.9);
      background: rgba(21,27,22,.52);
      border-radius: 16px;
      padding: 12px;
      min-height: 110px;
      display:flex;
      flex-wrap: wrap;
      gap:8px;
      align-content:flex-start;
    }

    /* ✅ 令牌板做成「可滾動」：長段不再把畫面撐爆 */
    .tokensWrap{
      flex:1;
      min-height:0;
      border: 1px solid rgba(43,58,47,.9);
      background: rgba(21,27,22,.52);
      border-radius: 16px;
      padding: 10px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .tokens{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-content:flex-start;
    }

    .token{
      background: linear-gradient(180deg, rgba(33,43,35,.92), rgba(26,34,27,.78));
      border:1px solid rgba(43,58,47,.95);
      color: var(--ink);
      padding: 9px 10px;
      border-radius: 999px;
      font-size: calc(13px * var(--fontScale));
      font-weight: 760;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .token:hover{ transform: translateY(-1px); }
    .slotToken{
      background: rgba(214,178,94,.12);
      border-color: rgba(214,178,94,.35);
    }

    .hintRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border: 1px solid rgba(43,58,47,.9);
      background: rgba(21,27,22,.52);
      border-radius: 16px;
    }
    .hintLeft{ min-width:0; }
    .hintTitle{ font-weight: 820; font-size: calc(13px * var(--fontScale)); }
    .hintDesc{ margin-top:4px; color:var(--muted); font-size: calc(12px * var(--fontScale)); }

    .switch{
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }
    .switch input{ transform: scale(1.1); }

    /* SETTINGS */
    .settings{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .setCard{
      border:1px solid rgba(43,58,47,.9);
      background: rgba(21,27,22,.52);
      border-radius: 16px;
      padding: 12px;
    }
    .setRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 0;
      border-top: 1px solid rgba(43,58,47,.55);
    }
    .setRow:first-child{ border-top:none; padding-top:0; }
    .setLeft{ min-width:0; }
    .setTitle{ font-weight: 820; font-size: calc(14px * var(--fontScale)); }
    .setDesc{ margin-top:4px; color:var(--muted); font-size: calc(12px * var(--fontScale)); }
    .range{
      width: 160px;
    }

    /* MODAL */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.55);
      z-index: 40;
    }
    .modal.show{ display:flex; }
    .modalCard{
      width: min(720px, 100%);
      max-height: min(78vh, 720px);
      background: linear-gradient(180deg, rgba(27,36,29,.95), rgba(21,27,22,.92));
      border: 1px solid rgba(43,58,47,.95);
      border-radius: 18px;
      box-shadow: 0 22px 48px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(43,58,47,.7);
    }
    .modalTitle{
      font-weight: 900;
      font-size: calc(14px * var(--fontScale));
      letter-spacing:.02em;
    }
    .modalClose{
      border:1px solid rgba(43,58,47,.95);
      background: rgba(21,27,22,.55);
      color:var(--ink);
      padding: 7px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size: calc(12px * var(--fontScale));
    }
    .modalBody{
      padding: 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalActions{
      display:flex;
      gap:10px;
      padding: 12px 14px;
      border-top: 1px solid rgba(43,58,47,.7);
      background: rgba(21,27,22,.35);
    }

    .quote{ font-size: calc(16px * var(--fontScale)); line-height:1.75; font-weight: 820; }
    .plain{ margin-top:10px; font-size: calc(13px * var(--fontScale)); line-height:1.75; color: rgba(233,239,233,.92); }
    .muted{ color: var(--muted); }

    /* ✅ 浮動測驗鈕 */
    .fab{
      position: fixed;
      right: 16px;
      bottom: calc(16px + env(safe-area-inset-bottom));
      z-index: 30;
      border-radius: 999px;
      padding: 12px 14px;
      border: 1px solid rgba(214,178,94,.45);
      background: rgba(214,178,94,.16);
      color: var(--ink);
      font-weight: 900;
      font-size: calc(13px * var(--fontScale));
      box-shadow: 0 18px 36px rgba(0,0,0,.35);
      cursor:pointer;
      display:none;
    }
    .fab.show{ display:inline-flex; align-items:center; gap:8px; }
    .fab small{ font-weight: 800; opacity:.9; }

    /* 小螢幕修正 */
    @media (max-height: 740px){
      .slots{ min-height: 96px; }
      .homeText{ max-height: 36vh; }
    }
  </style>
</head>

<body style="--fontScale:1;">
  <div class="app safeTop safeBottom">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="toprow">
        <div class="titleWrap">
          <div class="title" id="topTitle">孫子兵法</div>
          <div class="subtitle" id="topSub">原書順序</div>
        </div>
        <div class="topActions">
          <button class="pillBtn primary" id="btnOverview">總覽</button>
          <button class="pillBtn" id="btnBackOrSettings">設定</button>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- OVERVIEW -->
      <div class="view active panel scroll" id="viewOverview">
        <div class="list" id="overviewList"></div>
      </div>

      <!-- CHAPTER HOME -->
      <div class="view panel" id="viewChapterHome">
        <div class="homeCard">
          <div class="homeTop">
            <div style="min-width:0">
              <div class="homeTitle" id="homeTitle">第一篇 始計篇</div>
              <div class="subtitle muted" id="homeSub">（點「開始佈令」進入）</div>
            </div>
            <div class="homeProgress">
              <span class="badgeProgress" id="homeProgressBadge">0/0</span>
            </div>
          </div>

          <div class="homeText" id="homeFullText"></div>

          <div class="homeReadRow">
            <div class="homeReadLeft">
              <div class="homeReadTitle">整篇朗讀</div>
              <div class="homeReadDesc">可暫停、續播</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-shrink:0;">
              <button class="miniBtn" id="btnHomeRead">朗讀</button>
              <button class="miniBtn" id="btnHomeStop">停止</button>
            </div>
          </div>

          <div class="homeActions">
            <button class="btn primary" id="btnStart">開始佈令</button>
            <button class="btn" id="btnFromStart">從頭重練</button>
          </div>
        </div>
      </div>

      <!-- GAME -->
      <div class="view panel" id="viewGame">
        <div class="gameWrap">
          <div class="statusLine">
            <div class="npc">
              <div class="npcBadge">孫</div>
              <div class="npcText" id="npcLine"></div>
            </div>
            <div style="display:flex; gap:8px; align-items:flex-start; flex-shrink:0;">
              <button class="miniBtn" id="btnSegRead">朗讀</button>
              <button class="miniBtn" id="btnReset">重整</button>
              <button class="miniBtn book" id="btnBook" disabled>兵書</button>
              <button class="miniBtn primary" id="btnNext" disabled>下一關</button>
            </div>
          </div>

          <!-- ✅ 先 2 再 3：上方佈令板固定，下面令牌板可滾 -->
          <div class="workArea">
            <div class="slots" id="slots"></div>
            <div class="tokensWrap" id="tokensWrap">
              <div class="tokens" id="tokens"></div>
            </div>
          </div>

          <div class="hintRow">
            <div class="hintLeft">
              <div class="hintTitle">提示模式</div>
              <div class="hintDesc">會短暫閃亮下一個正確令牌</div>
            </div>
            <div class="switch" id="hintToggleWrap">
              <span class="muted" style="font-size:12px;">關/開</span>
              <input type="checkbox" id="hintSwitch" />
            </div>
          </div>

        </div>
      </div>

      <!-- SETTINGS -->
      <div class="view panel scroll" id="viewSettings">
        <div class="settings">
          <div class="setCard">
            <div class="setRow">
              <div class="setLeft">
                <div class="setTitle">字體大小</div>
                <div class="setDesc">全站同步放大縮小（包含總覽與篇章）</div>
              </div>
              <input class="range" id="fontScale" type="range" min="0.88" max="1.22" step="0.01" />
            </div>

            <div class="setRow">
              <div class="setLeft">
                <div class="setTitle">音效</div>
                <div class="setDesc">正確/錯誤提示音</div>
              </div>
              <input id="soundOn" type="checkbox" />
            </div>

            <div class="setRow">
              <div class="setLeft">
                <div class="setTitle">朗讀（TTS）</div>
                <div class="setDesc">使用裝置語音朗讀原文</div>
              </div>
              <input id="ttsOn" type="checkbox" />
            </div>

            <div class="setRow">
              <div class="setLeft">
                <div class="setTitle">提示預設為開</div>
                <div class="setDesc">每次進段落預設提示狀態</div>
              </div>
              <input id="hintDefault" type="checkbox" />
            </div>

            <div class="setRow">
              <div class="setLeft">
                <div class="setTitle">清空足跡紀錄</div>
                <div class="setDesc">進度、測驗、設定全部歸零</div>
              </div>
              <button class="pillBtn danger" id="btnClear">清空</button>
            </div>
          </div>

          <div class="setCard">
            <div class="setTitle">小提醒</div>
            <div class="setDesc" style="margin-top:8px; line-height:1.65;">
              (1) 令牌太多會心煩是正常的：我們已把令牌板做成可滾動，不會再卡死。<br/>
              (2) 測驗用「浮動測驗鈕」開啟，不會佔你的佈令空間。<br/>
              (3) 長段落若仍覺得壓力大，下一步可以做「自動再切細」：超過 N 個令牌就拆成兩段（我也能幫你加）。
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ✅ 浮動測驗鈕 -->
    <button class="fab" id="fabTest">測驗 <small id="fabHint">0/0</small></button>

    <!-- MODAL -->
    <div class="modal" id="modal">
      <div class="modalCard">
        <div class="modalHead">
          <div class="modalTitle" id="modalTitle">兵書</div>
          <button class="modalClose" id="modalClose">關閉</button>
        </div>
        <div class="modalBody" id="modalBody"></div>
        <div class="modalActions" id="modalActions" style="display:none;"></div>
      </div>
    </div>

  </div>

<script>
(() => {
  /***********************
   * DATA（完美母版5(定稿2) 的拆段風格）
   * ✅ 白話：補回來（兵書會顯示）
   ***********************/
  const CHAPTERS = [
    { id: 1, name: "第一篇 始計篇", segments: [
      {
        quote: "孫子曰：兵者，國之大事，死生之地，存亡之道，不可不察也。",
        tokens: ["孫子曰","兵者","國之大事","死生之地","存亡之道","不可不察也"],
        plain: "戰爭是國家大事，關係生死與存亡，必須審慎考察。"
      },
      {
        quote: "故經之以五事，校之以計，而索其情：一曰道，二曰天，三曰地，四曰將，五曰法。",
        tokens: ["故經之以五事","校之以計","而索其情","一曰道","二曰天","三曰地","四曰將","五曰法"],
        plain: "用五個面向做框架來評估局勢：道、天、地、將、法。"
      },
      {
        quote: "道者，令民與上同意也，故可以與之死，可以與之生，而不畏危。",
        tokens: ["道者","令民與上同意也","故可以與之死","可以與之生","而不畏危"],
        plain: "「道」是讓百姓與領導同心同德，能同生共死而不怕危險。"
      },
      {
        quote: "天者，陰陽、寒暑、時制也。",
        tokens: ["天者","陰陽","寒暑","時制也"],
        plain: "「天」是時令與節奏：陰陽消長、寒暑變化、時間規律。"
      },
      {
        quote: "地者，遠近、險易、廣狹、死生也。",
        tokens: ["地者","遠近","險易","廣狹","死生也"],
        plain: "「地」是地理條件：遠近、險易、廣狹，以及生死要害。"
      },
      {
        quote: "將者，智、信、仁、勇、嚴也。",
        tokens: ["將者","智","信","仁","勇","嚴也"],
        plain: "「將」看的是將領素質：智慧、信用、仁心、勇氣、紀律。"
      },
      {
        quote: "法者，曲制、官道、主用也。",
        tokens: ["法者","曲制","官道","主用也"],
        plain: "「法」是制度與執行：編制規章、官府流程、資源調度。"
      },
      {
        quote: "凡此五者，將莫不聞，知之者勝，不知之者不勝。",
        tokens: ["凡此五者","將莫不聞","知之者勝","不知之者不勝"],
        plain: "五者人人都聽過，但懂得活用者勝，不懂者敗。"
      },
      {
        quote: "故校之以計，而索其情，曰：主孰有道？將孰有能？天地孰得？法令孰行？兵眾孰強？士卒孰練？賞罰孰明？吾以此知勝負矣。",
        tokens: ["故校之以計","而索其情","曰","主孰有道","將孰有能","天地孰得","法令孰行","兵眾孰強","士卒孰練","賞罰孰明","吾以此知勝負矣"],
        plain: "逐項比較：哪方更得民心？將領更有能力？時地更有利？制度更能落實？兵力更強？訓練更精？賞罰更分明？用這些就能判勝負。"
      },
      {
        quote: "將聽吾計，用之必勝，留之；將不聽吾計，用之必敗，去之。",
        tokens: ["將聽吾計","用之必勝","留之","將不聽吾計","用之必敗","去之"],
        plain: "能採納良策者必勝就留下；不採納者必敗就離開。"
      },
      {
        quote: "計利以聽，乃為之勢，以佐其外。勢者，因利而制權也。",
        tokens: ["計利以聽","乃為之勢","以佐其外","勢者","因利而制權也"],
        plain: "評估利害後要造「勢」，把外在有利條件轉成掌控力；勢就是因利而制衡權變。"
      },
      {
        quote: "兵者，詭道也。故能而示之不能，用而示之不用，近而示之遠，遠而示之近。",
        tokens: ["兵者","詭道也","故能而示之不能","用而示之不用","近而示之遠","遠而示之近"],
        plain: "用兵講究迷惑：有能力卻裝沒能力，正在用卻裝沒用，近處裝遠、遠處裝近。"
      },
      {
        quote: "利而誘之，亂而取之，實而備之，強而避之。",
        tokens: ["利而誘之","亂而取之","實而備之","強而避之"],
        plain: "見利引誘他；他亂就趁勢取勝；他實就先防備；他強就暫避鋒芒。"
      },
      {
        quote: "怒而撓之，卑而驕之，佚而勞之，親而離之。",
        tokens: ["怒而撓之","卑而驕之","佚而勞之","親而離之"],
        plain: "他易怒就激他亂；他自卑就讓他驕；他安逸就逼他疲；他親密就設法離間。"
      },
      {
        quote: "攻其無備，出其不意。此兵家之勝，不可先傳也。",
        tokens: ["攻其無備","出其不意","此兵家之勝","不可先傳也"],
        plain: "打他沒防備的地方、出他意料之外；兵家取勝之法不能死背成公式。"
      },
      {
        quote: "夫未戰而廟算勝者，得算多也；未戰而廟算不勝者，得算少也。",
        tokens: ["夫未戰而廟算勝者","得算多也","未戰而廟算不勝者","得算少也"],
        plain: "戰前推演準備周密者勝（把握多）；推演不足者敗（把握少）。"
      },
      {
        quote: "多算勝，少算不勝，而況於無算乎？吾以此觀之，勝負見矣。",
        tokens: ["多算勝","少算不勝","而況於無算乎","吾以此觀之","勝負見矣"],
        plain: "算得多就贏、算得少就輸，更何況毫無推演？所以勝負其實早就看得出來。"
      }
    ]},

    { id: 2, name: "第二篇 作戰篇", segments: [] },
    { id: 3, name: "第三篇 謀攻篇", segments: [] },
    { id: 4, name: "第四篇 軍形篇", segments: [] },
    { id: 5, name: "第五篇 兵勢篇", segments: [] },
    { id: 6, name: "第六篇 虛實篇", segments: [] },
    { id: 7, name: "第七篇 軍爭篇", segments: [] },
    { id: 8, name: "第八篇 九變篇", segments: [] },
    { id: 9, name: "第九篇 行軍篇", segments: [] },
    { id: 10, name: "第十篇 地形篇", segments: [] },
    { id: 11, name: "第十一篇 九地篇", segments: [] },
    { id: 12, name: "第十二篇 火攻篇", segments: [] },
    { id: 13, name: "第十三篇 用間篇", segments: [] }
  ];

  /***********************
   * STORAGE
   ***********************/
  const LS_KEY = "sunzi_v1_master";
  const defaultProgress = () => ({
    fontScale: 1.00,
    hintDefault: true,
    hintOn: true,
    soundOn: true,
    ttsOn: true,
    chapters: {} // id -> { passed:number }   （不再叫 stars 了，但兼容舊檔）
  });

  function loadProgress(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return defaultProgress();
      const obj = JSON.parse(raw);
      const base = defaultProgress();
      const merged = { ...base, ...obj };
      merged.chapters = obj.chapters || {};
      return merged;
    }catch(e){
      return defaultProgress();
    }
  }
  function saveProgress(){ localStorage.setItem(LS_KEY, JSON.stringify(PROG)); }

  let PROG = loadProgress();
  document.body.style.setProperty("--fontScale", String(PROG.fontScale));

  /***********************
   * UI REFS
   ***********************/
  const viewOverview = document.getElementById("viewOverview");
  const viewChapterHome = document.getElementById("viewChapterHome");
  const viewGame = document.getElementById("viewGame");
  const viewSettings = document.getElementById("viewSettings");

  const topTitle = document.getElementById("topTitle");
  const topSub = document.getElementById("topSub");

  const btnOverview = document.getElementById("btnOverview");
  const btnBackOrSettings = document.getElementById("btnBackOrSettings");

  const overviewList = document.getElementById("overviewList");

  const homeTitle = document.getElementById("homeTitle");
  const homeSub = document.getElementById("homeSub");
  const homeProgressBadge = document.getElementById("homeProgressBadge");
  const homeFullText = document.getElementById("homeFullText");
  const btnStart = document.getElementById("btnStart");
  const btnFromStart = document.getElementById("btnFromStart");
  const btnHomeRead = document.getElementById("btnHomeRead");
  const btnHomeStop = document.getElementById("btnHomeStop");

  const npcLine = document.getElementById("npcLine");
  const btnSegRead = document.getElementById("btnSegRead");
  const btnReset = document.getElementById("btnReset");
  const btnBook = document.getElementById("btnBook");
  const btnNext = document.getElementById("btnNext");

  const slots = document.getElementById("slots");
  const tokensEl = document.getElementById("tokens");
  const tokensWrap = document.getElementById("tokensWrap");
  const hintSwitch = document.getElementById("hintSwitch");

  const fabTest = document.getElementById("fabTest");
  const fabHint = document.getElementById("fabHint");

  const modal = document.getElementById("modal");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const modalClose = document.getElementById("modalClose");
  const modalActions = document.getElementById("modalActions");

  const fontScale = document.getElementById("fontScale");
  const soundOn = document.getElementById("soundOn");
  const ttsOn = document.getElementById("ttsOn");
  const hintDefault = document.getElementById("hintDefault");
  const btnClear = document.getElementById("btnClear");

  /***********************
   * STATE
   ***********************/
  let currentChapterId = 1;
  let currentSegIndex = 0;
  let selection = [];
  let pool = [];
  let mode = "learn"; // "learn" | "test"
  let testRange = { start:0, end:0 };
  let testCursor = 0;
  let learnReturnIndex = 0; // ✅修正：測驗結束回佈令用

  /***********************
   * HELPERS
   ***********************/
  const escapeHtml = (s) => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function currentChapter(){ return CHAPTERS.find(x => x.id === currentChapterId); }
  function currentSeg(){ return currentChapter().segments[currentSegIndex]; }

  function getChapterProg(chId){
    const p = PROG.chapters[chId] || {};
    // ✅兼容舊版 stars
    const passed = Math.max(p.passed || 0, p.stars || 0);
    if(!PROG.chapters[chId]) PROG.chapters[chId] = { passed };
    else PROG.chapters[chId].passed = passed;
    return PROG.chapters[chId];
  }

  function setView(which){
    [viewOverview, viewChapterHome, viewGame, viewSettings].forEach(v => v.classList.remove("active"));
    which.classList.add("active");
  }

  function updateTopbar(){
    if(viewOverview.classList.contains("active")){
      topTitle.textContent = "孫子兵法";
      topSub.textContent = "原書順序";
      btnBackOrSettings.textContent = "設定";
    }else if(viewChapterHome.classList.contains("active")){
      topTitle.textContent = "篇章";
      topSub.textContent = currentChapter().name;
      btnBackOrSettings.textContent = "返回";
    }else if(viewGame.classList.contains("active")){
      topTitle.textContent = "佈令";
      topSub.textContent = `${currentChapter().name}｜第${currentSegIndex+1}段`;
      btnBackOrSettings.textContent = "返回";
    }else{
      topTitle.textContent = "設定";
      topSub.textContent = "偏好與清空";
      btnBackOrSettings.textContent = "返回";
    }
  }

  function shuffle(arr){
    const a = [...arr];
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  /***********************
   * RENDER: OVERVIEW / HOME
   ***********************/
  function renderOverview(){
    overviewList.innerHTML = "";
    CHAPTERS.forEach(ch => {
      const p = getChapterProg(ch.id);
      const total = ch.segments.length || 0;
      const passed = Math.min(p.passed || 0, total);

      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="rowLeft">
          <div class="rowTitle">${escapeHtml(ch.name)}</div>
          <div class="rowDesc">${total ? "已完成/總段數" : "（尚未加入內容）"}</div>
        </div>
        <div class="badgeProgress">${total ? `${passed}/${total}` : `0/0`}</div>
      `;
      row.onclick = () => {
        currentChapterId = ch.id;
        openChapterHome();
      };
      overviewList.appendChild(row);
    });
  }

  function openChapterHome(){
    setView(viewChapterHome);
    const ch = currentChapter();
    const p = getChapterProg(currentChapterId);
    const total = ch.segments.length || 0;
    const passed = Math.min(p.passed || 0, total);

    homeTitle.textContent = ch.name;
    homeSub.textContent = "（進度以「已完成/總段數」顯示）";
    homeProgressBadge.textContent = `${passed}/${total}`;

    // full text
    if(total){
      homeFullText.textContent = ch.segments.map((s,i)=> `(${i+1}) ${s.quote}`).join("\n\n");
    }else{
      homeFullText.textContent = "此篇尚未加入段落內容。";
    }

    // ✅浮動測驗鈕：只要通過 2 段以上就顯示（不占空間）
    updateFab();
    updateTopbar();
  }

  /***********************
   * FAB TEST (floating)
   ***********************/
  function updateFab(){
    const ch = currentChapter();
    const total = ch.segments.length || 0;
    const p = getChapterProg(currentChapterId);
    const passed = Math.min(p.passed || 0, total);

    fabHint.textContent = `${passed}/${total}`;

    // ✅條件：至少通過 2 段，且目前不是在設定頁
    const inOverviewOrHomeOrGame = viewOverview.classList.contains("active") || viewChapterHome.classList.contains("active") || viewGame.classList.contains("active");
    if(inOverviewOrHomeOrGame && total > 0 && passed >= 2){
      fabTest.classList.add("show");
    }else{
      fabTest.classList.remove("show");
    }
  }

  function openTestPicker(){
    const ch = currentChapter();
    const p = getChapterProg(currentChapterId);
    const passed = Math.min(p.passed || 0, ch.segments.length);

    // 建一個 range picker（start/end）
    const opts = [];
    for(let i=1;i<=passed;i++){
      opts.push(`<option value="${i-1}">第${i}段</option>`);
    }

    openModal("測驗範圍", `
      <div class="plain">
        <div class="muted" style="margin-bottom:10px;">已開放測驗段落：前 ${passed} 段</div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <div style="flex:1; min-width:160px;">
            <div class="muted" style="font-size:12px; margin-bottom:6px;">起段</div>
            <select id="tpStart" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(43,58,47,.95); background: rgba(21,27,22,.55); color: var(--ink);">
              ${opts.join("")}
            </select>
          </div>
          <div style="flex:1; min-width:160px;">
            <div class="muted" style="font-size:12px; margin-bottom:6px;">迄段</div>
            <select id="tpEnd" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(43,58,47,.95); background: rgba(21,27,22,.55); color: var(--ink);">
              ${opts.join("")}
            </select>
          </div>
        </div>
        <div class="muted" style="font-size:12px; margin-top:10px;">小撇步：建議先選 2～3 段一組，背起來比較不會煩。</div>
      </div>
    `, `
      <button class="btn" id="tpCancel">取消</button>
      <button class="btn primary" id="tpGo">開始測驗</button>
    `);

    setTimeout(() => {
      const s = document.getElementById("tpStart");
      const e = document.getElementById("tpEnd");
      const cancel = document.getElementById("tpCancel");
      const go = document.getElementById("tpGo");

      // 預設：最後 2 段
      const startDefault = Math.max(0, passed - 2);
      s.value = String(startDefault);
      e.value = String(passed - 1);

      function clampEnd(){
        const sv = Number(s.value);
        const ev = Number(e.value);
        if(ev < sv) e.value = String(sv);
      }
      s.onchange = clampEnd;
      e.onchange = clampEnd;

      cancel.onclick = () => modalClose.click();
      go.onclick = () => {
        const start = Number(s.value);
        const end = Number(e.value);
        modalClose.click();
        startTest({ start, end });
      };
    }, 0);
  }

  /***********************
   * GAME CORE
   ***********************/
  function setNpcOriginal(text){
    npcLine.textContent = text;
  }

  function renderBoard(){
    // slots
    slots.innerHTML = "";
    selection.forEach((t, idx) => {
      const b = document.createElement("div");
      b.className = "token slotToken";
      b.textContent = t;
      b.onclick = () => {
        // remove this and put back to pool
        const removed = selection.splice(idx,1)[0];
        pool.push(removed);
        renderPool();
        renderBoard();
      };
      slots.appendChild(b);
    });

    // pool
    renderPool();
  }

  function renderPool(){
    tokensEl.innerHTML = "";
    pool.forEach((t, idx) => {
      const b = document.createElement("div");
      b.className = "token";
      b.textContent = t;
      b.onclick = () => {
        selection.push(pool.splice(idx,1)[0]);
        renderPool();
        renderBoard();
        checkWinRouter();
        // ✅每次點選後，令牌板還是可繼續滑（避免卡住）
        tokensWrap.scrollTop = Math.min(tokensWrap.scrollTop, tokensWrap.scrollHeight);
      };
      tokensEl.appendChild(b);
    });
  }

  function restartCurrent(){
    const seg = currentSeg();
    selection = [];
    pool = shuffle(seg.tokens);
    renderBoard();

    // ✅回到頂部，避免「長段落卡在中段」造成誤以為不能操作
    tokensWrap.scrollTop = 0;
  }

  function startLearnSegment(i, { firstEntry=false } = {}){
    mode = "learn";
    currentSegIndex = i;

    // ✅提示狀態
    if(firstEntry){
      PROG.hintOn = !!PROG.hintDefault;
      saveProgress();
    }
    hintSwitch.checked = !!PROG.hintOn;

    // ✅段落進入：先把「下一關」設定好（避免你說的：測驗回來按不到）
    const ch = currentChapter();
    const p = getChapterProg(currentChapterId);
    const passed = Math.min(p.passed || 0, ch.segments.length);
    const thisPassed = (i < passed);

    btnNext.disabled = !thisPassed;        // 已過關就可直接下一關
    btnBook.disabled = false;              // 兵書永遠可看（你要白話）
    btnBook.classList.remove("pulseStrong");

    setView(viewGame);
    setNpcOriginal(currentSeg().quote);
    restartCurrent();

    updateFab();
    updateTopbar();

    // ✅進佈令時，fab 不干擾操作但可用
  }

  function checkLearnWin(){
    const seg = currentSeg();
    if(selection.length !== seg.tokens.length) return;
    const ok = selection.every((v,i)=> v===seg.tokens[i]);
    if(ok){
      beep("ok");
      onSegmentPassed();
      if(PROG.hintOn) flashHintTimes(1);
    }else{
      beep("bad");
    }
  }

  function onSegmentPassed(){
    // ✅段落內立刻可按下一關
    btnNext.disabled = false;

    btnBook.disabled = false;
    btnBook.classList.add("pulseStrong");

    const ch = currentChapter();
    const p = getChapterProg(currentChapterId);
    p.passed = Math.max(p.passed || 0, currentSegIndex + 1);
    saveProgress();

    // ✅同步更新進度顯示
    if(viewChapterHome.classList.contains("active")) openChapterHome();
    updateFab();
    renderOverview();
  }

  /***********************
   * TEST MODE
   * ✅修正點：測驗完回佈令，下一關可按（會回到你原本佈令的位置）
   ***********************/
  function startTest(range){
    const ch = currentChapter();
    const p = getChapterProg(currentChapterId);
    const passed = Math.min(p.passed || 0, ch.segments.length);

    // 防呆
    const start = Math.max(0, Math.min(range.start, passed-1));
    const end = Math.max(start, Math.min(range.end, passed-1));

    // ✅記住測驗前你在佈令哪一段
    learnReturnIndex = currentSegIndex;

    mode = "test";
    testRange = { start, end };
    testCursor = start;

    setView(viewGame);
    currentSegIndex = testCursor;
    setNpcOriginal(ch.segments[currentSegIndex].quote);

    // 測驗一律從重置開始
    btnNext.disabled = true;   // 測驗時禁用下一關，避免混亂
    btnBook.disabled = false;

    restartCurrent();
    updateFab();
    updateTopbar();
  }

  function checkTestWin(){
    const seg = currentSeg();
    if(selection.length !== seg.tokens.length) return;
    const ok = selection.every((v,i)=> v===seg.tokens[i]);

    if(ok){
      beep("ok");
      if(testCursor < testRange.end){
        testCursor++;
        currentSegIndex = testCursor;
        setNpcOriginal(currentChapter().segments[currentSegIndex].quote);
        restartCurrent();
        if(PROG.hintOn) flashHintTimes(1);
        updateTopbar();
      }else{
        openModal("測驗通過", `<div class="plain">完成範圍：第${testRange.start+1}段～第${testRange.end+1}段</div>`, `
          <button class="btn" id="btnBackToLearn">回到佈令</button>
          <button class="btn primary" id="btnBackHome">回到篇章首頁</button>
        `);
        setTimeout(() => {
          const a = document.getElementById("btnBackToLearn");
          const b = document.getElementById("btnBackHome");
          if(a) a.onclick = () => {
            modalClose.click();
            mode="learn";
            // ✅回到測驗前所在段落（而且會正確恢復下一關狀態）
            startLearnSegment(learnReturnIndex, { firstEntry:false });
          };
          if(b) b.onclick = () => { modalClose.click(); openChapterHome(); };
        }, 0);
      }
    }else{
      beep("bad");
      openModal("測驗未過", `
        <div class="plain">沒關係。你自己願意重來那一下，其實就比昨天更強了。</div>
      `, `
        <button class="btn" id="btnRetryTest">重來</button>
        <button class="btn primary" id="btnPauseLater">先放下</button>
      `);
      setTimeout(() => {
        const r = document.getElementById("btnRetryTest");
        const g = document.getElementById("btnPauseLater");
        if(r) r.onclick = () => { modalClose.click(); restartCurrent(); if(PROG.hintOn) flashHintTimes(1); };
        if(g) g.onclick = () => { modalClose.click(); openChapterHome(); };
      }, 0);
    }
  }

  function checkWinRouter(){
    if(mode==="learn") checkLearnWin();
    else checkTestWin();
  }

  /***********************
   * HINT FLASH
   ***********************/
  let flashTimer = null;
  function flashHintTimes(times=1){
    clearTimeout(flashTimer);
    let count = 0;

    const seg = currentSeg();
    const nextIndex = selection.length;
    if(nextIndex >= seg.tokens.length) return;

    const nextToken = seg.tokens[nextIndex];

    const doFlash = () => {
      const nodes = [...tokensEl.querySelectorAll(".token")];
      const target = nodes.find(n => n.textContent === nextToken);
      if(!target) return;

      target.style.boxShadow = "var(--glowStrong)";
      target.style.borderColor = "rgba(214,178,94,.85)";
      flashTimer = setTimeout(() => {
        target.style.boxShadow = "";
        target.style.borderColor = "";
        count++;
        if(count < times) setTimeout(doFlash, 260);
      }, 520);
    };
    doFlash();
  }

  /***********************
   * TTS & SOUND
   ***********************/
  let utter = null;
  function speak(text){
    if(!PROG.ttsOn) return;
    try{
      window.speechSynthesis.cancel();
      utter = new SpeechSynthesisUtterance(text);
      utter.lang = "zh-TW";
      utter.rate = 0.95;
      utter.pitch = 1.0;
      window.speechSynthesis.speak(utter);
    }catch(e){}
  }
  function stopSpeak(){
    try{ window.speechSynthesis.cancel(); }catch(e){}
  }

  const AC = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
  function beep(type="ok"){
    if(!PROG.soundOn) return;
    if(!AC) return;
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.connect(g); g.connect(AC.destination);
    const now = AC.currentTime;
    o.type = "sine";
    o.frequency.value = (type==="ok") ? 740 : 210;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.16);
    o.start(now);
    o.stop(now+0.18);
  }

  /***********************
   * BOOK (原文 + 白話)
   ***********************/
  btnBook.onclick = () => {
    const seg = currentSeg();
    openModal("兵書", `
      <div class="quote">${escapeHtml(seg.quote)}</div>
      <div class="plain"><strong>白話：</strong>${escapeHtml(seg.plain || "（尚未補上白話）")}</div>
    `);
  };

  /***********************
   * MODAL
   ***********************/
  function openModal(title, html, actionsHtml=null){
    modalTitle.textContent = title;
    modalBody.innerHTML = html;

    if(actionsHtml){
      modalActions.style.display = "flex";
      modalActions.innerHTML = actionsHtml;
    }else{
      modalActions.style.display = "none";
      modalActions.innerHTML = "";
    }
    modal.classList.add("show");
  }
  modalClose.onclick = () => {
    modal.classList.remove("show");
    modalActions.style.display = "none";
    modalActions.innerHTML = "";
  };
  modal.onclick = (e) => { if(e.target === modal) modalClose.click(); };

  /***********************
   * BUTTONS
   ***********************/
  btnOverview.onclick = () => {
    setView(viewOverview);
    renderOverview();
    updateFab();
    updateTopbar();
  };

  btnBackOrSettings.onclick = () => {
    if(viewOverview.classList.contains("active")){
      setView(viewSettings);
    }else if(viewSettings.classList.contains("active")){
      setView(viewOverview);
    }else if(viewChapterHome.classList.contains("active")){
      setView(viewOverview);
    }else if(viewGame.classList.contains("active")){
      // game -> chapter home
      openChapterHome();
      return;
    }
    updateFab();
    updateTopbar();
  };

  btnStart.onclick = () => {
    const p = getChapterProg(currentChapterId);
    const startIndex = Math.min(p.passed || 0, currentChapter().segments.length-1);
    startLearnSegment(startIndex, { firstEntry:true });
  };

  btnFromStart.onclick = () => {
    const p = getChapterProg(currentChapterId);
    p.passed = 0;
    saveProgress();
    renderOverview();
    openChapterHome();
  };

  btnSegRead.onclick = () => speak(currentSeg().quote);
  btnReset.onclick = () => {
    restartCurrent();
    if(PROG.hintOn) flashHintTimes(1);
  };

  btnNext.onclick = () => {
    if(btnNext.disabled) return;
    if(mode==="test") return; // 測驗不走下一關

    const ch = currentChapter();
    if(currentSegIndex < ch.segments.length - 1){
      currentSegIndex += 1;
      startLearnSegment(currentSegIndex, { firstEntry:false });
    }else{
      openModal("本篇完成", `<div class="plain">你已完成：${escapeHtml(ch.name)}。</div>`, `
        <button class="btn" id="btnBackHome2">回到篇章首頁</button>
        <button class="btn primary" id="btnBackOverview2">回到總覽</button>
      `);
      setTimeout(() => {
        const a = document.getElementById("btnBackHome2");
        const b = document.getElementById("btnBackOverview2");
        if(a) a.onclick = () => { modalClose.click(); openChapterHome(); };
        if(b) b.onclick = () => { modalClose.click(); btnOverview.click(); };
      }, 0);
    }
  };

  hintSwitch.onchange = () => {
    PROG.hintOn = !!hintSwitch.checked;
    saveProgress();
    if(PROG.hintOn) flashHintTimes(1);
  };

  fabTest.onclick = () => openTestPicker();

  /***********************
   * HOME: READ
   ***********************/
  btnHomeRead.onclick = () => {
    const ch = currentChapter();
    const text = ch.segments.map(s => s.quote).join("。 ");
    speak(text);
  };
  btnHomeStop.onclick = () => stopSpeak();

  /***********************
   * SETTINGS
   ***********************/
  function syncSettingsUI(){
    fontScale.value = String(PROG.fontScale);
    soundOn.checked = !!PROG.soundOn;
    ttsOn.checked = !!PROG.ttsOn;
    hintDefault.checked = !!PROG.hintDefault;
  }

  fontScale.oninput = () => {
    PROG.fontScale = Number(fontScale.value);
    document.body.style.setProperty("--fontScale", String(PROG.fontScale));
    saveProgress();
  };
  soundOn.onchange = () => { PROG.soundOn = !!soundOn.checked; saveProgress(); };
  ttsOn.onchange = () => { PROG.ttsOn = !!ttsOn.checked; saveProgress(); };
  hintDefault.onchange = () => { PROG.hintDefault = !!hintDefault.checked; saveProgress(); };

  btnClear.onclick = () => {
    openModal("清空確認", `
      <div class="plain">會清空：進度、設定、測驗範圍。確定要歸零嗎？</div>
    `, `
      <button class="btn" id="btnCancelClear">取消</button>
      <button class="btn primary" id="btnConfirmClear">確定清空</button>
    `);
    setTimeout(() => {
      const c = document.getElementById("btnCancelClear");
      const y = document.getElementById("btnConfirmClear");
      if(c) c.onclick = () => modalClose.click();
      if(y) y.onclick = () => {
        localStorage.removeItem(LS_KEY);
        PROG = loadProgress();
        document.body.style.setProperty("--fontScale", String(PROG.fontScale));
        modalClose.click();
        syncSettingsUI();
        renderOverview();
        setView(viewOverview);
        updateFab();
        updateTopbar();
      };
    }, 0);
  };

  /***********************
   * INIT
   ***********************/
  function init(){
    syncSettingsUI();
    renderOverview();
    setView(viewOverview);
    updateFab();
    updateTopbar();
  }
  init();

})();
</script>
</body>
</html>
